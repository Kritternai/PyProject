name: ğŸ¯ Smart Learning Hub - Main Orchestrator

on:
  push:
    branches: [ main, dev/web ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

env:
  PYTHON_VERSION: '3.11'
  FLASK_ENV: 'testing'

jobs:
  # ============================================
  # ORCHESTRATOR JOB
  # ============================================
  orchestrate:
    name: ğŸ¯ CI/CD Orchestrator
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸš€ Pipeline Initiation
      run: |
        echo "ğŸ¯ Smart Learning Hub CI/CD Pipeline"
        echo "====================================="
        echo "ğŸ“… Date: $(date)"
        echo "ğŸ”— Branch: ${{ github.ref_name }}"
        echo "ğŸ“ Commit: ${{ github.sha }}"
        echo "ğŸ‘¤ Author: ${{ github.actor }}"
        echo "ğŸ­ Event: ${{ github.event_name }}"
        echo "====================================="
        
    - name: ğŸ“Š Pipeline Status
      run: |
        echo "ğŸ“Š Pipeline Components:"
        echo "  ğŸ” Code Quality & Security"
        echo "  ğŸ§ª Testing & Coverage"
        echo "  ğŸ”¨ Build Validation (PR only)"
        echo "  ğŸš€ Deployment (main branch only)"
        echo "====================================="
        
  # ============================================
  # WORKFLOW CALLS
  # ============================================
  
  code-quality:
    name: ğŸ” Code Quality & Security
    uses: ./.github/workflows/code-quality.yml
    secrets: inherit
    
  testing:
    name: ğŸ§ª Testing & Coverage
    uses: ./.github/workflows/testing.yml
    needs: code-quality
    secrets: inherit
    
  build-validation:
    name: ğŸ”¨ Build Validation
    uses: ./.github/workflows/build-validation.yml
    needs: [code-quality, testing]
    if: github.event_name == 'pull_request'
    secrets: inherit
    
  deployment:
    name: ğŸš€ Deployment
    uses: ./.github/workflows/deployment.yml
    needs: [code-quality, testing]
    if: github.ref == 'refs/heads/main'
    secrets: inherit
    
  # ============================================
  # FINAL SUMMARY
  # ============================================
  summary:
    name: ğŸ“Š Pipeline Summary
    runs-on: ubuntu-latest
    needs: [orchestrate, code-quality, testing, build-validation, deployment]
    if: always()
    
    steps:
    - name: ğŸ“Š Generate Pipeline Summary
      run: |
        echo "ğŸ“Š Smart Learning Hub CI/CD Pipeline Summary"
        echo "============================================="
        echo ""
        echo "ğŸ” Code Quality: ${{ needs.code-quality.result }}"
        echo "ğŸ§ª Testing: ${{ needs.testing.result }}"
        echo "ğŸ”¨ Build Validation: ${{ needs.build-validation.result }}"
        echo "ğŸš€ Deployment: ${{ needs.deployment.result }}"
        echo ""
        
        if [ "${{ needs.code-quality.result }}" = "success" ] && [ "${{ needs.testing.result }}" = "success" ]; then
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            if [ "${{ needs.build-validation.result }}" = "success" ]; then
              echo "âœ… PR Ready for Review - All checks passed!"
            else
              echo "âŒ PR Build Validation Failed"
              exit 1
            fi
          else
            if [ "${{ github.ref }}" = "refs/heads/main" ]; then
              if [ "${{ needs.deployment.result }}" = "success" ]; then
                echo "ğŸ‰ Production Deployment Successful!"
                echo "ğŸŒ URL: ${{ secrets.RENDER_SERVICE_URL }}"
              else
                echo "âŒ Production Deployment Failed"
                exit 1
              fi
            else
              echo "âœ… Development Branch - Quality checks passed!"
            fi
          fi
        else
          echo "âŒ Pipeline Failed - Quality or Testing issues"
          exit 1
        fi
        
        echo "============================================="
        echo "ğŸ¯ Pipeline completed at: $(date)"
        echo "============================================="
