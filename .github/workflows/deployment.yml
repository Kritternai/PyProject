name: ğŸš€ Deployment & Health Check

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

jobs:
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    environment: production
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸš€ Deploy to Render
      uses: johnbeynon/render-deploy-action@v0.0.8
      with:
        service-id: ${{ secrets.RENDER_SERVICE_ID }}
        api-key: ${{ secrets.RENDER_API_KEY }}
        
    - name: ğŸ¥ Post-deployment health check
      run: |
        echo "ğŸ¥ Running comprehensive health checks..."
        
        DEPLOYMENT_URL="${{ secrets.RENDER_SERVICE_URL }}"
        
        if [ -z "$DEPLOYMENT_URL" ]; then
          echo "âš ï¸ RENDER_SERVICE_URL not set - skipping health check"
          exit 0
        fi
        
        echo "ğŸŒ Testing deployment at: $DEPLOYMENT_URL"
        
        # Wait for service to be ready (up to 5 minutes)
        for i in {1..10}; do
          echo "â³ Health check attempt $i/10..."
          
          if curl -f -s -o /dev/null "$DEPLOYMENT_URL"; then
            echo "âœ… Health check passed - service is responding"
            
            # Test specific endpoints
            echo "ğŸ” Testing specific endpoints..."
            
            # Test main page
            if curl -f -s "$DEPLOYMENT_URL" > /dev/null; then
              echo "âœ… Main page accessible"
            fi
            
            # Test API health (if available)
            if curl -f -s "$DEPLOYMENT_URL/api/health" > /dev/null; then
              echo "âœ… API health endpoint accessible"
            fi
            
            echo "ğŸ‰ Deployment successful and service is healthy!"
            exit 0
          else
            echo "â³ Service not ready yet... waiting 30 seconds"
            sleep 30
          fi
        done
        
        echo "âŒ Health check failed - service did not respond within timeout"
        exit 1
        
    - name: ğŸ“Š Deployment Summary
      run: |
        echo "ğŸ“Š Deployment Summary"
        echo "==================="
        echo "âœ… Status: Successfully deployed"
        echo "ğŸŒ URL: ${{ secrets.RENDER_SERVICE_URL }}"
        echo "ğŸ• Time: $(date)"
        echo "ğŸ”— Commit: ${{ github.sha }}"
        echo "ğŸ‘¤ Author: ${{ github.actor }}"
        echo "==================="
