name: ğŸ¯ Smart Learning Hub - Unified CI/CD Pipeline

on:
  push:
    branches: [ main, dev/web ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

env:
  PYTHON_VERSION: '3.11'
  FLASK_ENV: 'testing'

jobs:
  # ============================================
  # PIPELINE INITIATION
  # ============================================
  pipeline-init:
    name: ğŸš€ Pipeline Initiation
    runs-on: ubuntu-latest
    outputs:
      pipeline-id: ${{ steps.init.outputs.pipeline-id }}
      branch: ${{ steps.init.outputs.branch }}
      event: ${{ steps.init.outputs.event }}
    
    steps:
    - name: ğŸ¯ Initialize Pipeline
      id: init
      run: |
        echo "ğŸ¯ Smart Learning Hub - Unified CI/CD Pipeline"
        echo "=============================================="
        echo "ğŸ“… Date: $(date)"
        echo "ğŸ”— Branch: ${{ github.ref_name }}"
        echo "ğŸ“ Commit: ${{ github.sha }}"
        echo "ğŸ‘¤ Author: ${{ github.actor }}"
        echo "ğŸ­ Event: ${{ github.event_name }}"
        echo "ğŸ†” Pipeline ID: ${{ github.run_id }}"
        echo "=============================================="
        
        echo "pipeline-id=${{ github.run_id }}" >> $GITHUB_OUTPUT
        echo "branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
        echo "event=${{ github.event_name }}" >> $GITHUB_OUTPUT
        
    - name: ğŸ“Š Pipeline Overview
      run: |
        echo "ğŸ“Š Unified CI/CD Pipeline Components:"
        echo "  ğŸ” Code Quality & Security Analysis"
        echo "  ğŸ§ª Testing & Coverage Analysis"
        echo "  ğŸ”¨ Build Validation & Compatibility"
        echo "  ğŸš€ Deployment & Health Monitoring"
        echo "  ğŸ“ˆ Performance & Metrics Collection"
        echo "=============================================="

  # ============================================
  # CODE QUALITY & SECURITY
  # ============================================
  code-quality:
    name: ğŸ” Code Quality & Security
    runs-on: ubuntu-latest
    needs: pipeline-init
    outputs:
      quality-status: ${{ steps.quality-check.outputs.status }}
      security-status: ${{ steps.security-check.outputs.status }}
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python Environment
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Cache Dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-quality-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-quality-
          
    - name: ğŸ“¥ Install Quality Tools
      run: |
        python -m pip install --upgrade pip
        pip install black isort flake8 bandit safety
        
    - name: ğŸ¨ Code Formatting Analysis
      id: format-check
      run: |
        echo "ğŸ¨ Running code formatting analysis..."
        if black --check --diff app/ tests/; then
          echo "âœ… Code formatting is perfect"
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "âŒ Code formatting issues detected"
          echo "ğŸ’¡ Run 'black app/ tests/' to fix"
          echo "status=warning" >> $GITHUB_OUTPUT
        fi
        
    - name: ğŸ“¦ Import Organization Analysis
      id: import-check
      run: |
        echo "ğŸ“¦ Running import organization analysis..."
        if isort --check-only --diff app/ tests/; then
          echo "âœ… Import organization is perfect"
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "âŒ Import organization issues detected"
          echo "ğŸ’¡ Run 'isort app/ tests/' to fix"
          echo "status=warning" >> $GITHUB_OUTPUT
        fi
        
    - name: ğŸ” Code Linting Analysis
      id: lint-check
      run: |
        echo "ğŸ” Running comprehensive linting analysis..."
        flake8 app/ tests/ --count --select=E9,F63,F7,F82 --show-source --statistics || {
          echo "âŒ Critical linting issues found"
          exit 1
        }
        flake8 app/ tests/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        echo "âœ… Linting analysis completed"
        
    - name: ğŸ”’ Security Vulnerability Analysis
      id: security-check
      run: |
        echo "ğŸ”’ Running security vulnerability analysis..."
        bandit -r app/ -f txt -o bandit-report.txt || {
          echo "âš ï¸ Security vulnerabilities detected - check bandit-report.txt"
          echo "status=warning" >> $GITHUB_OUTPUT
        }
        safety check || {
          echo "âš ï¸ Dependency vulnerabilities detected"
          echo "status=warning" >> $GITHUB_OUTPUT
        }
        echo "status=success" >> $GITHUB_OUTPUT
        
    - name: âœ… Quality Status Summary
      id: quality-check
      run: |
        echo "âœ… Code Quality & Security Analysis Complete"
        echo "status=success" >> $GITHUB_OUTPUT
        
    - name: ğŸ“Š Upload Quality Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: quality-reports-${{ needs.pipeline-init.outputs.pipeline-id }}
        path: |
          bandit-report.txt
          safety-report.txt

  # ============================================
  # TESTING & COVERAGE
  # ============================================
  testing-coverage:
    name: ğŸ§ª Testing & Coverage Analysis
    runs-on: ubuntu-latest
    needs: [pipeline-init, code-quality]
    outputs:
      test-status: ${{ steps.test-summary.outputs.status }}
      coverage-percentage: ${{ steps.coverage-analysis.outputs.coverage }}
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python Environment
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Cache Dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-testing-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-testing-
          
    - name: ğŸ“¥ Install Testing Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov
        
    - name: ğŸ—„ï¸ Setup Test Environment
      run: |
        export FLASK_ENV=testing
        export DATABASE_URL=sqlite:///test.db
        export FLASK_SECRET_KEY=test_secret_key_for_ci
        
    - name: ğŸ—ï¸ Initialize Test Database
      run: |
        echo "ğŸ—ï¸ Setting up test database..."
        python database/setup_database.py
        echo "âœ… Test database ready"
        
    - name: ğŸ§ª Execute Test Suite
      id: test-execution
      run: |
        echo "ğŸ§ª Running comprehensive test suite..."
        pytest tests/ \
          --cov=app \
          --cov-report=xml \
          --cov-report=html \
          --cov-report=term-missing \
          --cov-fail-under=60 \
          --junitxml=pytest-report.xml \
          --verbose || {
          echo "âŒ Tests failed or coverage below threshold"
          exit 1
        }
        echo "âœ… All tests passed with sufficient coverage"
        
    - name: ğŸ“Š Coverage Analysis
      id: coverage-analysis
      run: |
        echo "ğŸ“Š Analyzing test coverage..."
        COVERAGE=$(grep -o 'TOTAL.*[0-9]*%' htmlcov/index.html | grep -o '[0-9]*%' | head -1)
        echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
        echo "ğŸ“ˆ Coverage Achieved: $COVERAGE"
        
    - name: âœ… Test Status Summary
      id: test-summary
      run: |
        echo "âœ… Testing & Coverage Analysis Complete"
        echo "status=success" >> $GITHUB_OUTPUT
        
    - name: ğŸ“Š Upload Test Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-reports-${{ needs.pipeline-init.outputs.pipeline-id }}
        path: |
          coverage.xml
          htmlcov/
          pytest-report.xml

  # ============================================
  # BUILD VALIDATION
  # ============================================
  build-validation:
    name: ğŸ”¨ Build Validation & Compatibility
    runs-on: ubuntu-latest
    needs: [pipeline-init, code-quality, testing-coverage]
    if: github.event_name == 'pull_request'
    outputs:
      build-status: ${{ steps.build-summary.outputs.status }}
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python Environment
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ” Validate Deployment Files
      run: |
        echo "ğŸ” Validating deployment configuration..."
        REQUIRED_FILES=("Procfile" "render.yaml" "requirements.txt" "start.py" "build.sh")
        
        for file in "${REQUIRED_FILES[@]}"; do
          if [ ! -f "$file" ]; then
            echo "âŒ Required deployment file missing: $file"
            exit 1
          else
            echo "âœ… Found: $file"
          fi
        done
        echo "âœ… All deployment files validated"
        
    - name: ğŸ—ï¸ Test Application Build
      run: |
        echo "ğŸ—ï¸ Testing application build process..."
        export FLASK_ENV=production
        export DATABASE_URL=sqlite:///site.db
        export FLASK_SECRET_KEY=build_test_secret_key
        
        python database/setup_database.py
        echo "âœ… Database setup completed"
        
    - name: ğŸš€ Test Application Startup
      run: |
        echo "ğŸš€ Testing application startup process..."
        timeout 30s python start.py &
        APP_PID=$!
        
        sleep 10
        
        if curl -f -s http://localhost:8000/ > /dev/null; then
          echo "âœ… Application startup test passed"
          kill $APP_PID 2>/dev/null || true
        else
          echo "âŒ Application startup test failed"
          kill $APP_PID 2>/dev/null || true
          exit 1
        fi
        
    - name: âœ… Build Validation Summary
      id: build-summary
      run: |
        echo "âœ… Build Validation & Compatibility Complete"
        echo "status=success" >> $GITHUB_OUTPUT

  # ============================================
  # DEPLOYMENT & HEALTH MONITORING
  # ============================================
  deployment:
    name: ğŸš€ Deployment & Health Monitoring
    runs-on: ubuntu-latest
    needs: [pipeline-init, code-quality, testing-coverage]
    if: github.ref == 'refs/heads/main'
    environment: production
    outputs:
      deployment-status: ${{ steps.deploy-summary.outputs.status }}
      health-status: ${{ steps.health-check.outputs.status }}
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸš€ Deploy to Render
      uses: johnbeynon/render-deploy-action@v0.0.8
      with:
        service-id: ${{ secrets.RENDER_SERVICE_ID }}
        api-key: ${{ secrets.RENDER_API_KEY }}
        
    - name: ğŸ¥ Comprehensive Health Monitoring
      id: health-check
      run: |
        echo "ğŸ¥ Running comprehensive health monitoring..."
        
        DEPLOYMENT_URL="${{ secrets.RENDER_SERVICE_URL }}"
        
        if [ -z "$DEPLOYMENT_URL" ]; then
          echo "âš ï¸ RENDER_SERVICE_URL not set - skipping health check"
          echo "status=skipped" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        echo "ğŸŒ Monitoring deployment at: $DEPLOYMENT_URL"
        
        for i in {1..10}; do
          echo "â³ Health check attempt $i/10..."
          
          if curl -f -s -o /dev/null "$DEPLOYMENT_URL"; then
            echo "âœ… Primary health check passed"
            
            # Test specific endpoints
            echo "ğŸ” Testing specific endpoints..."
            
            if curl -f -s "$DEPLOYMENT_URL" > /dev/null; then
              echo "âœ… Main page accessible"
            fi
            
            if curl -f -s "$DEPLOYMENT_URL/api/health" > /dev/null; then
              echo "âœ… API health endpoint accessible"
            fi
            
            echo "ğŸ‰ Deployment healthy and fully operational!"
            echo "status=success" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "â³ Service not ready... waiting 30 seconds"
            sleep 30
          fi
        done
        
        echo "âŒ Health check failed - service did not respond within timeout"
        echo "status=failed" >> $GITHUB_OUTPUT
        exit 1
        
    - name: âœ… Deployment Summary
      id: deploy-summary
      run: |
        echo "âœ… Deployment & Health Monitoring Complete"
        echo "status=success" >> $GITHUB_OUTPUT

  # ============================================
  # PERFORMANCE & METRICS COLLECTION
  # ============================================
  performance-metrics:
    name: ğŸ“ˆ Performance & Metrics Collection
    runs-on: ubuntu-latest
    needs: [pipeline-init, code-quality, testing-coverage]
    if: always()
    outputs:
      performance-status: ${{ steps.perf-summary.outputs.status }}
    
    steps:
    - name: ğŸ“Š Collect Pipeline Metrics
      id: metrics-collection
      run: |
        echo "ğŸ“Š Collecting comprehensive pipeline metrics..."
        
        # Calculate pipeline duration
        START_TIME="${{ needs.pipeline-init.outputs.pipeline-id }}"
        CURRENT_TIME=$(date +%s)
        
        echo "ğŸ“ˆ Pipeline Metrics:"
        echo "  ğŸ†” Pipeline ID: ${{ needs.pipeline-init.outputs.pipeline-id }}"
        echo "  ğŸ”— Branch: ${{ needs.pipeline-init.outputs.branch }}"
        echo "  ğŸ­ Event: ${{ needs.pipeline-init.outputs.event }}"
        echo "  ğŸ“ Commit: ${{ github.sha }}"
        echo "  ğŸ‘¤ Author: ${{ github.actor }}"
        echo "  ğŸ§ª Test Coverage: ${{ needs.testing-coverage.outputs.coverage-percentage }}"
        echo "  ğŸ” Quality Status: ${{ needs.code-quality.outputs.quality-status }}"
        echo "  ğŸ”’ Security Status: ${{ needs.code-quality.outputs.security-status }}"
        echo "  ğŸš€ Deployment Status: ${{ needs.deployment.outputs.deployment-status }}"
        echo "  ğŸ¥ Health Status: ${{ needs.deployment.outputs.health-status }}"
        
    - name: ğŸ“Š Generate Performance Report
      run: |
        echo "ğŸ“Š Performance & Metrics Collection Complete"
        
    - name: âœ… Performance Summary
      id: perf-summary
      run: |
        echo "âœ… Performance & Metrics Collection Complete"
        echo "status=success" >> $GITHUB_OUTPUT

  # ============================================
  # UNIFIED PIPELINE SUMMARY
  # ============================================
  pipeline-summary:
    name: ğŸ“Š Unified Pipeline Summary
    runs-on: ubuntu-latest
    needs: [pipeline-init, code-quality, testing-coverage, build-validation, deployment, performance-metrics]
    if: always()
    
    steps:
    - name: ğŸ¯ Generate Unified Pipeline Summary
      run: |
        echo "ğŸ¯ Smart Learning Hub - Unified CI/CD Pipeline Summary"
        echo "====================================================="
        echo ""
        echo "ğŸ“Š Pipeline Execution Results:"
        echo "  ğŸ†” Pipeline ID: ${{ needs.pipeline-init.outputs.pipeline-id }}"
        echo "  ğŸ”— Branch: ${{ needs.pipeline-init.outputs.branch }}"
        echo "  ğŸ­ Event: ${{ needs.pipeline-init.outputs.event }}"
        echo ""
        echo "ğŸ” Code Quality & Security: ${{ needs.code-quality.result }}"
        echo "ğŸ§ª Testing & Coverage: ${{ needs.testing-coverage.result }}"
        echo "ğŸ”¨ Build Validation: ${{ needs.build-validation.result }}"
        echo "ğŸš€ Deployment: ${{ needs.deployment.result }}"
        echo "ğŸ“ˆ Performance Metrics: ${{ needs.performance-metrics.result }}"
        echo ""
        echo "ğŸ“ˆ Detailed Metrics:"
        echo "  ğŸ§ª Test Coverage: ${{ needs.testing-coverage.outputs.coverage-percentage }}"
        echo "  ğŸ” Quality Status: ${{ needs.code-quality.outputs.quality-status }}"
        echo "  ğŸ”’ Security Status: ${{ needs.code-quality.outputs.security-status }}"
        echo "  ğŸš€ Deployment Status: ${{ needs.deployment.outputs.deployment-status }}"
        echo "  ğŸ¥ Health Status: ${{ needs.deployment.outputs.health-status }}"
        echo ""
        
        # Determine overall pipeline status
        if [ "${{ needs.code-quality.result }}" = "success" ] && [ "${{ needs.testing-coverage.result }}" = "success" ]; then
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            if [ "${{ needs.build-validation.result }}" = "success" ]; then
              echo "âœ… PR Ready for Review - All validation checks passed!"
              echo "ğŸ‰ Unified CI/CD Pipeline: SUCCESS"
            else
              echo "âŒ PR Build Validation Failed"
              echo "ğŸ¯ Unified CI/CD Pipeline: FAILED"
              exit 1
            fi
          else
            if [ "${{ github.ref }}" = "refs/heads/main" ]; then
              if [ "${{ needs.deployment.result }}" = "success" ]; then
                echo "ğŸ‰ Production Deployment Successful!"
                echo "ğŸŒ Application URL: ${{ secrets.RENDER_SERVICE_URL }}"
                echo "ğŸ¯ Unified CI/CD Pipeline: SUCCESS"
              else
                echo "âŒ Production Deployment Failed"
                echo "ğŸ¯ Unified CI/CD Pipeline: FAILED"
                exit 1
              fi
            else
              echo "âœ… Development Branch - Quality checks passed!"
              echo "ğŸ¯ Unified CI/CD Pipeline: SUCCESS"
            fi
          fi
        else
          echo "âŒ Pipeline Failed - Quality or Testing issues detected"
          echo "ğŸ¯ Unified CI/CD Pipeline: FAILED"
          exit 1
        fi
        
        echo ""
        echo "====================================================="
        echo "ğŸ¯ Unified CI/CD Pipeline completed at: $(date)"
        echo "====================================================="
