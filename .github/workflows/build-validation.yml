name: ðŸ”¨ Build Validation

on:
  pull_request:
    branches: [ main ]
  workflow_call:
    needs: [code-quality, testing]

jobs:
  build-check:
    name: ðŸ”¨ Build Validation & Compatibility
    runs-on: ubuntu-latest
    needs: [code-quality, testing]
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ðŸ” Validate required files
      run: |
        echo "ðŸ” Validating deployment files..."
        
        REQUIRED_FILES=("Procfile" "render.yaml" "requirements.txt" "start.py" "build.sh")
        
        for file in "${REQUIRED_FILES[@]}"; do
          if [ ! -f "$file" ]; then
            echo "âŒ Required file missing: $file"
            exit 1
          else
            echo "âœ… Found: $file"
          fi
        done
        
        echo "âœ… All required deployment files present"
        
    - name: ðŸ—ï¸ Test application build
      run: |
        echo "ðŸ—ï¸ Testing application build process..."
        
        # Set production environment
        export FLASK_ENV=production
        export DATABASE_URL=sqlite:///site.db
        export FLASK_SECRET_KEY=build_test_secret_key
        
        # Setup database
        python database/setup_database.py
        
        echo "âœ… Database setup completed"
        
    - name: ðŸš€ Test application startup
      run: |
        echo "ðŸš€ Testing application startup..."
        
        # Start application in background
        timeout 30s python start.py &
        APP_PID=$!
        
        # Wait for startup
        sleep 10
        
        # Test health endpoint
        if curl -f -s http://localhost:8000/ > /dev/null; then
          echo "âœ… Application startup test passed"
          kill $APP_PID 2>/dev/null || true
        else
          echo "âŒ Application startup test failed"
          kill $APP_PID 2>/dev/null || true
          exit 1
        fi
        
    - name: âœ… Build validation complete
      run: |
        echo "âœ… Build validation completed successfully!"
        echo "ðŸš€ Application is ready for deployment"
