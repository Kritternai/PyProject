<div class="px-4 container-fluid" id="class-list-container">
    <div class="">
      <h1 class="">All Lessons</h1>
    </div>
    
    <!-- Toolbar: Search & Add -->
    <div class="mb-3 d-flex justify-content-between align-items-center page-toolbar">
        <div class="flex-grow-1 me-3" style="max-width: 640px;">
            <div class="input-group search-bar">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input id="lessonSearch" type="text" class="form-control" placeholder="Search lessons...">
            </div>
        </div>
        <a href="#" class="text-decoration-none add-link" data-bs-toggle="modal" data-bs-target="#addLessonModal">
            <i class="bi bi-plus-circle me-1"></i>Add new lesson
        </a>
    </div>
    
    <!-- Status Chips -->
    <div class="mb-3 d-flex justify-content-between align-items-center">
        <div class="gap-2 d-flex chip-group">
            <button type="button" class="btn btn-light chip active" data-filter="">All</button>
            <button type="button" class="btn btn-light chip" data-filter="active">Active</button>
            <button type="button" class="btn btn-light chip" data-filter="completed">Completed</button>
            <button type="button" class="btn btn-light chip" data-filter="archived">Archived</button>
        </div>
        <div></div>
    </div>
    
    <!-- Calculate Statistics -->
    {% set stats = namespace(total=0, active=0, completed=0, archived=0, favorites=0) %}
    {% if lessons %}
      {% set stats.total = lessons|length %}
      {% for lesson in lessons %}
        {% if lesson.status == 'active' %}{% set stats.active = stats.active + 1 %}{% endif %}
        {% if lesson.status == 'completed' %}{% set stats.completed = stats.completed + 1 %}{% endif %}
        {% if lesson.status == 'archived' %}{% set stats.archived = stats.archived + 1 %}{% endif %}
        {% if lesson.is_favorite %}{% set stats.favorites = stats.favorites + 1 %}{% endif %}
      {% endfor %}
    {% endif %}
    
    <!-- Stats Cards -->
    <div class="mb-3 row g-3 stats-row">
      <div class="col-12 col-sm-6 col-lg-3">
        <div class="stat-card d-flex align-items-center justify-content-between">
          <div class="d-flex align-items-center">
            <div class="text-white stat-icon bg-brand me-2"><i class="bi bi-journal-bookmark"></i></div>
            <div class="small text-muted">Total Lessons</div>
          </div>
          <div class="m-0 display-6 fw-semibold">{{ stats.total }}</div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-3">
        <div class="stat-card d-flex align-items-center justify-content-between">
          <div class="d-flex align-items-center">
            <div class="stat-icon bg-success-subtle text-success me-2"><i class="bi bi-check2-circle"></i></div>
            <div class="small text-muted">Completed</div>
          </div>
          <div class="m-0 display-6 fw-semibold">{{ stats.completed }}</div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-3">
        <div class="stat-card d-flex align-items-center justify-content-between">
          <div class="d-flex align-items-center">
            <div class="stat-icon bg-primary-subtle text-primary me-2"><i class="bi bi-play-circle"></i></div>
            <div class="small text-muted">Active</div>
          </div>
          <div class="m-0 display-6 fw-semibold">{{ stats.active }}</div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-3">
        <div class="stat-card d-flex align-items-center justify-content-between">
          <div class="d-flex align-items-center">
            <div class="stat-icon bg-warning-subtle text-warning me-2"><i class="bi bi-star-fill"></i></div>
            <div class="small text-muted">Favorites</div>
          </div>
          <div class="m-0 display-6 fw-semibold">{{ stats.favorites }}</div>
        </div>
      </div>
    </div>
    
    <!-- Integration Connection Cards -->
    <div class="row mb-4">
      <!-- Google Classroom Connection -->
      {% if not google_classroom_connected %}
      <div class="col-lg-6 col-12 mb-3">
        <div class="card border-primary h-100">
          <div class="card-body text-center">
            <i class="fab fa-google text-primary fa-3x mb-3"></i>
            <h5 class="text-primary">Connect to Google Classroom</h5>
            <p class="text-muted small">Import your Google Classroom courses as lessons.</p>
            <a href="{{ url_for('google_classroom.authorize') }}" class="btn btn-primary btn-sm">
              <i class="fas fa-plug me-1"></i>Connect
            </a>
          </div>
        </div>
      </div>
      {% endif %}
      
      <!-- Microsoft Teams Connection -->
      {% if not microsoft_teams_connected %}
      <div class="col-lg-6 col-12 mb-3">
        <div class="card border-info h-100">
          <div class="card-body text-center">
            <i class="fab fa-microsoft text-info fa-3x mb-3"></i>
            <h5 class="text-info">Connect to Microsoft Teams</h5>
            <p class="text-muted small">Import your Teams channels and assignments. (Mockup)</p>
            <a href="{{ url_for('microsoft_teams.authorize') }}" class="btn btn-info btn-sm">
              <i class="fas fa-plug me-1"></i>Connect
            </a>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
    
    <!-- Microsoft Teams Status (if connected) -->
    {% if microsoft_teams_connected %}
    {% include 'microsoft_teams_status.html' %}
    {% endif %}
    
    <!-- Lessons Grid -->
    <div class="row" id="lessons-grid">
        {% if lessons %}
            {% for lesson in lessons %}
                <div class="mb-4 col-md-6 col-lg-4 lesson-item" data-status="{{ lesson.status or 'active' }}">
                    <div class="card h-100 neo-card" style="cursor:pointer;" onclick="if(typeof loadPage === 'function') { loadPage('class/{{ lesson.id }}'); } else { window.location.href='/class/{{ lesson.id }}'; }">
                        <!-- Cover Image -->
                        <div class="lesson-cover-wrapper">
                            {% if lesson.cover_image %}
                                <img src="{{ url_for('static', filename=lesson.cover_image) }}" class="card-img-top" alt="cover" style="object-fit:cover;height:160px;">
                            {% else %}
                                <div class="lesson-cover bg-brand" style="height:160px;display:flex;align-items:center;justify-content:center;">
                                    <i class="fas fa-graduation-cap fa-3x text-white opacity-75"></i>
                                </div>
                            {% endif %}
                            <!-- Favorite Button -->
                            <button class="favorite-btn-neo {% if lesson.is_favorite %}active{% endif %}" 
                                    onclick="event.stopPropagation(); if(typeof window.toggleFavorite === 'function') { window.toggleFavorite('{{ lesson.id }}', this); }" 
                                    aria-label="Toggle favorite">
                                <i class="fas fa-star"></i>
                            </button>
                        </div>
                        
                        <!-- Card Body -->
                        <div class="card-body d-flex flex-column">
                            <div class="mb-2 d-flex justify-content-between align-items-start">
                                <h5 class="mb-0 card-title">{{ lesson.title }}</h5>
                                {% set status_badge = 'secondary' %}
                                {% if lesson.status == 'active' %}{% set status_badge = 'primary' %}
                                {% elif lesson.status == 'completed' %}{% set status_badge = 'success' %}
                                {% elif lesson.status == 'archived' %}{% set status_badge = 'warning' %}{% endif %}
                                <span class="badge status-pill bg-{{ status_badge }} text-uppercase">{{ lesson.status or 'active' }}</span>
                            </div>
                            
                            <p class="card-text text-truncate-3">{{ (lesson.description or 'No description')|striptags }}</p>
                            
                            <!-- Tags -->
                            {% if lesson.tags %}
                            <div class="mb-2">
                                {% if lesson.tags is string %}
                                    {% for tag in lesson.tags.split(',')[:3] %}
                                        <span class="border badge text-bg-light me-1">{{ tag.strip() }}</span>
                                    {% endfor %}
                                {% else %}
                                    {% for tag in lesson.tags[:3] %}
                                        <span class="border badge text-bg-light me-1">{{ tag }}</span>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            {% endif %}
                            
                            <!-- Meta Info -->
                            <div class="mt-auto small text-muted">
                                <span class="me-2">
                                    <i class="bi bi-calendar2-week me-1"></i>
                                    {{ lesson.created_at.strftime('%Y-%m-%d') if lesson.created_at else '' }}
                                </span>
                                {% if lesson.author_name %}
                                <span><i class="bi bi-person me-1"></i>{{ lesson.author_name }}</span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Card Footer -->
                        <div class="gap-2 pt-0 pb-3 bg-white border-0 card-footer d-flex justify-content-end">
                            <button type="button" class="btn btn-sm btn-outline-warning btn-soft" 
                                    onclick="event.stopPropagation();"
                                    data-bs-toggle="modal" data-bs-target="#editLessonModal"
                                    data-lesson-id="{{ lesson.id }}"
                                    data-lesson-title="{{ lesson.title }}"
                                    data-lesson-description="{{ lesson.description or '' }}"
                                    data-lesson-status="{{ lesson.status or 'active' }}">
                                <i class="fas fa-pen me-1"></i>Edit
                            </button>
                            <button onclick="event.stopPropagation(); if(confirm('Are you sure you want to delete this lesson?') && typeof window.deleteLesson === 'function') { window.deleteLesson('{{ lesson.id }}'); }" 
                                    class="btn btn-sm btn-outline-danger btn-soft">
                                <i class="fas fa-trash me-1"></i>Delete
                            </button>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="col">
                <div class="py-5 text-center text-muted">
                    <i class="mb-3 fas fa-book-open fa-4x"></i>
                    <p class="mb-2">You don't have any lessons yet.</p>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addLessonModal">
                        <i class="fas fa-plus me-1"></i>Create your first lesson
                    </button>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<!-- Add Lesson Modal -->
<div class="modal fade modal-glass" id="addLessonModal" tabindex="-1" aria-labelledby="addLessonModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered" style="max-width: 90vw; max-height: 90vh;">
    <div class="modal-content">
        <div class="text-white border-0 modal-header hero bg-success">
            <div class="d-flex align-items-center">
                <div class="hero-icon me-2"><i class="bi bi-journal-plus"></i></div>
                <div>
                    <h5 class="mb-0 text-white modal-title" id="addLessonModalLabel">Create New Lesson</h5>
                    <div class="opacity-75 small">Fill in the details to create your new lesson</div>
                </div>
            </div>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-0" style="max-height: 75vh; overflow: hidden;">
            <div class="row g-0" style="height: 100%;">
                <!-- Left Side - Form -->
                <div class="col-lg-8" style="overflow-y: auto; max-height: 75vh;">
                    <div class="p-4">
                        <form id="add-lesson-form" class="needs-validation" novalidate>
                            <input type="hidden" id="selectedColor" name="selectedColor" value="1">
                            
                            <!-- Basic Information -->
                            <div class="p-3 mb-3 border bg-light rounded-3 glass-section">
                                <h6 class="section-title mb-3">
                                    <i class="bi bi-info-circle me-2"></i>Basic Information
                                </h6>
                                
                                <div class="mb-3">
                                    <label for="lesson-title" class="form-label fw-semibold">
                                        <i class="bi bi-type me-1"></i>Lesson Title <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control form-control-lg" id="lesson-title" name="title" maxlength="100" placeholder="Enter a descriptive title" required>
                                    <div class="invalid-feedback">Please provide a lesson title.</div>
                                </div>
                                
                                <div class="mb-0">
                                    <label for="lesson-description" class="form-label fw-semibold">
                                        <i class="bi bi-textarea-t me-1"></i>Description
                                    </label>
                                    <textarea class="form-control" id="lesson-description" name="description" rows="4" maxlength="500" placeholder="Provide a brief description of what this lesson covers..."></textarea>
                                </div>
                            </div>
                            
                            <!-- Lesson Details -->
                            <div class="p-3 mb-3 border bg-light rounded-3 glass-section">
                                <h6 class="section-title mb-3">
                                    <i class="bi bi-gear me-2"></i>Lesson Details
                                </h6>
                                
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="lesson-status" class="form-label fw-semibold">
                                            <i class="bi bi-ui-checks-grid me-1"></i>Status
                                        </label>
                                        <select class="form-select" id="lesson-status" name="status">
                                            <option value="active" selected>📋 Active</option>
                                            <option value="completed">✅ Completed</option>
                                            <option value="archived">📦 Archived</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="lesson-author" class="form-label fw-semibold">
                                            <i class="bi bi-person me-1"></i>Author Name
                                        </label>
                                        <input type="text" class="form-control" id="lesson-author" name="author_name" placeholder="Who created this lesson?">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Tags -->
                            <div class="p-3 mb-3 border bg-light rounded-3 glass-section">
                                <h6 class="section-title mb-3">
                                    <i class="bi bi-tags me-2"></i>Tags & Categories
                                </h6>
                                
                                <label for="lesson-tags" class="form-label fw-semibold">
                                    <i class="bi bi-tag me-1"></i>Tags
                                </label>
                                <input type="text" class="form-control" id="lesson-tags" name="tags" placeholder="e.g., Mathematics, Science, Programming, Beginner">
                                <div class="form-text">
                                    <i class="bi bi-info-circle me-1"></i>Separate multiple tags with commas. Tags help organize and find your lessons.
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary btn-soft flex-grow-1">
                                    <i class="bi bi-save2-fill me-2"></i>Create Lesson
                                </button>
                                <button type="reset" class="btn btn-outline-secondary btn-soft">
                                    <i class="bi bi-arrow-clockwise me-2"></i>Reset
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Right Side - Preview & Customization -->
                <div class="col-lg-4 bg-light border-start" style="overflow-y: auto; max-height: 75vh;">
                    <div class="p-4">
                        <div class="text-center mb-4">
                            <h6 class="fw-bold mb-2">
                                <i class="bi bi-eye me-2"></i>Live Preview
                            </h6>
                            <p class="text-muted small">See how your lesson will appear</p>
                        </div>
                        
                        <!-- Color Picker -->
                        <div class="mb-4">
                            <h6 class="fw-semibold mb-3">
                                <i class="bi bi-palette me-2"></i>Card Theme
                            </h6>
                            <div class="d-flex gap-2 flex-wrap justify-content-center">
                                <div class="color-option-neo active" data-color="1" style="background: linear-gradient(135deg, #007bff, #0056b3);" onclick="selectColorNeo(this, 1)" title="Blue">
                                    <i class="fas fa-check text-white"></i>
                                </div>
                                <div class="color-option-neo" data-color="2" style="background: linear-gradient(135deg, #28a745, #1e7e34);" onclick="selectColorNeo(this, 2)" title="Green">
                                    <i class="fas fa-check text-white"></i>
                                </div>
                                <div class="color-option-neo" data-color="3" style="background: linear-gradient(135deg, #dc3545, #bd2130);" onclick="selectColorNeo(this, 3)" title="Red">
                                    <i class="fas fa-check text-white"></i>
                                </div>
                                <div class="color-option-neo" data-color="4" style="background: linear-gradient(135deg, #ffc107, #e0a800);" onclick="selectColorNeo(this, 4)" title="Yellow">
                                    <i class="fas fa-check text-white"></i>
                                </div>
                                <div class="color-option-neo" data-color="5" style="background: linear-gradient(135deg, #6f42c1, #5a32a3);" onclick="selectColorNeo(this, 5)" title="Purple">
                                    <i class="fas fa-check text-white"></i>
                                </div>
                                <div class="color-option-neo" data-color="6" style="background: linear-gradient(135deg, #fd7e14, #e8590c);" onclick="selectColorNeo(this, 6)" title="Orange">
                                    <i class="fas fa-check text-white"></i>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Preview Card -->
                        <div class="preview-card-neo" id="previewCard">
                            <div class="preview-card-header" id="previewCardHeader" style="background: linear-gradient(135deg, #007bff, #0056b3);">
                                <i class="fas fa-graduation-cap fa-3x text-white opacity-75"></i>
                            </div>
                            <div class="card-body">
                                <h6 class="card-title mb-2 fw-bold" id="previewTitle">Your Lesson Title</h6>
                                <p class="card-text text-muted small mb-2 text-truncate-3" id="previewDescription">Your lesson description will appear here...</p>
                                <div class="d-flex justify-content-between align-items-center mt-3 pt-2 border-top">
                                    <span class="text-muted small" id="previewAuthor">
                                        <i class="bi bi-person me-1"></i>Unknown Author
                                    </span>
                                    <span class="badge bg-primary rounded-pill small" id="previewStatus">Active</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Google Classroom Integration -->
                        <div class="mt-4 p-3 bg-white rounded-3 border">
                            <h6 class="fw-semibold mb-2">
                                <i class="fab fa-google me-2 text-primary"></i>Quick Import
                            </h6>
                            <p class="text-muted small mb-2">
                                Connect Google Classroom to import courses as lessons.
                            </p>
                            <a href="{{ url_for('google_classroom.authorize') }}" class="btn btn-outline-primary btn-sm w-100">
                                <i class="fab fa-google me-2"></i>Connect Google Classroom
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
  </div>
</div>

<style>
/* Color Picker Neo-morphism */
.color-option-neo {
  width: 45px;
  height: 45px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 3px solid transparent;
  transition: all 0.3s ease;
  box-shadow: 4px 4px 8px rgba(0,0,0,0.15), -2px -2px 6px rgba(255,255,255,0.7);
}

.color-option-neo:hover {
  transform: scale(1.15);
  box-shadow: 6px 6px 12px rgba(0,0,0,0.2), -3px -3px 8px rgba(255,255,255,0.8);
}

.color-option-neo.active {
  border-color: #fff;
  transform: scale(1.15);
  box-shadow: 0 0 0 3px rgba(0,123,255,0.5), 6px 6px 12px rgba(0,0,0,0.2);
}

.color-option-neo i {
  opacity: 0;
  transition: opacity 0.3s ease;
  font-size: 18px;
}

.color-option-neo.active i {
  opacity: 1;
}

/* Preview Card Neo-morphism */
.preview-card-neo {
  background: linear-gradient(145deg, #ffffff, #f0f0f0);
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 8px 8px 16px rgba(0,0,0,0.1), -4px -4px 12px rgba(255,255,255,0.9);
  transition: all 0.3s ease;
}

.preview-card-neo:hover {
  transform: translateY(-4px);
  box-shadow: 12px 12px 20px rgba(0,0,0,0.12), -6px -6px 14px rgba(255,255,255,0.95);
}

.preview-card-header {
  height: 100px;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

/* Modal adjustments for better form display */
.modal-xl .modal-body {
  padding: 0;
}

.modal-xl .glass-section {
  animation: slideInUp 0.3s ease-out;
}

@keyframes slideInUp {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
</style>

<!-- Edit Lesson Modal -->
<div class="modal fade modal-glass" id="editLessonModal" tabindex="-1" aria-labelledby="editLessonModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
        <div class="text-white border-0 modal-header hero bg-warning">
            <div class="d-flex align-items-center">
                <div class="hero-icon me-2"><i class="bi bi-pencil"></i></div>
                <div>
                    <h5 class="mb-0 text-white modal-title" id="editLessonModalLabel">Edit Lesson</h5>
                    <div class="opacity-75 small">Update lesson details</div>
                </div>
            </div>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <form id="edit-lesson-form" class="needs-validation" novalidate>
                <input type="hidden" id="edit-lesson-id" name="lesson_id">
                
                <div class="mb-3">
                    <label for="edit-lesson-title" class="form-label section-title"><i class="bi bi-type me-1"></i>Title</label>
                    <input type="text" class="form-control" id="edit-lesson-title" name="title" maxlength="100" required>
                </div>
                
                <div class="p-3 mb-3 border bg-light rounded-3 glass-section">
                    <label for="edit-lesson-description" class="form-label section-title"><i class="bi bi-textarea-t me-1"></i>Description</label>
                    <textarea class="form-control" id="edit-lesson-description" name="description" rows="4" maxlength="500"></textarea>
                </div>
                
                <div class="mb-3">
                    <label for="edit-lesson-status" class="form-label section-title"><i class="bi bi-ui-checks-grid me-1"></i>Status</label>
                    <select class="form-select" id="edit-lesson-status" name="status">
                        <option value="active">Active</option>
                        <option value="completed">Completed</option>
                        <option value="archived">Archived</option>
                    </select>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary btn-soft" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Close
                    </button>
                    <button type="submit" class="btn btn-primary btn-soft">
                        <i class="bi bi-pencil-square me-1"></i>Update Lesson
                    </button>
                </div>
            </form>
        </div>
    </div>
  </div>
</div>

<style>
/* Copy styles from note_fragment.html */
.root, :root {
  --slh-primary: #003B8E;
  --slh-primary-2: #2B6BCF;
  --slh-primary-3: #002862;
}

.text-truncate-3 { 
  display:-webkit-box; 
  -webkit-line-clamp:3; 
  -webkit-box-orient:vertical; 
  overflow:hidden; 
}

/* Neo-morphism Cards */
.neo-card {
  border: 1px solid rgba(255,255,255,0.5);
  border-radius: 16px;
  background: linear-gradient(145deg, #ffffff, #eef1f6);
  box-shadow: 8px 8px 20px rgba(0,0,0,0.08), -6px -6px 16px rgba(255,255,255,0.9);
  transition: transform .2s ease, box-shadow .2s ease;
}

.neo-card:hover { 
  transform: translateY(-4px); 
  box-shadow: 12px 12px 26px rgba(0,0,0,0.10), -8px -8px 18px rgba(255,255,255,0.95); 
}

.status-pill { 
  border-radius: 999px; 
  letter-spacing: .3px; 
  font-size: 11px;
  padding: 4px 10px;
}

/* Glassmorphism Modals */
.modal-glass .modal-content {
  background: rgba(255,255,255,0.55);
  border: 1px solid rgba(255,255,255,0.35);
  box-shadow: 0 10px 30px rgba(0,0,0,0.15), inset 1px 1px 0 rgba(255,255,255,0.4);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-radius: 16px;
}

.modal-glass .modal-header {
  border-top-left-radius: 16px;
  border-top-right-radius: 16px;
}

.modal-glass .modal-header.bg-success { 
  background: linear-gradient(135deg, var(--slh-primary), var(--slh-primary-3)) !important; 
}

.modal-glass .modal-header.bg-warning { 
  background: linear-gradient(135deg, var(--slh-primary-2), var(--slh-primary)) !important; 
}

.modal-glass .modal-body {
  background: radial-gradient(1200px circle at 10% 10%, rgba(255,255,255,.6), rgba(255,255,255,.4) 40%, rgba(255,255,255,.25) 70%);
}

.hero { 
  background: linear-gradient(135deg, var(--slh-primary-2), var(--slh-primary)); 
}

.hero .hero-icon { 
  width: 36px; 
  height: 36px; 
  border-radius: 10px; 
  background: rgba(255,255,255,.2); 
  display:flex; 
  align-items:center; 
  justify-content:center; 
}

.glass-section {
  background: rgba(255,255,255,0.55) !important;
  border: 1px solid rgba(255,255,255,0.35) !important;
  box-shadow: inset 1px 1px 0 rgba(255,255,255,0.5), 8px 8px 18px rgba(0,0,0,0.05);
}

.section-title { 
  font-weight: 600; 
  color: #334155; 
}

.modal-glass .form-control,
.modal-glass .form-select {
  border-radius: 12px;
  background: linear-gradient(145deg, #ffffff, #e6e9ef);
  box-shadow: 6px 6px 12px rgba(0,0,0,0.08), -4px -4px 10px rgba(255,255,255,0.9);
  border: 1px solid rgba(0,0,0,0.04);
}

.modal-glass .form-control:focus,
.modal-glass .form-select:focus {
  box-shadow: 0 0 0 .2rem rgba(var(--bs-primary-rgb), .15), inset 4px 4px 8px rgba(0,0,0,0.06), inset -4px -4px 8px rgba(255,255,255,0.8);
  border-color: rgba(var(--bs-primary-rgb), .35);
}

.modal-glass .btn-primary {
  background: linear-gradient(135deg, var(--slh-primary-2), var(--slh-primary));
  border-color: var(--slh-primary);
}

.modal-glass .btn-primary:hover,
.modal-glass .btn-primary:focus {
  background: linear-gradient(135deg, var(--slh-primary), var(--slh-primary-3));
  border-color: var(--slh-primary-3);
}

.btn-soft {
  border-radius: 12px;
  box-shadow: 6px 6px 12px rgba(0,0,0,0.08), -4px -4px 10px rgba(255,255,255,0.9);
  border: 1px solid rgba(0,0,0,0.04);
}

.btn-soft:active {
  box-shadow: inset 4px 4px 8px rgba(0,0,0,0.08), inset -4px -4px 8px rgba(255,255,255,0.8);
}

/* Search Bar */
.search-bar .input-group { 
  border-radius: 999px; 
  overflow: hidden; 
  box-shadow: 6px 6px 12px rgba(0,0,0,0.08), -4px -4px 10px rgba(255,255,255,0.9); 
}

.search-bar .input-group-text { 
  background: linear-gradient(145deg, #ffffff, #e6e9ef); 
  border-right: 0; 
}

.search-bar .form-control { 
  border-left: 0; 
  background: linear-gradient(145deg, #ffffff, #e6e9ef); 
}

.search-bar .form-control:focus { 
  box-shadow: 0 0 0 .2rem rgba(var(--bs-primary-rgb), .15), inset 4px 4px 8px rgba(0,0,0,0.06), inset -4px -4px 8px rgba(255,255,255,0.8); 
  border-color: rgba(var(--bs-primary-rgb), .35); 
}

.add-link { 
  color: var(--slh-primary-2); 
  font-weight: 600; 
  white-space: nowrap;
}

.add-link:hover { 
  color: var(--slh-primary); 
}

/* Chip Filters */
.chip-group .chip { 
  border-radius: 999px; 
  padding: 6px 14px; 
  border: 1px solid rgba(0,59,142,.25); 
  box-shadow: 2px 2px 6px rgba(0,0,0,0.06), -2px -2px 6px rgba(255,255,255,.8); 
  background:#fff; 
  color: var(--slh-primary); 
  transition: all .15s ease; 
}

.chip-group .chip:hover { 
  background: rgba(0,59,142,.08); 
  color: var(--slh-primary-2); 
}

.chip-group .chip.active { 
  background: linear-gradient(135deg, var(--slh-primary-2), var(--slh-primary)); 
  color: #fff; 
  border-color: var(--slh-primary); 
  box-shadow: 0 8px 16px rgba(0,59,142,.18); 
}

/* Stats Cards */
.stats-row .stat-card { 
  background: linear-gradient(180deg, #ffffff 0%, #f7f9fc 100%); 
  border:1px solid rgba(0,0,0,.05); 
  border-radius:14px; 
  padding:14px 16px; 
  min-height:72px; 
  box-shadow: 0 6px 18px rgba(0,0,0,.06), 0 1px 0 rgba(255,255,255,.9) inset; 
  transition: transform .15s ease, box-shadow .15s ease; 
}

.stats-row .stat-card:hover { 
  transform: translateY(-2px); 
  box-shadow: 0 10px 24px rgba(0,0,0,.08), 0 1px 0 rgba(255,255,255,.95) inset; 
}

.stat-icon { 
  width:36px; 
  height:36px; 
  border-radius:10px; 
  display:flex; 
  align-items:center; 
  justify-content:center; 
  font-size:18px; 
}

.bg-brand { 
  background: linear-gradient(135deg, var(--slh-primary-2), var(--slh-primary)); 
}

.bg-success-subtle { 
  background: rgba(25, 135, 84, .12) !important; 
}

.bg-primary-subtle { 
  background: rgba(13, 110, 253, .12) !important; 
}

.bg-warning-subtle { 
  background: rgba(255, 193, 7, .12) !important; 
}

/* Lesson Cover */
.lesson-cover-wrapper {
  position: relative;
}

.lesson-cover {
  height:160px;
  background: linear-gradient(135deg, var(--slh-primary), var(--slh-primary-3));
  border-top-left-radius: 15px;
  border-top-right-radius: 15px;
}

/* Favorite Button */
.favorite-btn-neo {
  position: absolute;
  top: 10px;
  right: 10px;
  background: rgba(255, 255, 255, 0.9);
  border: none;
  border-radius: 50%;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  z-index: 10;
}

.favorite-btn-neo:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.favorite-btn-neo i {
  color: #6c757d;
  font-size: 18px;
  transition: color 0.2s ease;
}

.favorite-btn-neo.active i {
  color: #ffc107;
}

.neo-card .card-footer { 
  border-top: 1px solid rgba(0,0,0,.05); 
  background: linear-gradient(180deg, #ffffff 0%, #f8fbff 100%);
}
</style>

<script>
// Attach all functions to window object for global access (needed for AJAX-loaded content)
window.selectColorNeo = function(element, colorId) {
    console.log('Color selected:', colorId);
    
    // Remove active class from all color options
    document.querySelectorAll('.color-option-neo').forEach(opt => {
        opt.classList.remove('active');
    });
    
    // Add active class to selected color
    element.classList.add('active');
    
    // Update hidden input
    const selectedColorInput = document.getElementById('selectedColor');
    if (selectedColorInput) {
        selectedColorInput.value = colorId;
        console.log('Hidden input updated:', selectedColorInput.value);
    }
    
    // Update preview card header color
    const previewCardHeader = document.getElementById('previewCardHeader');
    if (previewCardHeader) {
        const colorGradients = {
            1: 'linear-gradient(135deg, #007bff, #0056b3)',
            2: 'linear-gradient(135deg, #28a745, #1e7e34)',
            3: 'linear-gradient(135deg, #dc3545, #bd2130)',
            4: 'linear-gradient(135deg, #ffc107, #e0a800)',
            5: 'linear-gradient(135deg, #6f42c1, #5a32a3)',
            6: 'linear-gradient(135deg, #fd7e14, #e8590c)'
        };
        
        const newGradient = colorGradients[colorId] || colorGradients[1];
        previewCardHeader.style.background = newGradient;
        previewCardHeader.style.backgroundImage = newGradient;
        console.log('Preview header color updated to:', newGradient);
    } else {
        console.error('Preview card header not found');
    }
};

document.addEventListener('DOMContentLoaded', function() {
    console.log('Class fragment: DOMContentLoaded');
    
    // Search functionality
    const searchInput = document.getElementById('lessonSearch');
    if (searchInput) {
        searchInput.addEventListener('input', window.filterLessons);
    }
    
    // Chip filters
    document.querySelectorAll('.chip-group .chip').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.chip-group .chip').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            window.filterLessons();
        });
    });
    
    // Edit lesson modal
    const editLessonModal = document.getElementById('editLessonModal');
    if (editLessonModal) {
        editLessonModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            if (button) {
                const id = button.getAttribute('data-lesson-id');
                const title = button.getAttribute('data-lesson-title');
                const description = button.getAttribute('data-lesson-description');
                const status = button.getAttribute('data-lesson-status');
                
                document.getElementById('edit-lesson-id').value = id;
                document.getElementById('edit-lesson-title').value = title;
                document.getElementById('edit-lesson-description').value = description;
                document.getElementById('edit-lesson-status').value = status || 'active';
            }
        });
    }
    
    // Setup Add Lesson Modal
    const addLessonModal = document.getElementById('addLessonModal');
    if (addLessonModal) {
        addLessonModal.addEventListener('shown.bs.modal', function() {
            console.log('Add Lesson Modal shown, setting up preview...');
            setupAddLessonPreview();
        });
        
        addLessonModal.addEventListener('hidden.bs.modal', function() {
            // Reset form when modal is closed
            const form = document.getElementById('add-lesson-form');
            if (form) {
                form.reset();
                form.classList.remove('was-validated');
            }
        });
    }
    
    // Setup Add Lesson Form Submission
    const addLessonForm = document.getElementById('add-lesson-form');
    if (addLessonForm) {
        addLessonForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!addLessonForm.checkValidity()) {
                e.stopPropagation();
                addLessonForm.classList.add('was-validated');
                return;
            }
            
            const formData = new FormData(addLessonForm);
            
            fetch('/partial/class/add', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addLessonModal'));
                    if (modal) {
                        modal.hide();
                    }
                    loadPage('class');
                } else {
                    alert(data.message || 'Error creating lesson');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error creating lesson');
            });
        });
    }
});

function setupAddLessonPreview() {
    // Setup input listeners with debouncing
    const titleInput = document.getElementById('lesson-title');
    const descriptionInput = document.getElementById('lesson-description');
    const authorInput = document.getElementById('lesson-author');
    const statusSelect = document.getElementById('lesson-status');
    
    function updatePreview() {
        const title = titleInput?.value || 'Your Lesson Title';
        const description = descriptionInput?.value || 'Your lesson description will appear here...';
        const author = authorInput?.value || 'Unknown Author';
        const status = statusSelect?.value || 'active';
        
        const previewTitle = document.getElementById('previewTitle');
        const previewDescription = document.getElementById('previewDescription');
        const previewAuthor = document.getElementById('previewAuthor');
        const previewStatus = document.getElementById('previewStatus');
        
        if (previewTitle) previewTitle.textContent = title;
        if (previewDescription) previewDescription.textContent = description;
        if (previewAuthor) previewAuthor.innerHTML = '<i class="bi bi-person me-1"></i>' + author;
        if (previewStatus) {
            previewStatus.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            previewStatus.className = 'badge rounded-pill small';
            if (status === 'active') previewStatus.classList.add('bg-primary');
            else if (status === 'completed') previewStatus.classList.add('bg-success');
            else if (status === 'archived') previewStatus.classList.add('bg-warning');
        }
    }
    
    // Add event listeners with immediate feedback
    if (titleInput) {
        titleInput.addEventListener('input', updatePreview);
        titleInput.addEventListener('keyup', updatePreview);
    }
    if (descriptionInput) {
        descriptionInput.addEventListener('input', updatePreview);
        descriptionInput.addEventListener('keyup', updatePreview);
    }
    if (authorInput) {
        authorInput.addEventListener('input', updatePreview);
        authorInput.addEventListener('keyup', updatePreview);
    }
    if (statusSelect) {
        statusSelect.addEventListener('change', updatePreview);
    }
    
    // Initial update
    updatePreview();
}

// Attach all helper functions to window object for global access
window.filterLessons = function() {
    const searchTerm = document.getElementById('lessonSearch')?.value.toLowerCase() || '';
    const activeChip = document.querySelector('.chip-group .chip.active');
    const filterStatus = activeChip?.getAttribute('data-filter') || '';
    
    document.querySelectorAll('.lesson-item').forEach(item => {
        const title = item.querySelector('.card-title')?.textContent.toLowerCase() || '';
        const description = item.querySelector('.card-text')?.textContent.toLowerCase() || '';
        const status = item.getAttribute('data-status') || '';
        
        const matchesSearch = !searchTerm || title.includes(searchTerm) || description.includes(searchTerm);
        const matchesFilter = !filterStatus || status === filterStatus;
        
        item.style.display = (matchesSearch && matchesFilter) ? '' : 'none';
    });
};

window.toggleFavorite = function(lessonId, button) {
    console.log('Toggle favorite for lesson:', lessonId);
    button.classList.toggle('active');
    
    // TODO: Implement API call to toggle favorite
    fetch(`/partial/class/${lessonId}/favorite`, { 
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Favorite toggled successfully');
        }
    })
    .catch(error => {
        console.error('Error toggling favorite:', error);
        // Keep the UI change even if API fails
    });
};

window.viewLesson = function(lessonId) {
    console.log('View lesson:', lessonId);
    // Navigate to lesson detail page
    if (typeof loadPage === 'function') {
        loadPage('class/' + lessonId);
    } else {
        window.location.href = '/class/' + lessonId;
    }
};

window.deleteLesson = function(lessonId) {
    if (confirm('Are you sure you want to delete this lesson?')) {
        console.log('Delete lesson:', lessonId);
        
        fetch(`/partial/class/${lessonId}/delete`, { 
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Reload the class page
                if (typeof loadPage === 'function') {
                    loadPage('class');
                } else {
                    window.location.reload();
                }
            } else {
                alert(data.message || 'Error deleting lesson');
            }
        })
        .catch(error => {
            console.error('Error deleting lesson:', error);
            alert('Error deleting lesson');
        });
    }
};
</script>

