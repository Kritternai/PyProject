<div class="px-4 container-fluid" id="class-list-container">
    <div class="">
      <h1 class="">All Lessons</h1>
        </div>
    
    <!-- Toolbar: Search & Add -->
    <div class="mb-3 d-flex justify-content-between align-items-center page-toolbar">
        <div class="flex-grow-1 me-3" style="max-width: 640px;">
            <div class="input-group search-bar">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input id="lessonSearch" type="text" class="form-control" placeholder="Search lessons...">
            </div>
        </div>
        <a href="#" class="text-decoration-none add-link" data-bs-toggle="modal" data-bs-target="#addLessonModal">
            <i class="bi bi-plus-circle me-1"></i>Add new lesson
        </a>
      </div>
      
    <!-- Status Chips -->
    <div class="mb-3 d-flex justify-content-between align-items-center">
        <div class="gap-2 d-flex chip-group">
            <button type="button" class="btn btn-light chip active" data-filter="">All</button>
            <button type="button" class="btn btn-light chip" data-filter="active">Active</button>
            <button type="button" class="btn btn-light chip" data-filter="completed">Completed</button>
            <button type="button" class="btn btn-light chip" data-filter="archived">Archived</button>
        </div>
        <div></div>
    </div>
    
    <!-- Calculate Statistics -->
    {% set stats = namespace(total=0, active=0, completed=0, archived=0, favorites=0) %}
    {% if lessons %}
      {% set stats.total = lessons|length %}
      {% for lesson in lessons %}
        {% if lesson.status == 'active' %}{% set stats.active = stats.active + 1 %}{% endif %}
        {% if lesson.status == 'completed' %}{% set stats.completed = stats.completed + 1 %}{% endif %}
        {% if lesson.status == 'archived' %}{% set stats.archived = stats.archived + 1 %}{% endif %}
        {% if lesson.is_favorite %}{% set stats.favorites = stats.favorites + 1 %}{% endif %}
      {% endfor %}
    {% endif %}
    
    <!-- Stats Cards -->
    <div class="mb-3 row g-3 stats-row">
      <div class="col-12 col-sm-6 col-lg-3">
        <div class="stat-card d-flex align-items-center justify-content-between">
          <div class="d-flex align-items-center">
            <div class="text-white stat-icon bg-brand me-2"><i class="bi bi-journal-bookmark"></i></div>
            <div class="small text-muted">Total Lessons</div>
          </div>
          <div class="m-0 display-6 fw-semibold">{{ stats.total }}</div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-3">
        <div class="stat-card d-flex align-items-center justify-content-between">
          <div class="d-flex align-items-center">
            <div class="stat-icon bg-success-subtle text-success me-2"><i class="bi bi-check2-circle"></i></div>
            <div class="small text-muted">Completed</div>
          </div>
          <div class="m-0 display-6 fw-semibold">{{ stats.completed }}</div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-3">
        <div class="stat-card d-flex align-items-center justify-content-between">
          <div class="d-flex align-items-center">
            <div class="stat-icon bg-primary-subtle text-primary me-2"><i class="bi bi-play-circle"></i></div>
            <div class="small text-muted">Active</div>
          </div>
          <div class="m-0 display-6 fw-semibold">{{ stats.active }}</div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-3">
        <div class="stat-card d-flex align-items-center justify-content-between">
          <div class="d-flex align-items-center">
            <div class="stat-icon bg-warning-subtle text-warning me-2"><i class="bi bi-star-fill"></i></div>
            <div class="small text-muted">Favorites</div>
          </div>
          <div class="m-0 display-6 fw-semibold">{{ stats.favorites }}</div>
        </div>
    </div>
  </div>

    <!-- Microsoft Teams Status (if connected) -->
    {% if microsoft_teams_connected %}
    {% include 'microsoft_teams_status.html' %}
    {% endif %}
    
    <!-- Lessons Grid -->
    <div class="row" id="lessons-grid">
        {% if lessons %}
            {% for lesson in lessons %}
                <div class="mb-4 col-md-6 col-lg-4 lesson-item" data-lesson-id="{{ lesson.id }}" data-status="{{ lesson.status or 'active' }}" data-is-favorite="{{ 'true' if lesson.is_favorite else 'false' }}">
                    <div class="card h-100 neo-card" style="cursor:pointer; position: relative;" onclick="if(typeof loadPage === 'function') { loadPage('class/{{ lesson.id }}'); } else { window.location.href='/class/{{ lesson.id }}'; }">
                        <!-- Cover Image -->
                        <div class="lesson-cover-wrapper">
                            {% if lesson.cover_image %}
                                <img src="{{ url_for('static', filename=lesson.cover_image) }}" class="card-img-top" alt="cover" style="object-fit:cover;height:160px;">
                            {% else %}
                                {% set color_gradients = {
                                    1: 'linear-gradient(135deg, #007bff, #0056b3)',
                                    2: 'linear-gradient(135deg, #28a745, #1e7e34)',
                                    3: 'linear-gradient(135deg, #dc3545, #bd2130)',
                                    4: 'linear-gradient(135deg, #ffc107, #e0a800)',
                                    5: 'linear-gradient(135deg, #6f42c1, #5a32a3)'
                                } %}
                                {% set lesson_color = lesson.color_theme if lesson.color_theme else 1 %}
                                {% set gradient = color_gradients.get(lesson_color, color_gradients[1]) %}
                                <div class="lesson-cover" style="height:160px;display:flex;align-items:center;justify-content:center;background:{{ gradient }};">
                                    <i class="fas fa-graduation-cap fa-3x text-white opacity-75"></i>
                                </div>
                            {% endif %}
                            <!-- Favorite Button -->
                            <button class="favorite-btn-neo {% if lesson.is_favorite %}active{% endif %}" 
                                    onclick="event.stopPropagation(); if(typeof window.toggleFavorite === 'function') { window.toggleFavorite('{{ lesson.id }}', this); }" 
                                    aria-label="Toggle favorite">
                                <i class="fas fa-star"></i>
            </button>
          </div>
                        
                        <!-- Card Body -->
                        <div class="card-body d-flex flex-column">
                            <!-- Tags (Top Right Corner) -->
                            {% if lesson.tags %}
                            <div class="mb-2" style="position: absolute; top: 8px; right: 8px; z-index: 10;">
                                {% if lesson.tags is string %}
                                    {% for tag in lesson.tags.split(',')[:2] %}
                                        <span class="badge bg-white text-dark border shadow-sm" style="font-size: 0.65rem; opacity: 0.9;">
                                            <i class="bi bi-tag-fill me-1"></i>{{ tag.strip() }}
                                        </span>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            {% endif %}
                            
                            <div class="mb-2 d-flex justify-content-between align-items-start">
                                <h5 class="mb-1 card-title text-dark fw-bold" style="font-size: 1.1rem;">{{ lesson.title }}</h5>
                                {% set status_map = {
                                    'not_started': {'text': 'Not Started', 'class': 'bg-secondary'},
                                    'in_progress': {'text': 'In Progress', 'class': 'bg-primary'},
                                    'completed': {'text': 'Completed', 'class': 'bg-success'},
                                    'archived': {'text': 'Archived', 'class': 'bg-warning text-dark'},
                                    'active': {'text': 'Active', 'class': 'bg-info'},
                                    'LessonStatus.NOT_STARTED': {'text': 'Not Started', 'class': 'bg-secondary'},
                                    'LessonStatus.IN_PROGRESS': {'text': 'In Progress', 'class': 'bg-primary'},
                                    'LessonStatus.COMPLETED': {'text': 'Completed', 'class': 'bg-success'},
                                    'LessonStatus.ARCHIVED': {'text': 'Archived', 'class': 'bg-warning text-dark'}
                                } %}
                                {% if lesson.status is string %}
                                    {% set lesson_status = lesson.status %}
                                {% else %}
                                    {% set lesson_status = lesson.status.value if lesson.status.value is defined else (lesson.status|string) %}
                                {% endif %}
                                {% set status_info = status_map.get(lesson_status, {'text': 'Not Started', 'class': 'bg-secondary'}) %}
                                <span class="badge {{ status_info.class }}" style="font-size: 0.7rem; padding: 0.35rem 0.65rem;">{{ status_info.text }}</span>
        </div>
        
                            <p class="mb-3 card-text text-muted" style="font-size: 0.875rem; line-height: 1.5; min-height: 42px;">
                                {{ lesson.description[:100] + '...' if lesson.description and lesson.description|length > 100 else (lesson.description or 'No description available') }}
                            </p>
                            
                            <!-- Meta Info -->
                            <div class="mt-auto pt-2 border-top" style="font-size: 0.8rem;">
                                <div class="d-flex justify-content-between align-items-center text-muted">
                                    <span>
                                        <i class="bi bi-calendar3 me-1"></i>
                                        {{ lesson.created_at.strftime('%d %b %Y') if lesson.created_at else 'Today' }}
                                    </span>
                                    {% if lesson.author_name %}
                                    <span>
                                        <i class="bi bi-person-circle me-1"></i>
                                        {{ lesson.author_name[:15] + '...' if lesson.author_name|length > 15 else lesson.author_name }}
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Card Footer -->
                        <div class="gap-2 px-3 py-2 bg-light border-0 card-footer d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="bi bi-eye me-1"></i>Click to view
                            </small>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-sm btn-outline-primary" 
                                        onclick="event.stopPropagation();"
                                        data-bs-toggle="modal" data-bs-target="#editLessonModal"
                                        data-lesson-id="{{ lesson.id }}"
                                        data-lesson-title="{{ lesson.title }}"
                                        data-lesson-description="{{ lesson.description or '' }}"
                                        data-lesson-status="{{ lesson.status or 'active' }}"
                                        title="Edit lesson">
                                    <i class="bi bi-pencil-square"></i>
                                </button>
                                <button onclick="event.stopPropagation(); if(typeof window.deleteLesson === 'function') { window.deleteLesson('{{ lesson.id }}'); }" 
                                        class="btn btn-sm btn-outline-danger"
                                        title="Delete lesson">
                                    <i class="bi bi-trash"></i>
          </button>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="col">
                <div class="py-5 text-center text-muted">
                    <i class="mb-3 fas fa-book-open fa-4x"></i>
                    <p class="mb-2">You don't have any lessons yet.</p>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addLessonModal">
                        <i class="fas fa-plus me-1"></i>Create your first lesson
                    </button>
                </div>
            </div>
        {% endif %}
    </div>
        </div>
        
<!-- Add Lesson Modal -->
<div class="modal fade modal-glass" id="addLessonModal" tabindex="-1" aria-labelledby="addLessonModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered" style="max-width: 90vw; max-height: 90vh;">
    <div class="modal-content">
        <div class="text-white border-0 modal-header hero bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="d-flex align-items-center">
                <div class="hero-icon me-3"><i class="bi bi-journal-plus"></i></div>
                <div>
                    <h5 class="mb-1 text-white modal-title" id="addLessonModalLabel">✨ Create New Lesson</h5>
                    <div class="opacity-90 small">Let's create something amazing together!</div>
          </div>
        </div>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
        <!-- Progress Steps -->
        <div class="px-4 pt-3 pb-2 bg-white border-bottom">
            <div class="d-flex justify-content-between align-items-center" style="max-width: 600px; margin: 0 auto;">
                <div class="text-center flex-fill step-indicator active" data-step="1">
                    <div class="step-circle mb-1">
                        <i class="bi bi-info-circle"></i>
          </div>
                    <small class="d-block fw-semibold">Basic Info</small>
          </div>
                <div class="flex-fill" style="height: 2px; background: #e0e0e0; margin: 0 10px 20px;"></div>
                <div class="text-center flex-fill step-indicator" data-step="2">
                    <div class="step-circle mb-1">
                        <i class="bi bi-gear"></i>
          </div>
                    <small class="d-block text-muted">Details</small>
        </div>
                <div class="flex-fill" style="height: 2px; background: #e0e0e0; margin: 0 10px 20px;"></div>
                <div class="text-center flex-fill step-indicator" data-step="3">
                    <div class="step-circle mb-1">
                        <i class="bi bi-palette"></i>
                    </div>
                    <small class="d-block text-muted">Customize</small>
      </div>
    </div>
  </div>

        <div class="modal-body p-0" style="max-height: 65vh; overflow: hidden;">
            <div class="row g-0" style="height: 100%;">
                <!-- Left Side - Form -->
                <div class="col-lg-8" style="overflow-y: auto; max-height: 65vh;">
                    <div class="p-4">
                        <form id="add-lesson-form" class="needs-validation" novalidate>
                            <input type="hidden" id="selectedColor" name="selectedColor" value="1">
                            
                            <!-- Basic Information -->
                            <div class="p-4 mb-4 border bg-white rounded-3 shadow-sm form-section" data-section="1">
                                <div class="mb-3 d-flex align-items-center justify-content-between">
                                    <h6 class="mb-0 section-title">
                                        <span class="badge bg-primary me-2">1</span>
                                        <i class="bi bi-info-circle me-2"></i>Basic Information
             </h6>
                                    <span class="badge bg-light text-dark">Required</span>
                                </div>
                                
                                <div class="mb-4">
                                    <label for="lesson-title" class="form-label fw-semibold d-flex justify-content-between align-items-center">
                                        <span>
                                            <i class="bi bi-type text-primary me-1"></i>Lesson Title 
                                            <span class="text-danger">*</span>
                                        </span>
                                        <small class="text-muted fw-normal">
                                            <span id="title-counter">0</span>/100
             </small>
            </label>
                                    <input type="text" 
                                           class="form-control form-control-lg" 
                                           id="lesson-title" 
                                           name="title" 
                                           maxlength="100" 
                                           placeholder="e.g., Introduction to Python Programming" 
                                           required
                                           oninput="updateCharCount(this, 'title-counter', 100); updatePreview();">
                                    <div class="mt-2 form-text">
                                        <i class="bi bi-lightbulb text-warning me-1"></i>
                                        <strong>Tip:</strong> Choose a clear, descriptive title that students will easily understand
           </div>
                                    <div class="invalid-feedback">
                                        <i class="bi bi-exclamation-circle me-1"></i>Please provide a lesson title
           </div>
                                    <div class="mt-1 valid-feedback">
                                        <i class="bi bi-check-circle me-1"></i>Great title!
         </div>
       </div>
      
                                <div class="mb-0">
                                    <label for="lesson-description" class="form-label fw-semibold d-flex justify-content-between align-items-center">
                                        <span>
                                            <i class="bi bi-textarea-t text-info me-1"></i>Description
                                        </span>
                                        <small class="text-muted fw-normal">
                                            <span id="desc-counter">0</span>/500
                                        </small>
            </label>
                                    <textarea class="form-control" 
                                              id="lesson-description" 
                                              name="description" 
                                              rows="4" 
                                              maxlength="500" 
                                              placeholder="What will students learn in this lesson? What topics will be covered?"
                                              oninput="updateCharCount(this, 'desc-counter', 500); updatePreview();"></textarea>
                                    <div class="mt-2 form-text">
                                        <i class="bi bi-lightbulb text-warning me-1"></i>
                                        <strong>Example:</strong> "Learn Python basics including variables, loops, and functions through hands-on exercises"
          </div>
        </div>
      </div>
      
                            <!-- Lesson Details -->
                            <div class="p-4 mb-4 border bg-white rounded-3 shadow-sm form-section" data-section="2">
                                <div class="mb-3 d-flex align-items-center justify-content-between">
                                    <h6 class="mb-0 section-title">
                                        <span class="badge bg-primary me-2">2</span>
                                        <i class="bi bi-gear me-2"></i>Lesson Details
                                    </h6>
                                    <span class="badge bg-light text-dark">Optional</span>
      </div>
                                
        <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="lesson-status" class="form-label fw-semibold">
                                            <i class="bi bi-ui-checks-grid text-success me-1"></i>Status
                                        </label>
                                        <select class="form-select form-select-lg" 
                                                id="lesson-status" 
                                                name="status"
                                                onchange="updatePreview();">
                                            <option value="not_started" selected>⏸️ Not Started - Planning phase</option>
                                            <option value="in_progress">▶️ In Progress - Currently teaching</option>
                                            <option value="completed">✅ Completed - Finished</option>
                                            <option value="archived">📦 Archived - Not in use</option>
            </select>
                                        <div class="mt-2 form-text">
                                            <i class="bi bi-info-circle me-1"></i>
                                            Set lesson status to organize your content
          </div>
          </div>
                                    <div class="col-md-6">
                                        <label for="lesson-difficulty" class="form-label fw-semibold">
                                            <i class="bi bi-star text-warning me-1"></i>Difficulty Level
                                        </label>
                                        <select class="form-select form-select-lg" 
                                                id="lesson-difficulty" 
                                                name="difficulty_level">
                                            <option value="beginner" selected>⭐ Beginner</option>
                                            <option value="intermediate">⭐⭐ Intermediate</option>
                                            <option value="advanced">⭐⭐⭐ Advanced</option>
            </select>
                                        <div class="mt-2 form-text">
                                            <i class="bi bi-info-circle me-1"></i>
                                            Help students understand the complexity
          </div>
        </div>
                                    <div class="col-md-6">
                                        <label for="lesson-author" class="form-label fw-semibold">
                                            <i class="bi bi-person-circle text-secondary me-1"></i>Author Name
                                        </label>
                                        <input type="text" 
                                               class="form-control form-control-lg" 
                                               id="lesson-author" 
                                               name="author_name" 
                                               maxlength="100"
                                               placeholder="e.g., Dr. Smith">
                                        <div class="mt-2 form-text">
                                            <i class="bi bi-lightbulb text-warning me-1"></i>
                                            Teacher or creator name
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="lesson-duration" class="form-label fw-semibold">
                                            <i class="bi bi-clock text-info me-1"></i>Estimated Duration (minutes)
                                        </label>
                                        <input type="number" 
                                               class="form-control form-control-lg" 
                                               id="lesson-duration" 
                                               name="estimated_duration" 
                                               min="1"
                                               max="999"
                                               placeholder="e.g., 60">
                                        <div class="mt-2 form-text">
                                            <i class="bi bi-lightbulb text-warning me-1"></i>
                                            How long will this lesson take?
                                        </div>
      </div>
    </div>
  </div>

                            <!-- Tags -->
                            <div class="p-4 mb-4 border bg-white rounded-3 shadow-sm form-section" data-section="3">
                                <div class="mb-3 d-flex align-items-center justify-content-between">
                                    <h6 class="mb-0 section-title">
                                        <span class="badge bg-primary me-2">3</span>
                                        <i class="bi bi-tags me-2"></i>Tags & Categories
             </h6>
                                    <span class="badge bg-light text-dark">Optional</span>
           </div>
                                
                                <label for="lesson-tags" class="form-label fw-semibold">
                                    <i class="bi bi-tag text-warning me-1"></i>Tags
                                    <span class="ms-2 badge bg-info-subtle text-info">Helps with search</span>
                                </label>
                                <input type="text" 
                                       class="form-control form-control-lg" 
                                       id="lesson-tags" 
                                       name="tags" 
                                       placeholder="e.g., Python, Beginner, Programming, Tutorial">
                                <div class="mt-2 form-text">
                                    <i class="bi bi-lightbulb text-warning me-1"></i>
                                    <strong>Pro Tip:</strong> Use specific tags like "Python Basics" or "Math Grade 10" for better organization
                                </div>
                                
                                <!-- Popular Tags -->
                                <div class="mt-3">
                                    <small class="text-muted d-block mb-2">
                                        <i class="bi bi-star me-1"></i>Popular tags (click to add):
                                    </small>
                                    <div class="d-flex flex-wrap gap-2">
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addTag('Beginner')">
                                            <i class="bi bi-plus-circle me-1"></i>Beginner
          </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addTag('Advanced')">
                                            <i class="bi bi-plus-circle me-1"></i>Advanced
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addTag('Tutorial')">
                                            <i class="bi bi-plus-circle me-1"></i>Tutorial
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addTag('Exercise')">
                                            <i class="bi bi-plus-circle me-1"></i>Exercise
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addTag('Project')">
                                            <i class="bi bi-plus-circle me-1"></i>Project
             </button>
           </div>
         </div>
       </div>
                            
                            <!-- Action Buttons -->
                            <div class="sticky-bottom bg-white p-3 border-top">
                                <div class="d-flex gap-3">
                                    <button type="submit" class="btn btn-lg btn-primary flex-grow-1 shadow">
                                        <i class="bi bi-rocket-takeoff me-2"></i>Create Lesson
                                        <span class="ms-2 badge bg-white text-primary">✨</span>
                                    </button>
                                    <button type="reset" class="btn btn-lg btn-outline-secondary" onclick="resetForm()">
                                        <i class="bi bi-arrow-clockwise me-2"></i>Reset
                                    </button>
     </div>
                                <div class="mt-2 text-center">
                                    <small class="text-muted">
                                        <i class="bi bi-shield-check me-1"></i>
                                        All fields are saved automatically
                                    </small>
   </div>
        </div>
                        </form>
      </div>
    </div>
            
                <!-- Right Side - Customization -->
                <div class="col-lg-4 bg-gradient border-start" style="overflow-y: auto; max-height: 65vh; background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%);">
                    <div class="p-4">
                        
                        <!-- Color Theme Picker -->
                        <div class="mb-4">
                            <div class="text-center mb-3">
                                <h6 class="fw-bold mb-1">
                                    <i class="bi bi-palette me-2 text-primary"></i>Choose Card Theme
                                </h6>
                                <p class="text-muted small mb-0">Select a color for your lesson card</p>
  </div>
            
                            <div class="p-3 bg-white rounded-3 shadow-sm">
                                <div class="d-flex gap-3 flex-wrap justify-content-center" id="color-picker-container">
                                    <div class="color-option-neo active" 
                                         data-color="1" 
                                         style="background: linear-gradient(135deg, #007bff, #0056b3); cursor: pointer;" 
                                         onclick="selectColor(this, 1)"
                                         title="Ocean Blue">
                                        <i class="fas fa-check text-white" style="pointer-events: none;"></i>
                                        <span class="color-name" style="pointer-events: none;">Blue</span>
        </div>
                                    <div class="color-option-neo" 
                                         data-color="2" 
                                         style="background: linear-gradient(135deg, #28a745, #1e7e34); cursor: pointer;" 
                                         onclick="selectColor(this, 2)"
                                         title="Fresh Green">
                                        <i class="fas fa-check text-white" style="pointer-events: none;"></i>
                                        <span class="color-name" style="pointer-events: none;">Green</span>
      </div>
                                    <div class="color-option-neo" 
                                         data-color="3" 
                                         style="background: linear-gradient(135deg, #dc3545, #bd2130); cursor: pointer;" 
                                         onclick="selectColor(this, 3)"
                                         title="Vibrant Red">
                                        <i class="fas fa-check text-white" style="pointer-events: none;"></i>
                                        <span class="color-name" style="pointer-events: none;">Red</span>
    </div>
                                    <div class="color-option-neo" 
                                         data-color="4" 
                                         style="background: linear-gradient(135deg, #ffc107, #e0a800); cursor: pointer;" 
                                         onclick="selectColor(this, 4)"
                                         title="Sunny Yellow">
                                        <i class="fas fa-check text-white" style="pointer-events: none;"></i>
                                        <span class="color-name" style="pointer-events: none;">Yellow</span>
  </div>
                                    <div class="color-option-neo" 
                                         data-color="5" 
                                         style="background: linear-gradient(135deg, #6f42c1, #5a32a3); cursor: pointer;" 
                                         onclick="selectColor(this, 5)"
                                         title="Royal Purple">
                                        <i class="fas fa-check text-white" style="pointer-events: none;"></i>
                                        <span class="color-name" style="pointer-events: none;">Purple</span>
              </div>
            </div>
                                <div class="mt-3 text-center">
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle me-1"></i>
                                        <span id="selected-color-name" class="fw-semibold">Blue</span> selected
                                    </small>
          </div>
              </div>
              </div>
                        
                        <!-- Quick Import Section -->
                        <div class="mt-4">
                            <h6 class="fw-semibold mb-3">
                                <i class="bi bi-cloud-arrow-down me-2"></i>Quick Import
                            </h6>
                            <p class="text-muted small mb-3">
                                Import lessons from external platforms
                            </p>
                            
                            <!-- Google Classroom -->
                            {% if not google_classroom_connected %}
                            <div class="p-3 mb-3 bg-white rounded-3 border">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fab fa-google text-primary fa-2x me-2"></i>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-0 text-primary fw-semibold">Google Classroom</h6>
                                        <p class="mb-0 text-muted small">Import courses</p>
              </div>
            </div>
                                <a href="{{ url_for('google_classroom.authorize') }}" class="btn btn-outline-primary btn-sm w-100">
                                    <i class="fas fa-plug me-1"></i>Connect
                                </a>
            </div>
    {% else %}
                            <div class="p-3 mb-3 rounded-3 border bg-success-subtle border-success">
                                <div class="d-flex align-items-center">
                                    <i class="fab fa-google text-success fa-2x me-2"></i>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-0 text-success fw-semibold">Google Classroom</h6>
                                        <p class="mb-0 text-success small">
                                            <i class="fas fa-check-circle me-1"></i>Connected
                                        </p>
              </div>
            </div>
          </div>
    {% endif %}
                            
                            <!-- Microsoft Teams -->
                            {% if not microsoft_teams_connected %}
                            <div class="p-3 bg-white rounded-3 border">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fab fa-microsoft text-info fa-2x me-2"></i>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-0 text-info fw-semibold">Microsoft Teams</h6>
                                        <p class="mb-0 text-muted small">Import channels (Mock)</p>
        </div>
      </div>
                                <a href="{{ url_for('microsoft_teams.authorize') }}" class="btn btn-outline-info btn-sm w-100">
                                    <i class="fas fa-plug me-1"></i>Connect
                                </a>
      </div>
    {% else %}
                            <div class="p-3 rounded-3 border bg-info-subtle border-info">
                                <div class="d-flex align-items-center">
                                    <i class="fab fa-microsoft text-info fa-2x me-2"></i>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-0 text-info fw-semibold">Microsoft Teams</h6>
                                        <p class="mb-0 text-info small">
                                            <i class="fas fa-check-circle me-1"></i>Connected
                                        </p>
                                    </div>
        </div>
      </div>
    {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
  </div>
</div>

<style>
/* Color Picker Neo-morphism */
.color-option-neo {
  width: 70px;
  height: 70px;
  border-radius: 12px;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  border: 3px solid transparent;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1), 0 1px 3px rgba(0,0,0,0.08);
  position: relative;
}

.color-option-neo:hover {
  transform: translateY(-4px) scale(1.05);
  box-shadow: 0 8px 16px rgba(0,0,0,0.15), 0 3px 6px rgba(0,0,0,0.1);
}

.color-option-neo.active {
  border-color: #fff;
  transform: translateY(-4px) scale(1.05);
  box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.3), 0 8px 16px rgba(0,0,0,0.15);
}

.color-option-neo i {
  opacity: 0;
  transform: translate(-50%, -50%) scale(0);
  transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  font-size: 24px;
    position: absolute;
    top: 50%;
  left: 50%;
  pointer-events: none;
}

.color-option-neo.active i {
  opacity: 1;
  transform: translate(-50%, -50%) scale(1);
  animation: checkPop 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

.color-option-neo .color-name {
  font-size: 10px;
  font-weight: 600;
    color: white;
  text-shadow: 0 1px 2px rgba(0,0,0,0.3);
  margin-top: 2px;
  opacity: 0.9;
  position: absolute;
  bottom: 4px;
  pointer-events: none;
}

@keyframes checkPop {
  0% { transform: translate(-50%, -50%) scale(0); }
  50% { transform: translate(-50%, -50%) scale(1.2); }
  100% { transform: translate(-50%, -50%) scale(1); }
}

/* Preview Card Neo-morphism */
.preview-card-neo {
  background: linear-gradient(145deg, #ffffff, #f0f0f0);
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 8px 8px 16px rgba(0,0,0,0.1), -4px -4px 12px rgba(255,255,255,0.9);
  transition: all 0.3s ease;
}

.preview-card-neo:hover {
  transform: translateY(-4px);
  box-shadow: 12px 12px 20px rgba(0,0,0,0.12), -6px -6px 14px rgba(255,255,255,0.95);
}

.preview-card-header {
  height: 100px;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

/* Modal adjustments for better form display */
.modal-xl .modal-body {
  padding: 0;
}

.modal-xl .glass-section {
  animation: slideInUp 0.3s ease-out;
}

@keyframes slideInUp {
    from {
      opacity: 0;
    transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
/* Step Indicator Styles */
.step-indicator {
  transition: all 0.3s ease;
}

.step-circle {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: #f0f0f0;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto;
  transition: all 0.3s ease;
  color: #999;
  font-size: 18px;
}

.step-indicator.active .step-circle {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  transform: scale(1.1);
}

.step-indicator.completed .step-circle {
  background: #28a745;
  color: white;
}

.step-indicator.active small {
  color: #667eea !important;
  font-weight: 600;
}

/* Form Section Improvements */
.form-section {
  transition: all 0.3s ease;
  border-left: 4px solid transparent !important;
}

.form-section:hover {
  box-shadow: 0 4px 16px rgba(0,0,0,0.08) !important;
  border-left-color: #667eea !important;
}

/* Input Focus Effects */
.form-control:focus,
.form-select:focus {
  border-color: #667eea;
  box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.15);
}

.form-control-lg {
  font-size: 1.05rem;
  padding: 0.75rem 1rem;
}

/* Character Counter */
.form-label small {
  font-size: 0.85rem;
}

/* Sticky Bottom */
.sticky-bottom {
  position: sticky;
  bottom: 0;
  z-index: 10;
  margin: -1rem -1rem 0;
}

/* Button Improvements */
.btn-lg {
  padding: 0.75rem 1.5rem;
  font-size: 1.1rem;
  font-weight: 500;
}

.btn-primary {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border: none;
  transition: all 0.3s ease;
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

/* Helper Text Improvements */
.form-text {
  font-size: 0.875rem;
  line-height: 1.5;
}

.form-text strong {
  color: #495057;
}

/* Badge Improvements */
.badge {
  padding: 0.35em 0.65em;
  font-weight: 500;
}

/* Popular Tags Buttons */
.btn-outline-secondary:hover {
  background-color: #667eea;
  border-color: #667eea;
  color: white;
}
</style>

<!-- Edit Lesson Modal -->
<div class="modal fade modal-glass" id="editLessonModal" tabindex="-1" aria-labelledby="editLessonModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
        <div class="text-white border-0 modal-header hero bg-warning">
            <div class="d-flex align-items-center">
                <div class="hero-icon me-2"><i class="bi bi-pencil"></i></div>
                <div>
                    <h5 class="mb-0 text-white modal-title" id="editLessonModalLabel">Edit Lesson</h5>
                    <div class="opacity-75 small">Update lesson details</div>
                </div>
            </div>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <form id="edit-lesson-form" class="needs-validation" novalidate>
                <input type="hidden" id="edit-lesson-id" name="lesson_id">
                
                <div class="mb-3">
                    <label for="edit-lesson-title" class="form-label section-title"><i class="bi bi-type me-1"></i>Title</label>
                    <input type="text" class="form-control" id="edit-lesson-title" name="title" maxlength="100" required>
                </div>
                
                <div class="p-3 mb-3 border bg-light rounded-3 glass-section">
                    <label for="edit-lesson-description" class="form-label section-title"><i class="bi bi-textarea-t me-1"></i>Description</label>
                    <textarea class="form-control" id="edit-lesson-description" name="description" rows="4" maxlength="500"></textarea>
                </div>
                
                <div class="mb-3">
                    <label for="edit-lesson-status" class="form-label section-title"><i class="bi bi-ui-checks-grid me-1"></i>Status</label>
                    <select class="form-select" id="edit-lesson-status" name="status">
                        <option value="active">Active</option>
                        <option value="completed">Completed</option>
                        <option value="archived">Archived</option>
                    </select>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary btn-soft" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Close
                    </button>
                    <button type="submit" class="btn btn-primary btn-soft">
                        <i class="bi bi-pencil-square me-1"></i>Update Lesson
                    </button>
                </div>
            </form>
        </div>
    </div>
  </div>
</div>

<style>
/* Copy styles from note_fragment.html */
.root, :root {
  --slh-primary: #003B8E;
  --slh-primary-2: #2B6BCF;
  --slh-primary-3: #002862;
}

.text-truncate-3 { 
  display:-webkit-box; 
  -webkit-line-clamp:3; 
  -webkit-box-orient:vertical; 
  overflow:hidden; 
}

/* Neo-morphism Cards */
.neo-card {
  border: 1px solid rgba(255,255,255,0.5);
  border-radius: 16px;
  background: linear-gradient(145deg, #ffffff, #eef1f6);
  box-shadow: 8px 8px 20px rgba(0,0,0,0.08), -6px -6px 16px rgba(255,255,255,0.9);
  transition: transform .2s ease, box-shadow .2s ease;
}

.neo-card:hover { 
  transform: translateY(-4px); 
  box-shadow: 12px 12px 26px rgba(0,0,0,0.10), -8px -8px 18px rgba(255,255,255,0.95); 
}

.status-pill { 
  border-radius: 999px; 
  letter-spacing: .3px; 
  font-size: 11px;
  padding: 4px 10px;
}

/* Glassmorphism Modals */
.modal-glass .modal-content {
  background: rgba(255,255,255,0.55);
  border: 1px solid rgba(255,255,255,0.35);
  box-shadow: 0 10px 30px rgba(0,0,0,0.15), inset 1px 1px 0 rgba(255,255,255,0.4);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-radius: 16px;
}

.modal-glass .modal-header {
  border-top-left-radius: 16px;
  border-top-right-radius: 16px;
}

.modal-glass .modal-header.bg-success { 
  background: linear-gradient(135deg, var(--slh-primary), var(--slh-primary-3)) !important; 
}

.modal-glass .modal-header.bg-warning { 
  background: linear-gradient(135deg, var(--slh-primary-2), var(--slh-primary)) !important; 
}

.modal-glass .modal-body {
  background: radial-gradient(1200px circle at 10% 10%, rgba(255,255,255,.6), rgba(255,255,255,.4) 40%, rgba(255,255,255,.25) 70%);
}

.hero { 
  background: linear-gradient(135deg, var(--slh-primary-2), var(--slh-primary)); 
}

.hero .hero-icon { 
  width: 36px; 
  height: 36px; 
  border-radius: 10px; 
  background: rgba(255,255,255,.2); 
  display:flex; 
  align-items:center; 
  justify-content:center; 
}

.glass-section {
  background: rgba(255,255,255,0.55) !important;
  border: 1px solid rgba(255,255,255,0.35) !important;
  box-shadow: inset 1px 1px 0 rgba(255,255,255,0.5), 8px 8px 18px rgba(0,0,0,0.05);
}

.section-title { 
    font-weight: 600;
  color: #334155; 
}

.modal-glass .form-control,
.modal-glass .form-select {
  border-radius: 12px;
  background: linear-gradient(145deg, #ffffff, #e6e9ef);
  box-shadow: 6px 6px 12px rgba(0,0,0,0.08), -4px -4px 10px rgba(255,255,255,0.9);
  border: 1px solid rgba(0,0,0,0.04);
}

.modal-glass .form-control:focus,
.modal-glass .form-select:focus {
  box-shadow: 0 0 0 .2rem rgba(var(--bs-primary-rgb), .15), inset 4px 4px 8px rgba(0,0,0,0.06), inset -4px -4px 8px rgba(255,255,255,0.8);
  border-color: rgba(var(--bs-primary-rgb), .35);
}

.modal-glass .btn-primary {
  background: linear-gradient(135deg, var(--slh-primary-2), var(--slh-primary));
  border-color: var(--slh-primary);
}

.modal-glass .btn-primary:hover,
.modal-glass .btn-primary:focus {
  background: linear-gradient(135deg, var(--slh-primary), var(--slh-primary-3));
  border-color: var(--slh-primary-3);
}

.btn-soft {
  border-radius: 12px;
  box-shadow: 6px 6px 12px rgba(0,0,0,0.08), -4px -4px 10px rgba(255,255,255,0.9);
  border: 1px solid rgba(0,0,0,0.04);
}

.btn-soft:active {
  box-shadow: inset 4px 4px 8px rgba(0,0,0,0.08), inset -4px -4px 8px rgba(255,255,255,0.8);
}

/* Search Bar */
.search-bar .input-group { 
  border-radius: 999px; 
    overflow: hidden;
  box-shadow: 6px 6px 12px rgba(0,0,0,0.08), -4px -4px 10px rgba(255,255,255,0.9); 
}

.search-bar .input-group-text { 
  background: linear-gradient(145deg, #ffffff, #e6e9ef); 
  border-right: 0; 
}

.search-bar .form-control { 
  border-left: 0; 
  background: linear-gradient(145deg, #ffffff, #e6e9ef); 
}

.search-bar .form-control:focus { 
  box-shadow: 0 0 0 .2rem rgba(var(--bs-primary-rgb), .15), inset 4px 4px 8px rgba(0,0,0,0.06), inset -4px -4px 8px rgba(255,255,255,0.8); 
  border-color: rgba(var(--bs-primary-rgb), .35); 
}

.add-link { 
  color: var(--slh-primary-2); 
    font-weight: 600;
  white-space: nowrap;
}

.add-link:hover { 
  color: var(--slh-primary); 
}

/* Chip Filters */
.chip-group .chip { 
  border-radius: 999px; 
  padding: 6px 14px; 
  border: 1px solid rgba(0,59,142,.25); 
  box-shadow: 2px 2px 6px rgba(0,0,0,0.06), -2px -2px 6px rgba(255,255,255,.8); 
  background:#fff; 
  color: var(--slh-primary); 
  transition: all .15s ease; 
}

.chip-group .chip:hover { 
  background: rgba(0,59,142,.08); 
  color: var(--slh-primary-2); 
}

.chip-group .chip.active { 
  background: linear-gradient(135deg, var(--slh-primary-2), var(--slh-primary)); 
  color: #fff; 
  border-color: var(--slh-primary); 
  box-shadow: 0 8px 16px rgba(0,59,142,.18); 
}

/* Stats Cards */
.stats-row .stat-card { 
  background: linear-gradient(180deg, #ffffff 0%, #f7f9fc 100%); 
  border:1px solid rgba(0,0,0,.05); 
  border-radius:14px; 
  padding:14px 16px; 
  min-height:72px; 
  box-shadow: 0 6px 18px rgba(0,0,0,.06), 0 1px 0 rgba(255,255,255,.9) inset; 
  transition: transform .15s ease, box-shadow .15s ease; 
}

.stats-row .stat-card:hover { 
  transform: translateY(-2px); 
  box-shadow: 0 10px 24px rgba(0,0,0,.08), 0 1px 0 rgba(255,255,255,.95) inset; 
}

.stat-icon { 
  width:36px; 
  height:36px; 
  border-radius:10px; 
  display:flex; 
  align-items:center; 
  justify-content:center; 
  font-size:18px; 
}

.bg-brand { 
  background: linear-gradient(135deg, var(--slh-primary-2), var(--slh-primary)); 
}

.bg-success-subtle { 
  background: rgba(25, 135, 84, .12) !important; 
}

.bg-primary-subtle { 
  background: rgba(13, 110, 253, .12) !important; 
}

.bg-warning-subtle { 
  background: rgba(255, 193, 7, .12) !important; 
}

/* Lesson Cover */
.lesson-cover-wrapper {
    position: relative;
  }
  
.lesson-cover {
  height:160px;
  background: linear-gradient(135deg, var(--slh-primary), var(--slh-primary-3));
  border-top-left-radius: 15px;
  border-top-right-radius: 15px;
}

/* Favorite Button */
.favorite-btn-neo {
    position: absolute;
  top: 10px;
  right: 10px;
  background: rgba(255, 255, 255, 0.9);
    border: none;
    border-radius: 50%;
  width: 36px;
  height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  z-index: 10;
}

.favorite-btn-neo:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.favorite-btn-neo i {
  color: #6c757d;
  font-size: 18px;
  transition: color 0.2s ease;
}

.favorite-btn-neo.active i {
  color: #ffc107;
}

.neo-card .card-footer { 
  border-top: 1px solid rgba(0,0,0,.05); 
  background: linear-gradient(180deg, #ffffff 0%, #f8fbff 100%);
}
</style>

<script>
// ========================================
// UTILITY FUNCTIONS FOR CREATE LESSON MODAL
// ========================================

// Character counter function
window.updateCharCount = function(element, counterId, maxLength) {
    const counter = document.getElementById(counterId);
    if (counter) {
        const length = element.value.length;
        counter.textContent = length;
        
        // Change color based on length
        if (length > maxLength * 0.9) {
            counter.style.color = '#dc3545'; // Red
        } else if (length > maxLength * 0.7) {
            counter.style.color = '#ffc107'; // Yellow
        } else {
            counter.style.color = '#6c757d'; // Gray
        }
    }
};

// Update preview in real-time
window.updatePreview = function() {
    const title = document.getElementById('lesson-title')?.value || 'Your Lesson Title';
    const description = document.getElementById('lesson-description')?.value || 'Your lesson description will appear here...';
    const author = document.getElementById('lesson-author')?.value || 'Unknown Author';
    const status = document.getElementById('lesson-status')?.value || 'active';
    
    // Update preview elements
    const previewTitle = document.getElementById('previewTitle');
    const previewDescription = document.getElementById('previewDescription');
    const previewAuthor = document.getElementById('previewAuthor');
    const previewStatus = document.getElementById('previewStatus');
    
    if (previewTitle) previewTitle.textContent = title;
    if (previewDescription) previewDescription.textContent = description;
    if (previewAuthor) previewAuthor.innerHTML = `<i class="bi bi-person me-1"></i>${author}`;
    
    if (previewStatus) {
        previewStatus.textContent = status.charAt(0).toUpperCase() + status.slice(1);
        previewStatus.className = `badge rounded-pill small bg-${status === 'active' ? 'primary' : status === 'completed' ? 'success' : 'warning'}`;
    }
};

// Add tag function
window.addTag = function(tagName) {
    const tagsInput = document.getElementById('lesson-tags');
    if (tagsInput) {
        const currentTags = tagsInput.value;
        if (currentTags) {
            // Check if tag already exists
            const tagsArray = currentTags.split(',').map(t => t.trim());
            if (!tagsArray.includes(tagName)) {
                tagsInput.value = currentTags + ', ' + tagName;
            }
        } else {
            tagsInput.value = tagName;
        }
        
        // Show visual feedback
        const btn = event.target.closest('button');
        if (btn) {
            btn.classList.add('btn-success');
            btn.classList.remove('btn-outline-secondary');
            setTimeout(() => {
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-secondary');
            }, 500);
        }
    }
};

// Reset form function
window.resetForm = function() {
    const form = document.getElementById('add-lesson-form');
    if (form) {
        form.reset();
        
        // Reset character counters
        const titleCounter = document.getElementById('title-counter');
        const descCounter = document.getElementById('desc-counter');
        if (titleCounter) titleCounter.textContent = '0';
        if (descCounter) descCounter.textContent = '0';
        
        // Reset preview
        updatePreview();
        
        // Reset color selection to first color
        document.querySelectorAll('.color-option-neo').forEach((opt, index) => {
            if (index === 0) {
                opt.classList.add('active');
    } else {
                opt.classList.remove('active');
            }
        });
        
        const selectedColorInput = document.getElementById('selectedColor');
        if (selectedColorInput) selectedColorInput.value = '1';
        
        const previewHeader = document.getElementById('previewCardHeader');
        if (previewHeader) {
            previewHeader.style.background = 'linear-gradient(135deg, #007bff, #0056b3)';
        }
        
        console.log('Form reset successfully');
    }
};

// ========================================
// COLOR PICKER - Simple inline function
// ========================================

// Define IMMEDIATELY as global function
window.selectColor = function(element, colorId) {
    console.log('=== selectColor START ===');
    console.log('selectColor called with colorId:', colorId);
    console.log('Element received:', element);
    
    // Prevent default and stop propagation
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    try {
        // Make sure we're working with the color-option-neo element
        const colorDiv = element.classList.contains('color-option-neo') 
            ? element 
            : element.closest('.color-option-neo');
            
        if (!colorDiv) {
            console.error('❌ Could not find color-option-neo element');
    return;
  }
  
        console.log('✓ Found colorDiv:', colorDiv);
        console.log('ColorDiv classes BEFORE:', colorDiv.className);
        
        // Remove active from ALL colors first
        const allColors = document.querySelectorAll('.color-option-neo');
        console.log('Total colors found:', allColors.length);
        
        allColors.forEach(function(opt, index) {
            const hadActive = opt.classList.contains('active');
            opt.classList.remove('active');
            console.log(`Color ${index + 1} (data-color=${opt.getAttribute('data-color')}): had active=${hadActive}, removed=${!opt.classList.contains('active')}`);
        });
        
        // Verify all removed
        const stillActiveCount = document.querySelectorAll('.color-option-neo.active').length;
        console.log('Active colors after removal:', stillActiveCount);
        
        // Add active to selected ONLY
        colorDiv.classList.add('active');
        console.log('ColorDiv classes AFTER adding active:', colorDiv.className);
        
        // Verify exactly one active
        const finalActiveCount = document.querySelectorAll('.color-option-neo.active').length;
        console.log('✓ Final active count:', finalActiveCount, '(should be 1)');
        
        if (finalActiveCount !== 1) {
            console.error('⚠️ WARNING: Active count is not 1!');
        }
        
        // Update hidden input
        const input = document.getElementById('selectedColor');
        if (input) {
            input.value = colorId;
            console.log('✓ Hidden input updated:', input.value);
      } else {
            console.error('❌ selectedColor input not found!');
        }
        
        // Update color name display
        const colorNames = {
            '1': 'Blue', '2': 'Green', '3': 'Red', '4': 'Yellow', '5': 'Purple',
            1: 'Blue', 2: 'Green', 3: 'Red', 4: 'Yellow', 5: 'Purple'
        };
        
        const nameElement = document.getElementById('selected-color-name');
        if (nameElement) {
            nameElement.textContent = colorNames[colorId] || 'Blue';
            console.log('✓ Color name updated:', colorNames[colorId]);
        }
        
        console.log('=== selectColor END ===\n');
        
    } catch (error) {
        console.error('❌ Error in selectColor:', error);
    }
};

console.log('✅ selectColor function defined globally');

// ========================================
// COLOR THEME HELPER - Convert color ID to gradient
// ========================================

window.getLessonColorGradient = function(colorId) {
    const colorMap = {
        '1': 'linear-gradient(135deg, #007bff, #0056b3)', // Blue
        '2': 'linear-gradient(135deg, #28a745, #1e7e34)', // Green
        '3': 'linear-gradient(135deg, #dc3545, #bd2130)', // Red
        '4': 'linear-gradient(135deg, #ffc107, #e0a800)', // Yellow
        '5': 'linear-gradient(135deg, #6f42c1, #5a32a3)', // Purple
        1: 'linear-gradient(135deg, #007bff, #0056b3)',
        2: 'linear-gradient(135deg, #28a745, #1e7e34)',
        3: 'linear-gradient(135deg, #dc3545, #bd2130)',
        4: 'linear-gradient(135deg, #ffc107, #e0a800)',
        5: 'linear-gradient(135deg, #6f42c1, #5a32a3)'
    };
    
    return colorMap[colorId] || colorMap[1]; // Default to blue
};

console.log('✅ getLessonColorGradient function defined globally');

document.addEventListener('DOMContentLoaded', function() {
    console.log('Class fragment: DOMContentLoaded');
    
    // Search functionality
    const searchInput = document.getElementById('lessonSearch');
    if (searchInput) {
        searchInput.addEventListener('input', window.filterLessons);
    }
    
    // Chip filters
    document.querySelectorAll('.chip-group .chip').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.chip-group .chip').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            window.filterLessons();
        });
    });
    
    // Edit lesson modal
    const editLessonModal = document.getElementById('editLessonModal');
    if (editLessonModal) {
        editLessonModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            if (button) {
                const id = button.getAttribute('data-lesson-id');
                const title = button.getAttribute('data-lesson-title');
                const description = button.getAttribute('data-lesson-description');
                const status = button.getAttribute('data-lesson-status');
                
                document.getElementById('edit-lesson-id').value = id;
                document.getElementById('edit-lesson-title').value = title;
                document.getElementById('edit-lesson-description').value = description;
                document.getElementById('edit-lesson-status').value = status || 'active';
            }
        });
    }
    
    // Setup Add Lesson Modal
    const addLessonModal = document.getElementById('addLessonModal');
    if (addLessonModal) {
        addLessonModal.addEventListener('shown.bs.modal', function() {
            console.log('Add Lesson Modal shown, setting up preview...');
            setupAddLessonPreview();
        });
        
        addLessonModal.addEventListener('hidden.bs.modal', function() {
            // Reset form when modal is closed
            const form = document.getElementById('add-lesson-form');
            if (form) {
                form.reset();
                form.classList.remove('was-validated');
            }
        });
    }
    
    // Setup Add Lesson Form Submission
    const addLessonForm = document.getElementById('add-lesson-form');
    if (addLessonForm) {
        addLessonForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!addLessonForm.checkValidity()) {
                e.stopPropagation();
                addLessonForm.classList.add('was-validated');
    return;
  }
  
            const formData = new FormData(addLessonForm);
            
            fetch('/partial/class/add', {
    method: 'POST',
                body: formData,
    headers: {
                    'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addLessonModal'));
                    if (modal) {
                        modal.hide();
                    }
                    loadPage('class');
    } else {
                    alert(data.message || 'Error creating lesson');
    }
  })
  .catch(error => {
                console.error('Error:', error);
                alert('Error creating lesson');
            });
        });
    }
});

function setupAddLessonPreview() {
    // Setup input listeners with debouncing
    const titleInput = document.getElementById('lesson-title');
    const descriptionInput = document.getElementById('lesson-description');
    const authorInput = document.getElementById('lesson-author');
    const statusSelect = document.getElementById('lesson-status');
    
    function updatePreview() {
        const title = titleInput?.value || 'Your Lesson Title';
        const description = descriptionInput?.value || 'Your lesson description will appear here...';
        const author = authorInput?.value || 'Unknown Author';
        const status = statusSelect?.value || 'active';
        
        const previewTitle = document.getElementById('previewTitle');
        const previewDescription = document.getElementById('previewDescription');
        const previewAuthor = document.getElementById('previewAuthor');
        const previewStatus = document.getElementById('previewStatus');
        
        if (previewTitle) previewTitle.textContent = title;
        if (previewDescription) previewDescription.textContent = description;
        if (previewAuthor) previewAuthor.innerHTML = '<i class="bi bi-person me-1"></i>' + author;
        if (previewStatus) {
            previewStatus.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            previewStatus.className = 'badge rounded-pill small';
            if (status === 'active') previewStatus.classList.add('bg-primary');
            else if (status === 'completed') previewStatus.classList.add('bg-success');
            else if (status === 'archived') previewStatus.classList.add('bg-warning');
        }
    }
    
    // Add event listeners with immediate feedback
    if (titleInput) {
        titleInput.addEventListener('input', updatePreview);
        titleInput.addEventListener('keyup', updatePreview);
    }
    if (descriptionInput) {
        descriptionInput.addEventListener('input', updatePreview);
        descriptionInput.addEventListener('keyup', updatePreview);
    }
    if (authorInput) {
        authorInput.addEventListener('input', updatePreview);
        authorInput.addEventListener('keyup', updatePreview);
    }
    if (statusSelect) {
        statusSelect.addEventListener('change', updatePreview);
    }
    
    // Initial update
    updatePreview();
}

// Attach all helper functions to window object for global access
window.filterLessons = function() {
    const searchTerm = document.getElementById('lessonSearch')?.value.toLowerCase() || '';
    const activeChip = document.querySelector('.chip-group .chip.active');
    const filterStatus = activeChip?.getAttribute('data-filter') || '';
    
    document.querySelectorAll('.lesson-item').forEach(item => {
        const title = item.querySelector('.card-title')?.textContent.toLowerCase() || '';
        const description = item.querySelector('.card-text')?.textContent.toLowerCase() || '';
        const status = item.getAttribute('data-status') || '';
        
        const matchesSearch = !searchTerm || title.includes(searchTerm) || description.includes(searchTerm);
        const matchesFilter = !filterStatus || status === filterStatus;
        
        item.style.display = (matchesSearch && matchesFilter) ? '' : 'none';
    });
};

window.toggleFavorite = function(lessonId, button) {
    console.log('Toggle favorite for lesson:', lessonId);
    button.classList.toggle('active');
    
    // TODO: Implement API call to toggle favorite
    fetch(`/partial/class/${lessonId}/favorite`, { 
    method: 'POST',
    headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
            console.log('Favorite toggled successfully');
    }
  })
  .catch(error => {
        console.error('Error toggling favorite:', error);
        // Keep the UI change even if API fails
    });
};

window.viewLesson = function(lessonId) {
    console.log('View lesson:', lessonId);
    // Navigate to lesson detail page
    if (typeof loadPage === 'function') {
        loadPage('class/' + lessonId);
    } else {
        window.location.href = '/class/' + lessonId;
    }
};

window.deleteLesson = function(lessonId) {
    if (confirm('Are you sure you want to delete this lesson?')) {
        console.log('Delete lesson:', lessonId);
        
        fetch(`/partial/class/${lessonId}/delete`, { 
    method: 'POST',
    headers: {
                'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
                // Reload the class page
                if (typeof loadPage === 'function') {
                    loadPage('class');
    } else {
                    window.location.reload();
                }
    } else {
                alert(data.message || 'Error deleting lesson');
    }
  })
  .catch(error => {
            console.error('Error deleting lesson:', error);
            alert('Error deleting lesson');
        });
    }
};
</script>

