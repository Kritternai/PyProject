<div class="container-fluid px-0" id="note-editor-page">
  <div class="d-flex align-items-center justify-content-between px-4 pt-3 pb-2 hero border-bottom">
    <div class="d-flex align-items-center gap-2">
      <button class="btn btn-light btn-sm btn-soft" onclick="loadPage('note')"><i class="bi bi-arrow-left"></i></button>
      <div class="d-flex align-items-center">
        <div class="hero-icon me-2"><i class="bi bi-journal-text"></i></div>
        <div>
          <h5 class="mb-0 text-white">Notes</h5>
          <div class="opacity-75 small text-white">Edit and organize your notes</div>
        </div>
      </div>
    </div>
    <div class="d-flex align-items-center gap-2">
      <button class="btn btn-outline-light btn-sm btn-soft" onclick="openNoteEditor()"><i class="bi bi-plus-lg me-1"></i>New</button>
    </div>
  </div>

  <div class="d-flex" style="height: calc(100vh - 120px);">
    <!-- Left: list -->
    <aside class="border-end sidebar-panel" style="width: 340px; min-width: 300px;">
      <div class="p-3 border-bottom glass-section">
        <label class="form-label section-title mb-2"><i class="bi bi-search me-1"></i>Search</label>
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input type="text" class="form-control" id="editorNoteSearch" placeholder="Search notes...">
        </div>
      </div>
      <div class="overflow-auto" style="height: 100%;" id="editorNotesList">
        {% if notes %}
          {% for note in notes %}
          <div class="p-3 border-bottom note-row neo-card-lite" role="button" onclick="loadEditorNote('{{ note.id }}')" data-note-id="{{ note.id }}">
            <div class="fw-semibold text-truncate"><i class="bi bi-journal-text me-1 text-primary"></i>{{ note.title }}</div>
            <div class="small text-muted text-truncate">{{ (note.content or '')|striptags }}</div>
            <div class="small text-muted"><i class="bi bi-calendar2-week me-1"></i>{{ note.created_at.strftime('%Y-%m-%d %H:%M') if note.created_at else '' }}</div>
          </div>
          {% endfor %}
        {% else %}
          <div class="text-center text-muted py-5">No notes yet</div>
        {% endif %}
      </div>
    </aside>

    <!-- Right: editor -->
    <section class="flex-grow-1 d-flex flex-column bg-white">
      <div class="p-3 border-bottom d-flex align-items-center gap-3 glass-section">
        <div class="w-100">
          <label class="form-label section-title mb-1"><i class="bi bi-type me-1"></i>Title</label>
          <input type="text" class="form-control form-control-lg" id="editorTitle" placeholder="Note title...">
        </div>
        <div class="d-flex align-items-end gap-2">
          <button class="btn btn-outline-secondary btn-soft" onclick="refreshEditorNote()" title="Refresh"><i class="bi bi-arrow-clockwise"></i></button>
          <button class="btn btn-primary btn-soft" onclick="saveEditorNote()"><i class="bi bi-save me-1"></i>Save</button>
        </div>
      </div>
      <div id="editorToolbar" class="p-2 border-bottom d-flex gap-1 flex-wrap glass-section">
        <button class="btn btn-sm btn-outline-secondary btn-soft" onclick="document.execCommand('bold')" title="Bold"><i class="bi bi-type-bold"></i></button>
        <button class="btn btn-sm btn-outline-secondary btn-soft" onclick="document.execCommand('italic')" title="Italic"><i class="bi bi-type-italic"></i></button>
        <button class="btn btn-sm btn-outline-secondary btn-soft" onclick="document.execCommand('underline')" title="Underline"><i class="bi bi-type-underline"></i></button>
        <div class="vr"></div>
        <button class="btn btn-sm btn-outline-secondary btn-soft" onclick="document.execCommand('insertUnorderedList')" title="Bulleted"><i class="bi bi-list-ul"></i></button>
        <button class="btn btn-sm btn-outline-secondary btn-soft" onclick="document.execCommand('insertOrderedList')" title="Numbered"><i class="bi bi-list-ol"></i></button>
        <div class="vr"></div>
        <button class="btn btn-sm btn-outline-secondary btn-soft" onclick="document.execCommand('justifyLeft')" title="Left"><i class="bi bi-text-left"></i></button>
        <button class="btn btn-sm btn-outline-secondary btn-soft" onclick="document.execCommand('justifyCenter')" title="Center"><i class="bi bi-text-center"></i></button>
        <button class="btn btn-sm btn-outline-secondary btn-soft" onclick="document.execCommand('justifyRight')" title="Right"><i class="bi bi-text-right"></i></button>
      </div>
      <div id="editorContent" class="flex-grow-1 p-3 overflow-auto glass-editor" contenteditable="true" style="outline:none;">
      </div>
      <div class="p-2 border-top small text-muted d-flex justify-content-between glass-section">
        <span id="editorStatus">Ready</span>
        <span>Ctrl+S to save</span>
      </div>
    </section>
  </div>
</div>

<script>
(function(){
  const selected = '{{ selected_note_id or '' }}';
  if (selected) {
    loadEditorNote(selected);
  }
  const search = document.getElementById('editorNoteSearch');
  if (search) {
    search.addEventListener('input', function(){
      const term = this.value.toLowerCase();
      document.querySelectorAll('#editorNotesList .note-row').forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = !term || text.includes(term) ? '' : 'none';
      });
    });
  }
  // Ctrl+S to save
  document.addEventListener('keydown', function(e){
    if ((e.ctrlKey || e.metaKey) && (e.key === 's' || e.key === 'S')) {
      e.preventDefault();
      saveEditorNote();
    }
  });
})();

window.loadEditorNote = function(noteId){
  const status = document.getElementById('editorStatus');
  if (status) status.textContent = 'Loading...';
  fetch(`/partial/note/${noteId}/data`, { headers: { 'X-Requested-With': 'XMLHttpRequest' }})
    .then(r => r.json())
    .then(j => {
      if (j && j.success && j.data){
        document.getElementById('editorTitle').value = j.data.title || '';
        document.getElementById('editorContent').innerHTML = j.data.content || '';
        document.getElementById('editorStatus').textContent = 'Loaded';
        window.currentEditingNoteId = j.data.id;
      } else {
        document.getElementById('editorStatus').textContent = 'Load failed';
      }
    })
    .catch(()=>{ if (status) status.textContent = 'Load error'; });
}

window.refreshEditorNote = function(){
  if (window.currentEditingNoteId) loadEditorNote(window.currentEditingNoteId);
}

window.saveEditorNote = function(){
  const title = document.getElementById('editorTitle').value || '';
  const content = document.getElementById('editorContent').innerHTML || '';
  const status = document.getElementById('editorStatus');
  const id = window.currentEditingNoteId;
  const form = new FormData();
  form.append('title', title);
  form.append('content', content);
  if (!id) {
    // create new
    fetch('/partial/note/add', { method: 'POST', body: form, headers: { 'X-Requested-With':'XMLHttpRequest' }})
      .then(r => r.json())
      .then(j => {
        if (j && j.success){
          document.getElementById('editorStatus').textContent = 'Saved';
          // reload list quietly
          fetch('/partial/note').then(r=>r.text()).then(html=>{
            const temp = document.createElement('div'); temp.innerHTML = html; const list = temp.querySelector('#note-list-container');
            // Also refresh this page's list area from our existing notes context route
          });
          // If server returned new id, navigate to that id in editor
          if (j.note_id){ window.currentEditingNoteId = j.note_id; }
        } else {
          if (status) status.textContent = j.message || 'Save failed';
        }
      })
      .catch(()=>{ if (status) status.textContent = 'Save error'; });
  } else {
    fetch(`/partial/note/${id}/edit`, { method: 'POST', body: form, headers: { 'X-Requested-With':'XMLHttpRequest' }})
      .then(r=>r.json())
      .then(j=>{
        if (j && j.success) {
          if (status) status.textContent = 'Saved';
        } else { if (status) status.textContent = j.message || 'Save failed'; }
      })
      .catch(()=>{ if (status) status.textContent = 'Save error'; });
  }
}
</script>

<style>
.root, :root { --slh-primary:#003B8E; --slh-primary-2:#2B6BCF; --slh-primary-3:#002862; }
#note-editor-page .note-row:hover { background:#f8f9fa; }
.hero { background: linear-gradient(135deg, var(--slh-primary-2), var(--slh-primary)); color:#fff; }
.hero .hero-icon { width:36px; height:36px; border-radius:10px; background: rgba(255,255,255,.2); display:flex; align-items:center; justify-content:center; color:#fff; }
.glass-section { background: rgba(255,255,255,0.55); border:1px solid rgba(0,0,0,.05); box-shadow: 6px 6px 12px rgba(0,0,0,0.06), -4px -4px 10px rgba(255,255,255,0.9); border-radius:12px; }
.section-title { font-weight:600; color:#334155; }
.btn-soft { border-radius:12px; box-shadow: 6px 6px 12px rgba(0,0,0,0.08), -4px -4px 10px rgba(255,255,255,0.9); border:1px solid rgba(0,0,0,0.04); }
.neo-card-lite { background: linear-gradient(180deg, #ffffff 0%, #f8fbff 100%); border-radius:10px; }
.sidebar-panel { background: linear-gradient(180deg, #ffffff 0%, #f7f9fc 100%); }
.glass-editor { background: radial-gradient(1200px circle at 10% 10%, rgba(255,255,255,.6), rgba(255,255,255,.4) 40%, rgba(255,255,255,.25) 70%); }
</style>


