<!-- Load shared note styles -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/note_style/note_shared.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/note_style/tag_badges.css') }}">

<div class="container-fluid ng-font note-section-top-0 note-sticky-container" id="note-add-page"
  style="padding-left: 1.5rem; padding-right: 1.5rem; max-width: 1200px; margin: 0 auto; padding-top: 0;">
  <!-- Header Section -->
  <div class="px-4 pb-2 note-header d-flex align-items-center justify-content-between border-bottom note-sticky-header">
    <div class="gap-2 d-flex align-items-center">
      <button class="ng-btn ng-btn-sm btn-rounded-25" onclick="loadPage('note')" aria-label="Back to notes">
        <i class="bi bi-arrow-left"></i>
      </button>
      <div class="d-flex align-items-center">
        <div class="hero-icon me-2"><i class="bi bi-journal-plus note-icon-md"></i></div>
        <div>
          <h5 class="mb-0 ng-title">Create New Note</h5>
          <div class="ng-subtitle">Write and format your new note</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="bg-white d-flex flex-column ng-space"
    style="margin-left: 0.5rem; margin-right: 0.5rem; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
    <!-- Title Input Section -->
    <div class="p-4 mt-16 border-bottom ui-surface glass-panel" style="border-radius: 12px 12px 0 0;">
      <label class="mb-2 form-label section-title"><i class="bi bi-type"></i>Title</label>
      <input type="text" class="form-control form-control-lg ng-input" id="addTitle" name="title"
        placeholder="Enter note title..." maxlength="200" required>

      <!-- Status and Tags Section -->
      <div class="mt-3 row g-3">
        <div class="col-md-6">
          <label class="mb-2 form-label section-title"><i class="bi bi-ui-checks-grid"></i>Status</label>
          <select class="form-select ng-input" id="addNoteStatus" name="status">
            <option value="pending">Pending</option>
            <option value="in-progress">In Progress</option>
            <option value="completed">Completed</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="mb-2 form-label section-title"><i class="bi bi-tags"></i>Tags</label>
          <input type="text" class="form-control ng-input" id="addNoteTags" name="tags"
            placeholder="e.g. work, study, important" maxlength="100">
          <div class="form-text small">Separate tags with commas</div>
        </div>
      </div>
    </div>

    <!-- Rich Text Toolbar -->
    <div class="p-3 mx-4 mt-3 mb-2 border-0 editor-toolbar ui-toolbar glass-panel" style="border-radius: 8px;">
      <div class="flex-wrap gap-2 d-flex align-items-center">
        <!-- Text Formatting -->
        <button class="btn btn-sm ng-chip" onclick="formatText('bold')" title="Bold (Ctrl+B)">
          <i class="bi bi-type-bold"></i>
        </button>
        <button class="btn btn-sm ng-chip" onclick="formatText('italic')" title="Italic (Ctrl+I)">
          <i class="bi bi-type-italic"></i>
        </button>
        <button class="btn btn-sm ng-chip" onclick="formatText('underline')" title="Underline (Ctrl+U)">
          <i class="bi bi-type-underline"></i>
        </button>
        <button class="btn btn-sm ng-chip" onclick="formatText('strikeThrough')" title="Strikethrough">
          <i class="bi bi-type-strikethrough"></i>
        </button>
        <div class="vr"></div>
        <!-- Lists -->
        <button class="btn btn-sm ng-chip" onclick="insertList('ul')" title="Bullet List">
          <i class="bi bi-list-ul"></i>
        </button>
        <button class="btn btn-sm ng-chip" onclick="insertList('ol')" title="Numbered List">
          <i class="bi bi-list-ol"></i>
        </button>
        <div class="vr"></div>
        <!-- Alignment -->
        <button class="btn btn-sm ng-chip" onclick="alignText('justifyLeft')" title="Align Left">
          <i class="bi bi-text-left"></i>
        </button>
        <button class="btn btn-sm ng-chip" onclick="alignText('justifyCenter')" title="Align Center">
          <i class="bi bi-text-center"></i>
        </button>
        <button class="btn btn-sm ng-chip" onclick="alignText('justifyRight')" title="Align Right">
          <i class="bi bi-text-right"></i>
        </button>
        <div class="vr"></div>
        <!-- Media & Links -->
        <button class="btn btn-sm ng-chip" onclick="insertImage()" title="Insert Image">
          <i class="bi bi-image"></i>
        </button>
        <button class="btn btn-sm ng-chip" onclick="insertLink()" title="Insert Link">
          <i class="bi bi-link"></i>
        </button>
        <button class="btn btn-sm ng-chip" onclick="insertTable()" title="Insert Table">
          <i class="bi bi-table"></i>
        </button>
        <div class="vr"></div>
        <!-- Undo/Redo -->
        <button class="btn btn-sm ng-chip" onclick="undoAction()" title="Undo (Ctrl+Z)">
          <i class="bi bi-arrow-counterclockwise"></i>
        </button>
        <button class="btn btn-sm ng-chip" onclick="redoAction()" title="Redo (Ctrl+Y)">
          <i class="bi bi-arrow-clockwise"></i>
        </button>
      </div>
    </div>

    <!-- Editor Content -->
    <div id="addContent" class="p-5 mx-4 mb-3 overflow-auto flex-grow-1 editor-card glass-panel" contenteditable="true"
      style="outline:none; border-radius: 8px; min-height: 400px;" aria-label="Note content editor" role="textbox"
      data-placeholder="Start writing your note here...">
      <em class="text-muted"></em>
    </div>

    <!-- File Upload Section -->
    <div class="p-4 mx-4 mb-3 border-top border-bottom ui-surface glass-panel">
      <label class="mb-2 form-label section-title"><i class="bi bi-paperclip"></i>Attachments</label>
      <div class="file-upload-section" onclick="document.getElementById('addFileInput').click()">
        <i class="mb-2 bi bi-cloud-upload note-icon-xl d-block"></i>
        <p class="mb-2"><strong>Click to upload</strong> or drag and drop</p>
        <p class="mb-0 small text-muted">PDF, DOC, DOCX, JPG, PNG, GIF (Max 10MB)</p>
      </div>
      <input type="file" id="addFileInput" class="d-none" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif" multiple>
      <div id="addFilePreviewContainer" class="mt-3"></div>
    </div>

    <!-- Action Buttons Section -->
    <div class="p-3 mx-4 mb-3 d-flex justify-content-between align-items-center glass-section">
      <button class="ng-btn ng-btn-sm btn-rounded-25" onclick="clearNote()" title="Clear all">
        <i class="bi bi-x-circle"></i>Clear
      </button>
      <button class="ng-btn-save btn-rounded-25" onclick="saveNewNote()">
        <i class="bi bi-save"></i>Save Note
      </button>
    </div>

    <!-- Status Bar -->
    <div
      class="p-3 mx-4 mb-4 border-top small text-muted d-flex justify-content-between align-items-center glass-section ng-glass ng-rounded"
      style="border-radius: 0 0 12px 12px;">
      <div class="save-status unsaved" id="addSaveStatus">
        <i class="bi bi-exclamation-circle"></i>
        <span>Unsaved changes</span>
      </div>
      <span class="ng-body">Ctrl+S to save</span>
    </div>
  </div>
</div>

<!-- Script loaded dynamically via main.js for SPA compatibility -->
<!-- See: app/static/js/note_js/note_add.js -->

<script>
  // Fallback initialization for non-SPA mode
  (function () {
    console.log('[note_add_fragment] Script tag executed');

    // Check if we need to load the script manually (non-SPA mode)
    if (!window.saveNewNote) {
      console.log('[note_add_fragment] saveNewNote not found, loading script...');
      const script = document.createElement('script');
      script.src = '/static/js/note_js/note_add.js?v=' + Date.now();
      script.onload = () => {
        console.log('[note_add_fragment] Script loaded successfully');
      };
      document.head.appendChild(script);
    } else {
      console.log('[note_add_fragment] Functions already loaded');
      // Re-initialize if already loaded
      if (window.initializeNoteAdd) {
        window.initializeNoteAdd();
      }
    }
  })();
</script>