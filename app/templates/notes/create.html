<div class="modal-header">
    <h5 class="modal-title" id="addNoteModalLabel">Add New Note</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<form hx-post="/partial/note/add" hx-target="#main-content" hx-swap="innerHTML" hx-encoding="multipart/form-data"
    class="needs-validation" novalidate hx-disabled-elt="button[type='submit']" hx-indicator="#addNoteSavingIndicator">
    <div class="modal-body">
        <div class="p-3 mb-3 border bg-light rounded-3">
            <div class="row align-items-start g-3">
                <div class="col">
                    <label for="title" class="form-label">Title</label>
                    <input type="text" class="form-control" id="title" name="title" placeholder="Enter a concise title"
                        aria-describedby="titleHelp titleCounter" maxlength="80" required>
                    <div class="d-flex justify-content-between">
                        <div id="titleHelp" class="form-text">Keep it short and clear.</div>
                        <div class="form-text" id="titleCounter">0/80</div>
                    </div>
                    <div class="invalid-feedback">Please provide a title.</div>
                </div>
                <div class="col-auto text-center">
                    <div id="imagePlaceholder"
                        class="border rounded-circle bg-light d-flex align-items-center justify-content-center"
                        style="width:72px;height:72px;">
                        <i class="bi bi-camera-fill text-secondary" data-bs-toggle="tooltip"
                            title="Add a cover photo"></i>
                    </div>
                    <img id="imagePreview" class="border rounded-circle d-none"
                        style="width:72px;height:72px;object-fit:cover;" alt="Preview">
                    <div class="mt-2 small text-muted">Add Photo</div>
                    <button type="button" class="mt-1 btn btn-sm btn-warning"
                        onclick="document.getElementById('image').click()">
                        <i class="bi bi-camera-fill me-1"></i>Choose
                    </button>
                </div>
            </div>
            <div class="mt-3">
                <label for="content" class="form-label">Content</label>
                <textarea class="form-control" id="content" name="content" rows="5"
                    placeholder="Write your note here..." aria-describedby="contentHelp contentCounter" maxlength="2000"
                    required></textarea>
                <div class="d-flex justify-content-between">
                    <div id="contentHelp" class="form-text">Describe the details. You can add links and files below.
                    </div>
                    <div class="form-text" id="contentCounter">0/2000</div>
                </div>
                <div class="invalid-feedback">Please add some content.</div>
            </div>
        </div>
        <div class="p-3 mb-3 border bg-light rounded-3">
            <div class="row">
                <div class="mb-3 col-md-6">
                    <label for="tags" class="form-label">Tags</label>
                    <div class="input-group">
                        <span class="input-group-text" data-bs-toggle="tooltip" title="Comma-separated tags"><i
                                class="bi bi-hash"></i></span>
                        <input type="text" class="form-control" id="tags" name="tags" placeholder="e.g. math, homework"
                            aria-describedby="tagsHelp" autocomplete="off">
                    </div>
                    <div id="tagsHelp" class="form-text">Separate multiple tags with commas.</div>
                </div>
                <div class="mb-3 col-md-6">
                    <label for="status" class="form-label">Status</label>
                    <div class="input-group">
                        <span class="input-group-text" data-bs-toggle="tooltip" title="Current status"><i
                                class="bi bi-ui-checks-grid"></i></span>
                        <select class="form-select" id="status" name="status" aria-describedby="statusHelp statusBadge">
                            <option value="pending">Pending</option>
                            <option value="in-progress">In Progress</option>
                            <option value="completed">Completed</option>
                        </select>
                        <span class="bg-transparent border-0 input-group-text"><span id="statusBadge"
                                class="badge bg-secondary">Pending</span></span>
                    </div>
                    <div id="statusHelp" class="form-text">Track your progress.</div>
                </div>
            </div>
        </div>
        <div class="p-3 mb-3 border bg-light rounded-3">
            <label for="external_link" class="form-label">External Link</label>
            <div class="input-group">
                <span class="input-group-text" data-bs-toggle="tooltip" title="Paste a reference URL"><i
                        class="bi bi-link-45deg"></i></span>
                <input type="url" class="form-control" id="external_link" name="external_link"
                    placeholder="https://example.com" aria-describedby="linkHelp">
            </div>
            <div id="linkHelp" class="form-text">Optional reference link (must be a valid URL).</div>
            <div class="invalid-feedback">Please enter a valid URL.</div>
        </div>
        <div class="p-3 mb-3 border bg-light rounded-3">
            <label for="image" class="form-label">Image</label>
            <input class="form-control d-none" type="file" id="image" name="image" accept="image/*"
                aria-describedby="imageHelp">
            <div id="imageHelp" class="form-text">PNG, JPG or GIF.</div>
            <div class="mt-3">
                <label for="file" class="form-label">File Attachment</label>
                <div class="input-group">
                    <span class="input-group-text" data-bs-toggle="tooltip" title="Attach a file"><i
                            class="bi bi-paperclip"></i></span>
                    <input class="form-control" type="file" id="file" name="file" aria-describedby="fileHelp">
                </div>
                <div id="fileHelp" class="form-text">Attach any supporting files (optional).</div>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <div id="addNoteSavingIndicator" class="me-2 d-none">
            <div class="spinner-border spinner-border-sm text-primary" role="status" aria-hidden="true"></div>
            <span class="visually-hidden">Saving...</span>
        </div>
        <button type="submit" class="btn btn-primary">
            <span class="me-1"><i class="fas fa-save"></i></span>Save Note
        </button>
    </div>
</form>

<script>
    // This script will be evaluated by HTMX after the form is submitted successfully
    (function () {
        var modal = bootstrap.Modal.getInstance(document.getElementById('addNoteModal'));
        if (modal) {
            modal.hide();
        }
    })();
    // Bootstrap 5 client-side validation
    (function () {
        const form = document.querySelector('#addNoteModal form');
        if (!form) return;
        form.addEventListener('submit', function (event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        }, false);
        // counters
        const title = document.getElementById('title');
        const titleCounter = document.getElementById('titleCounter');
        const content = document.getElementById('content');
        const contentCounter = document.getElementById('contentCounter');
        function updateCounter(input, counter) { if (!input || !counter) return; counter.textContent = `${input.value.length}/${input.maxLength}`; }
        ['input', 'change'].forEach(evt => {
            title?.addEventListener(evt, () => updateCounter(title, titleCounter));
            content?.addEventListener(evt, () => updateCounter(content, contentCounter));
        });
        updateCounter(title, titleCounter); updateCounter(content, contentCounter);
        // status badge color
        const status = document.getElementById('status');
        const badge = document.getElementById('statusBadge');
        function setBadge() {
            if (!status || !badge) return; const v = status.value; badge.textContent = v.replace('-', ' ');
            badge.className = 'badge';
            if (v === 'completed') badge.classList.add('bg-success');
            else if (v === 'in-progress') badge.classList.add('bg-warning');
            else badge.classList.add('bg-secondary');
        }
        status?.addEventListener('change', setBadge); setBadge();
        // tooltips
        document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));
    })();
    
    // Reset modal when opened
    const addModalEl = document.getElementById('addNoteModal');
    if (addModalEl) {
        addModalEl.addEventListener('shown.bs.modal', function() {
            // Reset form
            const form = document.querySelector('#addNoteModal form');
            if (form) {
                form.reset();
                form.classList.remove('was-validated');
            }
            
            // Clear image preview
            const img = document.getElementById('imagePreview');
            const ph = document.getElementById('imagePlaceholder');
            if (img) {
                img.src = '';
                img.classList.add('d-none');
            }
            if (ph) {
                ph.classList.remove('d-none');
            }
            
            // Reset counters
            const titleCounter = document.getElementById('titleCounter');
            const contentCounter = document.getElementById('contentCounter');
            if (titleCounter) titleCounter.textContent = '0/80';
            if (contentCounter) contentCounter.textContent = '0/2000';
            
            // Reset status badge
            const statusSelect = document.getElementById('status');
            const statusBadge = document.getElementById('statusBadge');
            if (statusSelect && statusBadge) {
                statusSelect.value = 'pending';
                statusBadge.textContent = 'Pending';
                statusBadge.className = 'badge bg-secondary';
            }
            
            // Focus on title field
            const titleField = document.getElementById('title');
            if (titleField) titleField.focus();
        });
    }
    
    // Image preview
    document.getElementById('image')?.addEventListener('change', function (e) {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function (evt) {
            const img = document.getElementById('imagePreview');
            const ph = document.getElementById('imagePlaceholder');
            if (img && evt.target && evt.target.result) {
                img.src = evt.target.result;
                img.classList.remove('d-none');
            }
            if (ph) ph.classList.add('d-none');
        };
        reader.readAsDataURL(file);
    });
</script>