<!-- Load shared note styles -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/note_style/note_shared.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/note_style/tag_badges.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/note_style/note_editor_layout.css') }}">

<div class="px-0 container-fluid ng-font note-section-top-0" id="note-editor-page" data-selected-note-id="{{ selected_note_id or '' }}">
  <div class="px-4 pt-2 pb-2 note-header d-flex align-items-center justify-content-between border-bottom note-header-top-0">
    <div class="gap-2 d-flex align-items-center">
      <button class="ng-btn ng-btn-sm btn-rounded-25" onclick="loadPage('note')" aria-label="Back to notes"><i class="bi bi-arrow-left"></i></button>
      <div class="d-flex align-items-center">
        <div class="hero-icon me-2"><i class="bi bi-journal-text note-icon-md"></i></div>
        <div>
          <h5 class="mb-0 ng-title">Notes</h5>
          <div class="ng-subtitle">Edit and organize your notes</div>
        </div>
      </div>
    </div>
    <div class="gap-2 d-flex align-items-center">
      <button class="ng-btn-primary ng-btn-sm btn-rounded-25" onclick="clearEditorForNew()" title="Create new note"><i class="bi bi-plus-lg"></i>New</button>
    </div>
  </div>

  <div class="d-flex" id="editorSplit">
    <!-- Left: list -->
    <aside class="border-end sidebar-panel glass-dark" style="width: 300px; min-width: 260px; border-radius: 25px;">
      <div class="p-3 border-bottom glass-section ng-space">
        <label class="mb-2 form-label section-title"><i class="bi bi-search"></i>Search</label>
        <div class="input-group search-bar-modern">
          <span class="bg-white input-group-text border-end-0">
            <i class="bi bi-search text-muted"></i>
          </span>
          <input type="text" class="form-control border-start-0 ng-input" id="editorNoteSearch" placeholder="Search notes..." aria-label="Search notes">
        </div>
      </div>
      <div class="overflow-auto" id="editorNotesList">
        {% if notes %}
          {% for note in notes %}
          <div class="p-3 note-row neo-card-lite ng-neo" role="button" onclick="loadEditorNote('{{ note.id }}')" data-note-id="{{ note.id }}">
            <div class="d-flex align-items-start mb-2">
              <i class="bi bi-journal-text note-icon-primary me-2 mt-1"></i>
              <div class="fw-semibold text-truncate flex-grow-1">{{ note.title }}</div>
            </div>
            <div class="small text-muted text-truncate mb-2" style="padding-left: 24px;">
              {{ (note.content or '')|striptags|truncate(60) }}
            </div>
            <div class="small text-muted d-flex align-items-center" style="padding-left: 24px;">
              <i class="bi bi-calendar2-week me-1"></i>
              {{ note.created_at.strftime('%Y-%m-%d') if note.created_at else '' }}
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="py-5 text-center text-muted">No notes yet</div>
        {% endif %}
      </div>
    </aside>

    <!-- Right: editor -->
    <section class="bg-white flex-grow-1 d-flex flex-column ng-space">
      <div class="p-3 border-bottom ui-surface glass-panel">
        <label class="mb-1 form-label section-title"><i class="bi bi-type"></i>Title</label>
        <input type="text" class="form-control form-control-lg ng-input" id="editorTitle" placeholder="Note title..." aria-label="Note title">
        
        <!-- Status and Tags Section -->
        <div class="row mt-3 g-3">
          <div class="col-md-6">
            <label class="mb-2 form-label section-title"><i class="bi bi-ui-checks-grid"></i>Status</label>
            <select class="form-select ng-input" id="editorNoteStatus" name="status">
              <option value="pending">Pending</option>
              <option value="in-progress">In Progress</option>
              <option value="completed">Completed</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="mb-2 form-label section-title"><i class="bi bi-tags"></i>Tags</label>
            <input type="text" 
                   class="form-control ng-input" 
                   id="editorNoteTags" 
                   name="tags" 
                   placeholder="e.g. work, study, important" 
                   maxlength="100">
            <div class="form-text small">Separate tags with commas</div>
          </div>
        </div>
      </div>
      <div class="p-2 mx-2 mt-2 mb-1 border-0 editor-toolbar ui-toolbar glass-panel">
        <div class="flex-wrap gap-2 d-flex align-items-center">
          <!-- Text Formatting -->
          <button class="btn btn-sm ng-chip" onclick="formatText('bold')" title="Bold (Ctrl+B)">
            <i class="bi bi-type-bold"></i>
          </button>
          <button class="btn btn-sm ng-chip" onclick="formatText('italic')" title="Italic (Ctrl+I)">
            <i class="bi bi-type-italic"></i>
          </button>
          <button class="btn btn-sm ng-chip" onclick="formatText('underline')" title="Underline (Ctrl+U)">
            <i class="bi bi-type-underline"></i>
          </button>
          <button class="btn btn-sm ng-chip" onclick="formatText('strikeThrough')" title="Strikethrough">
            <i class="bi bi-type-strikethrough"></i>
          </button>
          <div class="vr"></div>
          <!-- Lists -->
          <button class="btn btn-sm ng-chip" onclick="insertList('ul')" title="Bullet List">
            <i class="bi bi-list-ul"></i>
          </button>
          <button class="btn btn-sm ng-chip" onclick="insertList('ol')" title="Numbered List">
            <i class="bi bi-list-ol"></i>
          </button>
          <div class="vr"></div>
          <!-- Alignment -->
          <button class="btn btn-sm ng-chip" onclick="alignText('justifyLeft')" title="Align Left">
            <i class="bi bi-text-left"></i>
          </button>
          <button class="btn btn-sm ng-chip" onclick="alignText('justifyCenter')" title="Align Center">
            <i class="bi bi-text-center"></i>
          </button>
          <button class="btn btn-sm ng-chip" onclick="alignText('justifyRight')" title="Align Right">
            <i class="bi bi-text-right"></i>
          </button>
          <div class="vr"></div>
          <!-- Media & Links -->
          <button class="btn btn-sm ng-chip" onclick="insertImage()" title="Insert Image">
            <i class="bi bi-image"></i>
          </button>
          <button class="btn btn-sm ng-chip" onclick="insertLink()" title="Insert Link">
            <i class="bi bi-link"></i>
          </button>
          <button class="btn btn-sm ng-chip" onclick="insertTable()" title="Insert Table">
            <i class="bi bi-table"></i>
          </button>
          <div class="vr"></div>
          <!-- Undo/Redo -->
          <button class="btn btn-sm ng-chip" onclick="undoAction()" title="Undo (Ctrl+Z)">
            <i class="bi bi-arrow-counterclockwise"></i>
          </button>
          <button class="btn btn-sm ng-chip" onclick="redoAction()" title="Redo (Ctrl+Y)">
            <i class="bi bi-arrow-clockwise"></i>
          </button>
        </div>
      </div>
      <div id="editorContent" class="p-4 mx-2 mb-2 overflow-auto flex-grow-1 editor-card glass-panel" contenteditable="true" style="outline:none;"
           aria-label="Note content editor" role="textbox">
      </div>
      
      <!-- File Upload Section -->
      <div class="p-3 mx-2 mb-2 border-top border-bottom ui-surface glass-panel">
        <label class="mb-2 form-label section-title"><i class="bi bi-paperclip"></i>Attachments</label>
        <div class="file-upload-section" onclick="document.getElementById('editorFileInput').click()">
          <i class="bi bi-cloud-upload note-icon-xl mb-2 d-block"></i>
          <p class="mb-2"><strong>Click to upload</strong> or drag and drop</p>
          <p class="small text-muted mb-0">PDF, DOC, DOCX, JPG, PNG, GIF (Max 10MB)</p>
        </div>
        <input type="file" id="editorFileInput" class="d-none" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif" multiple>
        <div id="editorFilePreviewContainer" class="mt-3"></div>
      </div>
      
      <!-- Action Buttons Section -->
      <div class="p-2 mx-2 mb-2 d-flex justify-content-between align-items-center glass-section">
        <button class="ng-chip btn-rounded-25" onclick="refreshEditorNote()" title="Refresh" aria-label="Refresh">
          <i class="bi bi-arrow-clockwise"></i>Refresh
        </button>
        <button class="ng-btn-save btn-rounded-25" onclick="saveEditorNote()">
          <i class="bi bi-save"></i>Save
        </button>
      </div>
      
      <div class="p-2 border-top small text-muted d-flex justify-content-between align-items-center glass-section ng-glass ng-rounded">
        <div class="save-status unsaved" id="editorSaveStatus">
          <i class="bi bi-exclamation-circle"></i>
          <span>Unsaved changes</span>
        </div>
        <span class="ng-body">Ctrl+S to save</span>
      </div>
    </section>
  </div>
</div>

<!-- Script loaded dynamically via main.js for SPA compatibility -->
<!-- See: app/static/js/note_js/note_editor.js -->

<script>
// Fallback initialization for non-SPA mode
(function() {
  console.log('[note_editor_fragment] Script tag executed');
  
  // Check if we need to load the script manually (non-SPA mode)
  if (!window.loadEditorNote) {
    console.log('[note_editor_fragment] loadEditorNote not found, loading script...');
    const script = document.createElement('script');
    script.src = '/static/js/note_js/note_editor.js?v=' + Date.now();
    script.onload = () => {
      console.log('[note_editor_fragment] Script loaded successfully');
    };
    document.head.appendChild(script);
  } else {
    console.log('[note_editor_fragment] Functions already loaded');
    // Re-initialize if already loaded
    if (window.initializeNoteEditor) {
      window.initializeNoteEditor();
    }
  }
})();
</script>

<!-- All styles moved to external CSS files for consistency -->
<!-- note_shared.css: Main design system -->
<!-- note_editor_layout.css: Editor-specific layout -->

