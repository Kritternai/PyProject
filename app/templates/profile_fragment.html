<!-- Profile Edit Fragment -->
<div class="container-fluid" style="padding: 2rem;">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="bi bi-person-circle me-2"></i>แก้ไขโปรไฟล์
            </h2>
            
            {% if user and user.password_hash == 'oauth_google' %}
            <!-- Privacy Notice for Google OAuth Users -->
            <div class="alert alert-info mb-4">
                <h5 class="alert-heading">
                    <i class="bi bi-shield-check me-2"></i>ความเป็นส่วนตัวของคุณได้รับการปกป้อง
                </h5>
                <p class="mb-2">
                    <strong>ระบบไม่ได้เก็บข้อมูลส่วนตัวจริงของคุณจาก Google:</strong>
                </p>
                <ul class="mb-2">
                    <li>❌ ไม่เก็บอีเมลจริงของคุณ</li>
                    <li>❌ ไม่เก็บชื่อจริงของคุณจาก Google</li>
                    <li>✅ ใช้ระบบอีเมลภายในแทน ({{ user.email }})</li>
                    <li>✅ คุณสามารถตั้งชื่อแสดงได้เอง</li>
                </ul>
                <hr>
                <p class="mb-0">
                    <small>คุณสามารถแก้ไขชื่อและนามสกุลที่ต้องการแสดงในระบบได้ด้านล่าง</small>
                </p>
            </div>   
            {% endif %}
        </div>
    </div>
    
    <!-- Profile Edit Form -->
    <div class="row">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-person-gear me-2"></i>ข้อมูลส่วนตัว
                    </h5>
                </div>
                <div class="card-body">
                    <form id="profile-edit-form">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">ชื่อจริง <small class="text-muted">(First Name)</small></label>
                                <input type="text" class="form-control" id="first_name" 
                                       value="{{ user.first_name if user and user.first_name else '' }}" 
                                       placeholder="John (ควรใช้ภาษาอังกฤษ)">
                                <div class="form-text">แนะนำให้ใช้ชื่อภาษาอังกฤษเพื่อการแสดงผลที่ดี</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">นามสกุล <small class="text-muted">(Last Name)</small></label>
                                <input type="text" class="form-control" id="last_name" 
                                       value="{{ user.last_name if user and user.last_name else '' }}" 
                                       placeholder="Doe (ควรใช้ภาษาอังกฤษ)">
                                <div class="form-text">แนะนำให้ใช้นามสกุลภาษาอังกฤษเพื่อการแสดงผลที่ดี</div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">ชื่อผู้ใช้ (Username)</label>
                            <input type="text" class="form-control" id="username" 
                                   value="{{ user.username if user else '' }}" 
                                   placeholder="john_doe หรือ กันต์ฤทัย"
                                   {% if user and user.password_hash == 'oauth_google' %}readonly{% endif %}>
                            <div class="form-text">
                                {% if user and user.password_hash == 'oauth_google' %}
                                    ชื่อผู้ใช้จาก Google OAuth (ไม่สามารถแก้ไขได้)
                                {% else %}
                                    ชื่อผู้ใช้ที่จะแสดงในระบบ สามารถเป็นภาษาไทยหรือภาษาอังกฤษก็ได้
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">อีเมล <small class="text-muted">(ระบบภายใน)</small></label>
                            <div class="input-group">
                                <input type="email" class="form-control" id="email" 
                                       value="{{ user.email if user else '' }}" 
                                       placeholder="username@internal.system"
                                       {% if user and user.password_hash == 'oauth_google' %}readonly{% endif %}>
                                <span class="input-group-text">
                                    {% if user and user.password_hash == 'oauth_google' %}
                                        <i class="bi bi-shield-lock text-primary" title="ระบบภายใน - ไม่สามารถแก้ไขได้"></i>
                                    {% elif user and user.email_verified %}
                                        <i class="bi bi-check-circle-fill text-success" title="อีเมลยืนยันแล้ว"></i>
                                    {% else %}
                                        <i class="bi bi-exclamation-circle text-warning" title="อีเมลยังไม่ได้ยืนยัน"></i>
                                    {% endif %}
                                </span>
                            </div>
                            {% if user and user.password_hash == 'oauth_google' %}
                                <div class="form-text text-info">
                                    <i class="bi bi-google me-1"></i>บัญชี Google OAuth - ใช้อีเมลระบบภายใน (ไม่เก็บอีเมลจริง)
                                </div>  
                            {% else %}
                                <div class="form-text">สำหรับระบบภายใน ไม่ใช่อีเมลจริง</div>  
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">รูปโปรไฟล์</label>
                            <div class="d-flex align-items-center mb-2">
                                {% if user and user.profile_image %}
                                    <img src="{{ user.profile_image }}" alt="Profile" class="rounded-circle me-3" 
                                         style="width: 60px; height: 60px; object-fit: cover;">
                                {% else %}
                                    <div class="rounded-circle bg-light d-flex align-items-center justify-content-center me-3" 
                                         style="width: 60px; height: 60px;">
                                        <i class="bi bi-person-fill text-muted"></i>
                                    </div>
                                {% endif %}
                                <div>
                                    <input type="file" class="form-control form-control-sm" id="profile_image" 
                                           accept="image/*" style="max-width: 250px;">
                                    <div class="form-text">รองรับ JPG, PNG ขนาดไม่เกิน 5MB</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">บทนำตัว <small class="text-muted">(Bio)</small></label>
                            <textarea class="form-control" id="bio" rows="3" 
                                      placeholder="Computer Science Student หรือ นักเรียนคณะวิศวกรรมศาสตร์">{{ user.bio if user and user.bio else '' }}</textarea>
                            <div class="form-text">สามารถเขียนเป็นภาษาไทยหรือภาษาอังกฤษก็ได้</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">สถานะบัญชี</label>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="bg-light p-2 rounded">
                                        <small class="text-muted">ประเภทผู้ใช้</small><br>
                                        <span class="badge bg-info">{{ user.role|default('Student')|title }}</span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="bg-light p-2 rounded">
                                        <small class="text-muted">สมาชิกตั้งแต่</small><br>
                                        <small>{{ user.created_at.strftime('%d/%m/%Y') if user and user.created_at else 'ไม่ระบุ' }}</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="bg-light p-2 rounded">
                                        <small class="text-muted">เข้าสู่ระบบล่าสุด</small><br>
                                        <small>{{ user.last_login.strftime('%d/%m/%Y') if user and user.last_login else 'ไม่ระบุ' }}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <!-- Action Buttons -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="button" class="btn btn-secondary" onclick="loadPage('setting')">
                                <i class="bi bi-x-circle me-2"></i>ยกเลิก
                            </button>
                            <button type="button" class="btn btn-outline-warning" onclick="resetForm()">
                                <i class="bi bi-arrow-clockwise me-2"></i>รีเซ็ต
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle me-2"></i>บันทึกการเปลี่ยนแปลง
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Profile Preview Card -->
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-eye me-2"></i>ตัวอย่างโปรไฟล์
                    </h5>
                </div>
                <div class="card-body text-center">
                    <div id="preview-profile-image" class="mb-3">
                        {% if user and user.profile_image %}
                            <img src="{{ user.profile_image }}" alt="Profile Preview" class="rounded-circle" 
                                 style="width: 100px; height: 100px; object-fit: cover;">
                        {% else %}
                            <div class="rounded-circle bg-light d-flex align-items-center justify-content-center mx-auto" 
                                 style="width: 100px; height: 100px;">
                                <i class="bi bi-person-fill text-muted" style="font-size: 3rem;"></i>
                            </div>
                        {% endif %}
                    </div>
                    <h5 id="preview-name" class="mb-1">
                        {% if user and (user.first_name or user.last_name) %}
                            {{ user.first_name or '' }} {{ user.last_name or '' }}
                        {% else %}
                            ไม่ได้ระบุชื่อ
                        {% endif %}
                    </h5>
                    <p id="preview-username" class="text-muted mb-2">
                        @{{ user.username if user else 'username' }}
                    </p>
                    <p id="preview-bio" class="small">
                        {{ user.bio if user and user.bio else 'ยังไม่มีบทนำตัว' }}
                    </p>
                    <div class="mt-3">
                        <span class="badge bg-secondary">{{ user.role|default('Student')|title }}</span>
                        {% if user and user.email_verified %}
                            <span class="badge bg-success">ยืนยันแล้ว</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Profile Statistics -->
            <div class="card shadow-sm mt-3">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-graph-up me-2"></i>สถิติการใช้งาน
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            <h5 class="text-primary">{{ user.total_lessons if user else 0 }}</h5>
                            <small class="text-muted">บทเรียน</small>
                        </div>
                        <div class="col-4">
                            <h5 class="text-success">{{ user.total_notes if user else 0 }}</h5>
                            <small class="text-muted">บันทึก</small>
                        </div>
                        <div class="col-4">
                            <h5 class="text-warning">{{ user.total_tasks if user else 0 }}</h5>
                            <small class="text-muted">งาน</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Profile edit functionality
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('profile-edit-form');
    const profileImageInput = document.getElementById('profile_image');
    
    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        saveProfile();
    });
    
    // Real-time preview updates
    ['first_name', 'last_name', 'username', 'bio'].forEach(field => {
        document.getElementById(field).addEventListener('input', updatePreview);
    });
    
    // Profile image preview
    profileImageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewImg = document.getElementById('preview-profile-image');
                previewImg.innerHTML = `<img src="${e.target.result}" alt="Profile Preview" class="rounded-circle" 
                                      style="width: 100px; height: 100px; object-fit: cover;">`;
            };
            reader.readAsDataURL(file);
        }
    });
});

function updatePreview() {
    const firstName = document.getElementById('first_name').value;
    const lastName = document.getElementById('last_name').value;
    const username = document.getElementById('username').value;
    const bio = document.getElementById('bio').value;
    
    // Update name preview
    const fullName = `${firstName} ${lastName}`.trim();
    document.getElementById('preview-name').textContent = fullName || 'ไม่ได้ระบุชื่อ';
    
    // Update username preview
    document.getElementById('preview-username').textContent = username ? `@${username}` : '@username';
    
    // Update bio preview
    document.getElementById('preview-bio').textContent = bio || 'ยังไม่มีบทนำตัว';
}

function resetForm() {
    if (confirm('คุณต้องการรีเซ็ตข้อมูลทั้งหมดหรือไม่?')) {
        document.getElementById('profile-edit-form').reset();
        updatePreview();
    }
}

async function saveProfile() {
    const formData = new FormData();
    const profileImage = document.getElementById('profile_image').files[0];
    
    // Collect form data
    const profileData = {
        first_name: document.getElementById('first_name').value,
        last_name: document.getElementById('last_name').value,
        username: document.getElementById('username').value,
        email: document.getElementById('email').value,
        bio: document.getElementById('bio').value
    };
    
    try {
        // Show loading state
        const submitBtn = document.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>กำลังบันทึก...';
        submitBtn.disabled = true;
        
        // Send profile data
        const response = await fetch('/api/users/current/profile', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(profileData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Show success message
            showAlert('โปรไฟล์บันทึกเรียบร้อยแล้ว!', 'success');
            
            // Update UI with new data if needed
            setTimeout(() => {
                loadPage('setting'); // Navigate back to settings
            }, 1500);
        } else {
            showAlert(result.message || 'เกิดข้อผิดพลาดในการบันทึก', 'danger');
        }
        
    } catch (error) {
        console.error('Profile save error:', error);
        showAlert('เกิดข้อผิดพลาดในการเชื่อมต่อกับเซิร์ฟเวอร์', 'danger');
    } finally {
        // Restore button state
        const submitBtn = document.querySelector('button[type="submit"]');
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
}

function showAlert(message, type) {
    // Create alert element
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alert);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 3000);
}
</script>