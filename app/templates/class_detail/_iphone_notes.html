<!-- iPhone-style Notes System -->
<div class="iphone-notes-container" style="background: #f2f2f7; min-height: 100vh; padding: 0;">
    
    <!-- Notes Header -->
    <div class="notes-header" style="background: white; border-bottom: 1px solid #e5e5ea; padding: 16px 20px; position: sticky; top: 0; z-index: 100;">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <button class="btn btn-link p-0 me-3" onclick="toggleNotesSidebar()" style="color: #007AFF;">
                    <i class="bi bi-list" style="font-size: 1.2rem;"></i>
                </button>
                <h4 class="mb-0 fw-semibold" style="color: #1d1d1f;">Notes</h4>
            </div>
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-link p-0" onclick="searchNotes()" style="color: #007AFF;">
                    <i class="bi bi-search" style="font-size: 1.1rem;"></i>
                </button>
                <button class="btn btn-link p-0" onclick="createNewNote()" style="color: #007AFF;">
                    <i class="bi bi-plus" style="font-size: 1.1rem;"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Notes Content Area -->
    <div class="notes-content-area d-flex" style="height: calc(100vh - 80px);">
        
        <!-- Notes List Sidebar -->
        <div class="notes-sidebar" id="notesSidebar" style="width: 320px; background: white; border-right: 1px solid #e5e5ea; overflow-y: auto;">
            
            <!-- Search Bar -->
            <div class="p-3 border-bottom">
                <div class="input-group" style="border-radius: 10px; overflow: hidden; background: #f2f2f7;">
                    <span class="input-group-text bg-transparent border-0">
                        <i class="bi bi-search text-muted"></i>
                    </span>
                    <input type="text" class="form-control border-0 bg-transparent" placeholder="Search notes..." 
                           id="notesSearch" onkeyup="searchNotesList(this.value)">
                </div>
            </div>

            <!-- Notes List -->
            <div class="notes-list" id="notesList">
                <!-- Notes will be loaded here -->
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-journal-text" style="font-size: 3rem; opacity: 0.3;"></i>
                    <p class="mt-3">No notes yet</p>
                    <button class="btn btn-primary btn-sm" onclick="createNewNote()">
                        <i class="bi bi-plus me-1"></i>Create Note
                    </button>
                </div>
            </div>
        </div>

        <!-- Note Editor -->
        <div class="note-editor flex-grow-1 d-flex flex-column" id="noteEditor" style="background: white;">
            
            <!-- Editor Header -->
            <div class="editor-header border-bottom p-3" style="background: #f8f9fa;">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center gap-3">
                        <button class="btn btn-link p-0" onclick="toggleNotesSidebar()" style="color: #007AFF;">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <div>
                            <input type="text" class="form-control border-0 bg-transparent fw-semibold" 
                                   id="noteTitle" placeholder="Note title..." style="font-size: 1.1rem;">
                        </div>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <button class="btn btn-link p-0" onclick="shareNote()" style="color: #007AFF;">
                            <i class="bi bi-share"></i>
                        </button>
                        <button class="btn btn-link p-0" onclick="deleteNote()" style="color: #ff3b30;">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Rich Text Editor -->
            <div class="editor-toolbar border-bottom p-2" style="background: #f8f9fa;">
                <div class="d-flex gap-1 flex-wrap">
                    <!-- Text Formatting -->
                    <button class="btn btn-sm btn-outline-secondary" onclick="formatText('bold')" title="Bold (Ctrl+B)">
                        <i class="bi bi-type-bold"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="formatText('italic')" title="Italic (Ctrl+I)">
                        <i class="bi bi-type-italic"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="formatText('underline')" title="Underline (Ctrl+U)">
                        <i class="bi bi-type-underline"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="formatText('strikeThrough')" title="Strikethrough">
                        <i class="bi bi-type-strikethrough"></i>
                    </button>
                    
                    <div class="vr"></div>
                    
                    <!-- Lists -->
                    <button class="btn btn-sm btn-outline-secondary" onclick="insertList('ul')" title="Bullet List">
                        <i class="bi bi-list-ul"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="insertList('ol')" title="Numbered List">
                        <i class="bi bi-list-ol"></i>
                    </button>
                    
                    <div class="vr"></div>
                    
                    <!-- Alignment -->
                    <button class="btn btn-sm btn-outline-secondary" onclick="alignText('justifyLeft')" title="Align Left">
                        <i class="bi bi-text-left"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="alignText('justifyCenter')" title="Align Center">
                        <i class="bi bi-text-center"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="alignText('justifyRight')" title="Align Right">
                        <i class="bi bi-text-right"></i>
                    </button>
                    
                    <div class="vr"></div>
                    
                    <!-- Media & Links -->
                    <button class="btn btn-sm btn-outline-secondary" onclick="insertImage()" title="Insert Image">
                        <i class="bi bi-image"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="insertLink()" title="Insert Link">
                        <i class="bi bi-link"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="insertTable()" title="Insert Table">
                        <i class="bi bi-table"></i>
                    </button>
                    
                    <div class="vr"></div>
                    
                    <!-- Undo/Redo -->
                    <button class="btn btn-sm btn-outline-secondary" onclick="undoAction()" title="Undo (Ctrl+Z)">
                        <i class="bi bi-arrow-counterclockwise"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="redoAction()" title="Redo (Ctrl+Y)">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>

            <!-- Editor Content -->
            <div class="editor-content flex-grow-1 p-4">
                <div id="noteContent" contenteditable="true" 
                     style="min-height: 400px; outline: none; font-size: 1rem; line-height: 1.6;"
                     placeholder="Start writing your note..."
                     oninput="autoSaveNote()">
                </div>
            </div>

            <!-- Editor Footer -->
            <div class="editor-footer border-top p-3" style="background: #f8f9fa;">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center gap-3">
                        <button class="btn btn-sm btn-outline-primary" onclick="saveNote()">
                            <i class="bi bi-check me-1"></i>Save
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="cancelEdit()">
                            <i class="bi bi-x me-1"></i>Cancel
                        </button>
                    </div>
                    <div class="text-muted small">
                        <span id="lastSaved">Not saved</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden File Input -->
<input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageUpload(this)">

<script>
// iPhone-style Notes JavaScript
let currentNoteId = null;
let autoSaveTimer = null;

// Initialize notes system
document.addEventListener('DOMContentLoaded', function() {
    loadNotesList();
    setupRichTextEditor();
});

// Load notes list
function loadNotesList() {
    const lessonId = '{{ lesson.id }}';
    console.log('üîß Loading notes list for lesson:', lessonId);
    
    fetch(`/class/${lessonId}/notes-list`)
        .then(response => response.text())
        .then(html => {
            document.getElementById('notesList').innerHTML = html;
            console.log('‚úÖ Notes list loaded');
        })
        .catch(error => {
            console.error('‚ùå Error loading notes list:', error);
        });
}

// Create new note
function createNewNote() {
    console.log('üîß Creating new note');
    currentNoteId = null;
    document.getElementById('noteTitle').value = '';
    document.getElementById('noteContent').innerHTML = '';
    document.getElementById('lastSaved').textContent = 'Not saved';
    
    // Focus on title
    document.getElementById('noteTitle').focus();
}

// Save note
function saveNote() {
    const title = document.getElementById('noteTitle').value.trim();
    const content = document.getElementById('noteContent').innerHTML;
    
    if (!title) {
        alert('Please enter a note title');
        return;
    }
    
    const lessonId = '{{ lesson.id }}';
    const formData = new FormData();
    formData.append('title', title);
    formData.append('content', content);
    formData.append('status', 'pending');
    
    const url = currentNoteId ? 
        `/class/${lessonId}/notes/${currentNoteId}/update` : 
        `/class/${lessonId}/notes/create`;
    
    fetch(url, {
        method: 'POST',
        body: formData
    })
    .then(response => response.text())
    .then(html => {
        console.log('‚úÖ Note saved successfully');
        document.getElementById('lastSaved').textContent = 'Saved';
        loadNotesList();
    })
    .catch(error => {
        console.error('‚ùå Error saving note:', error);
        alert('Error saving note');
    });
}

// Auto-save functionality
function autoSaveNote() {
    clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(() => {
        if (currentNoteId) {
            saveNote();
        }
    }, 2000);
}

// Rich text editor functions
function formatText(command) {
    console.log(`üîß Formatting text: ${command}`);
    const editor = document.getElementById('noteContent');
    
    // Ensure editor is focused
    editor.focus();
    
    // Check if text is selected
    const selection = window.getSelection();
    const selectedText = selection.toString();
    
    console.log(`üîß Selected text: "${selectedText}"`);
    
    if (selectedText) {
        // Apply formatting to selected text
        document.execCommand(command, false, null);
        console.log(`‚úÖ Applied ${command} to selected text`);
    } else {
        // If no text selected, insert formatted text
        if (command === 'bold') {
            document.execCommand('insertHTML', false, '<strong>Bold text</strong>');
        } else if (command === 'italic') {
            document.execCommand('insertHTML', false, '<em>Italic text</em>');
        } else if (command === 'underline') {
            document.execCommand('insertHTML', false, '<u>Underlined text</u>');
        } else if (command === 'strikeThrough') {
            document.execCommand('insertHTML', false, '<del>Strikethrough text</del>');
        }
        console.log(`‚úÖ Inserted ${command} text`);
    }
    
    // Update toolbar button states
    setTimeout(() => {
        updateToolbarState();
    }, 100);
}

function insertList(type) {
    console.log(`üîß Inserting ${type} list`);
    const editor = document.getElementById('noteContent');
    
    if (type === 'ul') {
        document.execCommand('insertHTML', false, '<ul><li>List item</li></ul>');
    } else {
        document.execCommand('insertHTML', false, '<ol><li>List item</li></ol>');
    }
    
    editor.focus();
}

function insertImage() {
    console.log('üîß Inserting image');
    document.getElementById('imageInput').click();
}

function insertLink() {
    console.log('üîß Inserting link');
    const url = prompt('Enter URL:');
    if (url) {
        const text = window.getSelection().toString() || 'Link text';
        document.execCommand('insertHTML', false, `<a href="${url}" target="_blank">${text}</a>`);
    }
}

function alignText(alignment) {
    console.log(`üîß Aligning text: ${alignment}`);
    document.execCommand(alignment, false, null);
    document.getElementById('noteContent').focus();
}

function insertTable() {
    console.log('üîß Inserting table');
    const tableHTML = `
        <table style="border-collapse: collapse; width: 100%; margin: 10px 0;">
            <tr>
                <td style="border: 1px solid #ddd; padding: 8px;">Cell 1</td>
                <td style="border: 1px solid #ddd; padding: 8px;">Cell 2</td>
            </tr>
            <tr>
                <td style="border: 1px solid #ddd; padding: 8px;">Cell 3</td>
                <td style="border: 1px solid #ddd; padding: 8px;">Cell 4</td>
            </tr>
        </table>
    `;
    document.execCommand('insertHTML', false, tableHTML);
    document.getElementById('noteContent').focus();
}

function undoAction() {
    console.log('üîß Undo action');
    document.execCommand('undo', false, null);
    document.getElementById('noteContent').focus();
}

function redoAction() {
    console.log('üîß Redo action');
    document.execCommand('redo', false, null);
    document.getElementById('noteContent').focus();
}

// Update toolbar button states based on current selection
function updateToolbarState() {
    const editor = document.getElementById('noteContent');
    
    // Ensure editor is focused
    editor.focus();
    
    // Check if bold is active
    const boldBtn = document.querySelector('button[onclick*="formatText(\'bold\')"]');
    if (boldBtn) {
        const isBold = document.queryCommandState('bold');
        boldBtn.classList.toggle('active', isBold);
        console.log(`üîß Bold state: ${isBold}`);
    }
    
    // Check if italic is active
    const italicBtn = document.querySelector('button[onclick*="formatText(\'italic\')"]');
    if (italicBtn) {
        const isItalic = document.queryCommandState('italic');
        italicBtn.classList.toggle('active', isItalic);
        console.log(`üîß Italic state: ${isItalic}`);
    }
    
    // Check if underline is active
    const underlineBtn = document.querySelector('button[onclick*="formatText(\'underline\')"]');
    if (underlineBtn) {
        const isUnderline = document.queryCommandState('underline');
        underlineBtn.classList.toggle('active', isUnderline);
        console.log(`üîß Underline state: ${isUnderline}`);
    }
    
    // Check if strikethrough is active
    const strikeBtn = document.querySelector('button[onclick*="formatText(\'strikeThrough\')"]');
    if (strikeBtn) {
        const isStrike = document.queryCommandState('strikeThrough');
        strikeBtn.classList.toggle('active', isStrike);
        console.log(`üîß Strikethrough state: ${isStrike}`);
    }
}

function handleImageUpload(input) {
    const file = input.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.style.maxWidth = '100%';
            img.style.height = 'auto';
            document.execCommand('insertHTML', false, img.outerHTML);
        };
        reader.readAsDataURL(file);
    }
}

// Toggle sidebar
function toggleNotesSidebar() {
    const sidebar = document.getElementById('notesSidebar');
    sidebar.style.display = sidebar.style.display === 'none' ? 'block' : 'none';
}

// Search notes
function searchNotesList(query) {
    const notes = document.querySelectorAll('.note-item');
    notes.forEach(note => {
        const title = note.querySelector('.note-title').textContent.toLowerCase();
        const content = note.querySelector('.note-preview').textContent.toLowerCase();
        const searchQuery = query.toLowerCase();
        
        if (title.includes(searchQuery) || content.includes(searchQuery)) {
            note.style.display = 'block';
        } else {
            note.style.display = 'none';
        }
    });
}

// Setup rich text editor
function setupRichTextEditor() {
    const editor = document.getElementById('noteContent');
    
    // Handle paste events
    editor.addEventListener('paste', function(e) {
        e.preventDefault();
        const text = (e.clipboardData || window.clipboardData).getData('text/plain');
        document.execCommand('insertText', false, text);
    });
    
    // Handle keyboard shortcuts
    editor.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
                case 'b':
                    e.preventDefault();
                    formatText('bold');
                    break;
                case 'i':
                    e.preventDefault();
                    formatText('italic');
                    break;
                case 'u':
                    e.preventDefault();
                    formatText('underline');
                    break;
                case 's':
                    e.preventDefault();
                    saveNote();
                    break;
                case 'z':
                    if (e.shiftKey) {
                        e.preventDefault();
                        redoAction();
                    } else {
                        e.preventDefault();
                        undoAction();
                    }
                    break;
                case 'y':
                    e.preventDefault();
                    redoAction();
                    break;
                case 'l':
                    e.preventDefault();
                    insertLink();
                    break;
                case 'k':
                    e.preventDefault();
                    insertLink();
                    break;
            }
        }
    });
    
    // Update toolbar state on selection change
    editor.addEventListener('mouseup', function() {
        setTimeout(updateToolbarState, 50);
    });
    editor.addEventListener('keyup', function() {
        setTimeout(updateToolbarState, 50);
    });
    editor.addEventListener('selectionchange', function() {
        setTimeout(updateToolbarState, 50);
    });
    
    // Handle text selection
    editor.addEventListener('selectstart', function() {
        console.log('üîß Text selection started');
    });
    
    editor.addEventListener('mouseup', function() {
        const selection = window.getSelection();
        const selectedText = selection.toString();
        console.log(`üîß Text selected: "${selectedText}"`);
        setTimeout(updateToolbarState, 100);
    });
    
    // Handle toolbar button clicks with better event handling
    document.addEventListener('click', function(e) {
        // Check if clicked element is a toolbar button or its child
        const button = e.target.closest('button[onclick]');
        if (!button) return;
        
        e.preventDefault();
        e.stopPropagation();
        
        const onclick = button.getAttribute('onclick');
        console.log(`üîß Button clicked: ${onclick}`);
        
        if (onclick.includes('formatText')) {
            const command = onclick.match(/'([^']+)'/)[1];
            console.log(`üîß Executing formatText: ${command}`);
            formatText(command);
        } else if (onclick.includes('insertList')) {
            const type = onclick.match(/'([^']+)'/)[1];
            insertList(type);
        } else if (onclick.includes('alignText')) {
            const alignment = onclick.match(/'([^']+)'/)[1];
            alignText(alignment);
        } else if (onclick.includes('insertImage')) {
            insertImage();
        } else if (onclick.includes('insertLink')) {
            insertLink();
        } else if (onclick.includes('insertTable')) {
            insertTable();
        } else if (onclick.includes('undoAction')) {
            undoAction();
        } else if (onclick.includes('redoAction')) {
            redoAction();
        }
    });
}
</script>

<style>
/* iPhone-style Notes CSS */
.iphone-notes-container {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.note-item {
    padding: 12px 16px;
    border-bottom: 1px solid #e5e5ea;
    cursor: pointer;
    transition: background-color 0.2s;
}

.note-item:hover {
    background-color: #f2f2f7;
}

.note-item.active {
    background-color: #007AFF;
    color: white;
}

.note-title {
    font-weight: 600;
    font-size: 0.95rem;
    margin-bottom: 4px;
    color: #1d1d1f;
}

.note-preview {
    font-size: 0.85rem;
    color: #8e8e93;
    line-height: 1.3;
    margin-bottom: 4px;
}

.note-date {
    font-size: 0.75rem;
    color: #8e8e93;
}

#noteContent:empty:before {
    content: attr(placeholder);
    color: #8e8e93;
    font-style: italic;
}

.editor-toolbar .btn {
    border-radius: 6px;
    border: 1px solid #d1d1d6;
    background: white;
    color: #1d1d1f;
}

.editor-toolbar .btn:hover {
    background: #f2f2f7;
}

.editor-toolbar .btn.active {
    background: #007AFF;
    color: white;
    border-color: #007AFF;
    box-shadow: 0 2px 4px rgba(0, 122, 255, 0.3);
}

.editor-toolbar .btn:hover {
    background: #f0f0f0;
    border-color: #007AFF;
    transform: translateY(-1px);
    transition: all 0.2s ease;
}

.editor-toolbar .btn:active {
    transform: translateY(0);
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

.editor-toolbar .vr {
    width: 1px;
    background-color: #d1d1d6;
    margin: 0 4px;
}

/* Rich text editor content styling */
#noteContent {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

#noteContent h1, #noteContent h2, #noteContent h3 {
    margin: 16px 0 8px 0;
    font-weight: 600;
}

#noteContent p {
    margin: 8px 0;
    line-height: 1.6;
}

#noteContent ul, #noteContent ol {
    margin: 8px 0;
    padding-left: 24px;
}

#noteContent li {
    margin: 4px 0;
}

#noteContent table {
    margin: 16px 0;
    border-collapse: collapse;
    width: 100%;
}

#noteContent table td {
    border: 1px solid #ddd;
    padding: 8px;
}

#noteContent a {
    color: #007AFF;
    text-decoration: none;
}

#noteContent a:hover {
    text-decoration: underline;
}

#noteContent img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    margin: 8px 0;
}
</style>
