<!-- Grades Tab - Complete Grade System with Calculator -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/grades.css') }}">

<div class="grades-container">
    <!-- Header with Actions -->
    <div class="grades-header">
        <div>
            <h2 class="grades-title">üìä Grades</h2>
            <p class="grades-subtitle">Track your performance and set goals</p>
        </div>
        <div class="grades-header-actions">
            <button class="btn-grades-secondary" onclick="openSetupModal()">
                <i class="bi bi-gear"></i>
                <span>Setup Grading</span>
            </button>
            <button class="btn-grades" onclick="openGoalCalculator()">
                <i class="bi bi-calculator"></i>
                <span>Goal Calculator</span>
            </button>
        </div>
    </div>

    <!-- Grade Summary Card -->
    <div class="grade-summary-card" id="grade-summary">
        <!-- Loading state -->
        <div class="text-center py-5">
            <div class="spinner-border text-white" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-white mt-2">Loading grade summary...</p>
        </div>
    </div>

    <!-- Grade Goals Section -->
    <div class="grade-goals-section">
        <h3 class="section-title">üéØ Grade Goals</h3>
        <div class="goals-grid" id="grade-goals">
            <!-- Dynamically loaded -->
        </div>
    </div>

    <!-- Category Breakdown -->
    <div class="category-breakdown-section">
        <h3 class="section-title">üìà Category Breakdown</h3>
        <div class="categories-grid" id="category-breakdown">
            <!-- Dynamically loaded -->
        </div>
    </div>

    <!-- Detailed Grades Table -->
    <div class="grades-table-section">
        <div class="grades-table-header">
            <h3 class="section-title">üìã All Assignments</h3>
            <div class="table-filters">
                <select class="form-select form-select-sm" id="category-filter" onchange="filterGrades()">
                    <option value="all">All Categories</option>
                </select>
                <input type="text" class="form-control form-control-sm" id="search-grades" 
                       placeholder="Search assignments..." oninput="searchGrades()">
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table grades-table">
                <thead>
                    <tr>
                        <th>Assignment</th>
                        <th>Category</th>
                        <th>Due Date</th>
                        <th>Score</th>
                        <th>Percentage</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="grades-table-body">
                    <!-- Dynamically loaded -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Goal Calculator Modal -->
<div class="modal fade" id="goalCalculatorModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üéØ Grade Goal Calculator</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="calculator-form">
                    <label class="form-label">I want to get a:</label>
                    <select class="form-select form-select-lg" id="target-grade" onchange="calculateGoal()">
                        <option value="">-- Select Target Grade --</option>
                        <option value="A">A (80-100%)</option>
                        <option value="B+">B+ (75-79%)</option>
                        <option value="B">B (70-74%)</option>
                        <option value="C+">C+ (65-69%)</option>
                        <option value="C">C (60-64%)</option>
                        <option value="D+">D+ (55-59%)</option>
                        <option value="D">D (50-54%)</option>
                    </select>
                    
                    <div class="calculator-result mt-4" id="calculator-result">
                        <!-- Result will be displayed here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Setup Grading Modal -->
<div class="modal fade" id="setupGradingModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‚öôÔ∏è Setup Grading System</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="setup-info alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <span>Configure your grading scale and categories according to your course syllabus.</span>
                </div>
                
                <!-- Step 1: Grading Scale -->
                <div class="setup-section">
                    <h6>Step 1: Grading Scale</h6>
                    <p class="text-muted">Default scale is set. You can customize it later.</p>
                    <div class="grading-scale-preview">
                        <span class="badge bg-success">A (80-100%)</span>
                        <span class="badge bg-primary">B+ (75-79%)</span>
                        <span class="badge bg-info">B (70-74%)</span>
                        <span class="badge bg-warning">C+ (65-69%)</span>
                        <span class="badge bg-secondary">C (60-64%)</span>
                        <span class="badge bg-secondary">D+ (55-59%)</span>
                        <span class="badge bg-secondary">D (50-54%)</span>
                        <span class="badge bg-danger">F (0-49%)</span>
                    </div>
                </div>
                
                <!-- Step 2: Categories -->
                <div class="setup-section mt-4">
                    <h6>Step 2: Grade Categories</h6>
                    <p class="text-muted">Add categories from your syllabus (weights must total 100%)</p>
                    
                    <div id="categories-list">
                        <!-- Categories will be added here -->
                    </div>
                    
                    <button class="btn btn-outline-primary btn-sm mt-2" onclick="addCategoryRow()">
                        <i class="bi bi-plus-circle"></i> Add Category
                    </button>
                    
                    <div class="mt-3">
                        <strong>Total Weight: <span id="total-weight">0</span>%</strong>
                        <div class="progress mt-2">
                            <div class="progress-bar" id="weight-progress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveGradingSetup()">
                    <i class="bi bi-check-circle"></i> Save Configuration
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Grades System - Immediately execute
(function() {
    'use strict';
    
    console.log('üéì Grades system loaded');
    
    const lessonId = '{{ lesson_id }}';
    let goalCalculatorModal, setupGradingModal;
    let categoriesData = [];
    let currentSummary = null;
    
    // Initialize
    initializeGradesSystem();
    
    function initializeGradesSystem() {
        console.log('üìä Initializing Grades System for lesson:', lessonId);
        
        // Initialize modals
        try {
            const goalModalEl = document.getElementById('goalCalculatorModal');
            const setupModalEl = document.getElementById('setupGradingModal');
            
            if (goalModalEl && typeof bootstrap !== 'undefined') {
                goalCalculatorModal = new bootstrap.Modal(goalModalEl);
            }
            if (setupModalEl && typeof bootstrap !== 'undefined') {
                setupGradingModal = new bootstrap.Modal(setupModalEl);
            }
        } catch (error) {
            console.error('Error initializing modals:', error);
        }
        
        // Load grade data
        loadGradeData();
    }
    
    async function loadGradeData() {
        try {
            // Check if grade config exists
            const configResponse = await fetch(`/grades/lessons/${lessonId}/config`);
            
            if (configResponse.status === 404) {
                // No config - show setup prompt
                showSetupPrompt();
                return;
            }
            
            // Load summary
            const summaryResponse = await fetch(`/grades/lessons/${lessonId}/summary`);
            const summaryData = await summaryResponse.json();
            
            if (summaryData.success) {
                currentSummary = summaryData.data;
                renderGradeSummary(summaryData.data);
                renderGoals(summaryData.data.goals);
                renderCategoryBreakdown(summaryData.data.category_breakdown);
            }
            
            // Load grades table
            const gradesResponse = await fetch(`/grades/lessons/${lessonId}/my-grades`);
            const gradesData = await gradesResponse.json();
            
            if (gradesData.success) {
                renderGradesTable(gradesData.data);
            }
            
            // Load categories for filter
            const categoriesResponse = await fetch(`/grades/lessons/${lessonId}/categories`);
            const categoriesResult = await categoriesResponse.json();
            
            if (categoriesResult.success) {
                categoriesData = categoriesResult.data;
                populateCategoryFilter(categoriesResult.data);
            }
            
        } catch (error) {
            console.error('Error loading grades:', error);
            showError('Failed to load grades');
        }
    }
    
    function showSetupPrompt() {
        const container = document.getElementById('grade-summary');
        container.innerHTML = `
            <div class="setup-prompt">
                <i class="bi bi-gear" style="font-size: 3rem; opacity: 0.5;"></i>
                <h3>Grade System Not Configured</h3>
                <p>Set up your grading scale and categories to start tracking grades</p>
                <button class="btn btn-primary btn-lg" onclick="openSetupModal()">
                    <i class="bi bi-gear"></i> Setup Grading System
                </button>
            </div>
        `;
        
        // Hide other sections
        document.getElementById('grade-goals').style.display = 'none';
        document.getElementById('category-breakdown').style.display = 'none';
        document.querySelector('.grades-table-section').style.display = 'none';
    }
    
    function renderGradeSummary(summary) {
        const gradeColors = {
            'A': '#10b981',
            'B+': '#3b82f6',
            'B': '#3b82f6',
            'C+': '#f59e0b',
            'C': '#f59e0b',
            'D+': '#f97316',
            'D': '#f97316',
            'F': '#ef4444'
        };
        
        const bgColor = gradeColors[summary.letter_grade] || '#667eea';
        
        const html = `
            <div class="grade-display" style="background: linear-gradient(135deg, ${bgColor} 0%, ${bgColor}dd 100%);">
                <div class="current-grade">
                    <div class="grade-letter">${summary.letter_grade}</div>
                    <div class="grade-gpa">GPA: ${summary.gpa.toFixed(2)}</div>
                </div>
                <div class="grade-details">
                    <div class="grade-percentage">
                        <span class="percentage-value">${summary.percentage}%</span>
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill" style="width: ${summary.percentage}%"></div>
                        </div>
                    </div>
                    <div class="grade-points">
                        <i class="bi bi-trophy"></i>
                        <span id="current-points">${summary.percentage}</span> / 100 points
                    </div>
                    <div class="grade-status ${summary.is_passing ? 'passing' : 'failing'}">
                        <i class="bi ${summary.is_passing ? 'bi-check-circle' : 'bi-exclamation-triangle'}"></i>
                        <span>${summary.is_passing ? 'Passing' : 'Needs Improvement'}</span>
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('grade-summary').innerHTML = html;
    }
    
    function renderGoals(goalsData) {
        const goals = goalsData.goals;
        const container = document.getElementById('grade-goals');
        
        let html = '';
        
        // Sort grades by target (highest first)
        const gradeOrder = ['A', 'B+', 'B', 'C+', 'C', 'D+', 'D', 'F'];
        const sortedGrades = Object.keys(goals).sort((a, b) => 
            gradeOrder.indexOf(a) - gradeOrder.indexOf(b)
        );
        
        for (const gradeLetter of sortedGrades) {
            const goal = goals[gradeLetter];
            let className = '';
            let icon = '';
            let message = '';
            
            if (goal.already_achieved) {
                className = 'achieved';
                icon = 'bi-check-circle-fill';
                message = goal.message;
            } else if (goal.achievable) {
                className = 'achievable';
                icon = 'bi-arrow-up-circle';
                message = goal.message;
            } else {
                className = 'not-achievable';
                icon = 'bi-x-circle';
                message = goal.message;
            }
            
            html += `
                <div class="goal-card ${className}">
                    <div class="goal-icon">
                        <i class="bi ${icon}"></i>
                    </div>
                    <div class="goal-content">
                        <div class="goal-grade">${gradeLetter}</div>
                        <div class="goal-message">${message}</div>
                    </div>
                </div>
            `;
        }
        
        container.innerHTML = html;
    }
    
    function renderCategoryBreakdown(breakdown) {
        const container = document.getElementById('category-breakdown');
        
        if (Object.keys(breakdown).length === 0) {
            container.innerHTML = '<div class="text-center text-muted py-4">No categories configured yet</div>';
            return;
        }
        
        let html = '';
        
        for (const categoryId in breakdown) {
            const category = breakdown[categoryId];
            
            html += `
                <div class="category-card">
                    <div class="category-header">
                        <div class="category-info">
                            <h4 class="category-name">${category.name}</h4>
                            <span class="category-weight">${category.weight}%</span>
                        </div>
                    </div>
                    <div class="category-body">
                        <div class="category-score">
                            <div class="score-display">
                                <span class="score-percentage">${category.percentage}%</span>
                                <span class="score-points">${category.earned} / ${category.possible} pts</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" style="width: ${category.percentage}%; background: ${category.color}"></div>
                            </div>
                        </div>
                        <div class="category-contribution">
                            Contributes: <strong>${category.weighted_score}%</strong> to final grade
                        </div>
                    </div>
                </div>
            `;
        }
        
        container.innerHTML = html;
    }
    
    function renderGradesTable(grades) {
        const tbody = document.getElementById('grades-table-body');
        
        if (grades.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted py-4">
                        No grades recorded yet
                    </td>
                </tr>
            `;
            return;
        }
        
        let html = '';
        
        for (const grade of grades) {
            const statusClass = grade.status === 'graded' ? 'graded' : 
                              grade.status === 'pending' ? 'pending' : 'missing';
            
            const statusText = grade.status === 'graded' ? 'Graded' :
                             grade.status === 'pending' ? 'Pending' : 'Missing';
            
            html += `
                <tr class="grade-row" data-category="${grade.category_name}">
                    <td>
                        <div class="assignment-cell">
                            <span class="assignment-name">${escapeHtml(grade.item_name)}</span>
                            ${grade.is_late ? '<span class="badge bg-warning ms-2">Late</span>' : ''}
                        </div>
                    </td>
                    <td>
                        <span class="badge" style="background: ${grade.category_color}">${grade.category_name}</span>
                    </td>
                    <td>${formatDate(grade.due_date)}</td>
                    <td>
                        ${grade.score !== null ? `${grade.score} / ${grade.points_possible}` : '--'}
                    </td>
                    <td>
                        ${grade.percentage !== null ? `<strong>${grade.percentage}%</strong>` : '--'}
                    </td>
                    <td>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </td>
                </tr>
            `;
        }
        
        tbody.innerHTML = html;
    }
    
    function populateCategoryFilter(categories) {
        const select = document.getElementById('category-filter');
        
        for (const category of categories) {
            const option = document.createElement('option');
            option.value = category.name;
            option.textContent = category.name;
            select.appendChild(option);
        }
    }
    
    // Modal functions
    function openGoalCalculator() {
        if (goalCalculatorModal) {
            goalCalculatorModal.show();
        }
    }
    
    function openSetupModal() {
        if (setupGradingModal) {
            setupGradingModal.show();
            initializeSetupForm();
        }
    }
    
    function initializeSetupForm() {
        // Initialize with one empty category row
        document.getElementById('categories-list').innerHTML = '';
        addCategoryRow();
    }
    
    let categoryRowIndex = 0;
    
    function addCategoryRow() {
        const container = document.getElementById('categories-list');
        const rowId = `category-row-${categoryRowIndex++}`;
        
        const row = document.createElement('div');
        row.className = 'category-row mb-3';
        row.id = rowId;
        row.innerHTML = `
            <div class="row g-2">
                <div class="col-md-4">
                    <input type="text" class="form-control" placeholder="Category name (e.g., Assignments)" 
                           data-field="name">
                </div>
                <div class="col-md-3">
                    <input type="number" class="form-control" placeholder="Weight %" min="0" max="100" 
                           data-field="weight" oninput="updateTotalWeight()">
                </div>
                <div class="col-md-3">
                    <input type="color" class="form-control form-control-color" value="#3B82F6" 
                           data-field="color">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-danger w-100" onclick="removeCategoryRow('${rowId}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        `;
        
        container.appendChild(row);
        updateTotalWeight();
    }
    
    function removeCategoryRow(rowId) {
        document.getElementById(rowId).remove();
        updateTotalWeight();
    }
    
    function updateTotalWeight() {
        const rows = document.querySelectorAll('.category-row');
        let total = 0;
        
        rows.forEach(row => {
            const weightInput = row.querySelector('[data-field="weight"]');
            const weight = parseFloat(weightInput.value) || 0;
            total += weight;
        });
        
        document.getElementById('total-weight').textContent = total.toFixed(0);
        document.getElementById('weight-progress').style.width = total + '%';
        
        // Change color based on total
        const progressBar = document.getElementById('weight-progress');
        if (total === 100) {
            progressBar.className = 'progress-bar bg-success';
        } else if (total > 100) {
            progressBar.className = 'progress-bar bg-danger';
        } else {
            progressBar.className = 'progress-bar bg-warning';
        }
    }
    
    async function saveGradingSetup() {
        try {
            // Validate total weight
            const totalWeight = parseFloat(document.getElementById('total-weight').textContent);
            if (totalWeight !== 100) {
                alert('Total weight must equal 100%');
                return;
            }
            
            // Default grading scale (Thai university standard)
            const gradingScale = {
                "A": {"min": 80, "max": 100, "gpa": 4.0},
                "B+": {"min": 75, "max": 79, "gpa": 3.5},
                "B": {"min": 70, "max": 74, "gpa": 3.0},
                "C+": {"min": 65, "max": 69, "gpa": 2.5},
                "C": {"min": 60, "max": 64, "gpa": 2.0},
                "D+": {"min": 55, "max": 59, "gpa": 1.5},
                "D": {"min": 50, "max": 54, "gpa": 1.0},
                "F": {"min": 0, "max": 49, "gpa": 0.0}
            };
            
            // Save config
            const configResponse = await fetch(`/grades/lessons/${lessonId}/config`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    grading_scale: gradingScale,
                    grading_type: 'percentage',
                    total_points: 100,
                    passing_grade: 'D',
                    passing_percentage: 50.0
                })
            });
            
            if (!configResponse.ok) {
                throw new Error('Failed to save configuration');
            }
            
            // Save categories
            const rows = document.querySelectorAll('.category-row');
            let categoryIndex = 0;
            
            for (const row of rows) {
                const name = row.querySelector('[data-field="name"]').value.trim();
                const weight = parseFloat(row.querySelector('[data-field="weight"]').value);
                const color = row.querySelector('[data-field="color"]').value;
                
                if (!name || !weight) continue;
                
                await fetch(`/grades/lessons/${lessonId}/categories`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        name: name,
                        weight: weight,
                        color: color,
                        order_index: categoryIndex++
                    })
                });
            }
            
            // Close modal and reload
            setupGradingModal.hide();
            showSuccess('Grading system configured successfully!');
            setTimeout(() => loadGradeData(), 500);
            
        } catch (error) {
            console.error('Error saving setup:', error);
            showError('Failed to save grading configuration');
        }
    }
    
    async function calculateGoal() {
        const targetGrade = document.getElementById('target-grade').value;
        
        if (!targetGrade) {
            document.getElementById('calculator-result').innerHTML = '';
            return;
        }
        
        try {
            const response = await fetch(`/grades/lessons/${lessonId}/goal-calculator`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({target_grade: targetGrade})
            });
            
            const data = await response.json();
            
            if (data.success) {
                const result = data.data;
                const goal = result.goal_info;
                
                let resultHtml = '';
                
                if (goal.already_achieved) {
                    resultHtml = `
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle-fill fs-3"></i>
                            <h5 class="mt-3">Great News!</h5>
                            <p class="mb-0">${goal.message}</p>
                        </div>
                    `;
                } else if (goal.achievable) {
                    resultHtml = `
                        <div class="alert alert-info">
                            <i class="bi bi-calculator fs-3"></i>
                            <h5 class="mt-3">You Can Do It!</h5>
                            <p>${goal.message}</p>
                            <hr>
                            <div class="goal-details">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <div class="goal-stat">
                                            <div class="stat-value">${goal.points_needed}</div>
                                            <div class="stat-label">Points Needed</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="goal-stat">
                                            <div class="stat-value">${goal.percentage_needed}%</div>
                                            <div class="stat-label">On Remaining Work</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    resultHtml = `
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle fs-3"></i>
                            <h5 class="mt-3">Not Achievable</h5>
                            <p class="mb-0">${goal.message}</p>
                        </div>
                    `;
                }
                
                document.getElementById('calculator-result').innerHTML = resultHtml;
            }
            
        } catch (error) {
            console.error('Error calculating goal:', error);
            showError('Failed to calculate goal');
        }
    }
    
    function filterGrades() {
        const categoryFilter = document.getElementById('category-filter').value;
        const rows = document.querySelectorAll('.grade-row');
        
        rows.forEach(row => {
            if (categoryFilter === 'all' || row.dataset.category === categoryFilter) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
    
    function searchGrades() {
        const searchTerm = document.getElementById('search-grades').value.toLowerCase();
        const rows = document.querySelectorAll('.grade-row');
        
        rows.forEach(row => {
            const assignmentName = row.querySelector('.assignment-name').textContent.toLowerCase();
            
            if (assignmentName.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
    
    function formatDate(dateString) {
        if (!dateString) return '--';
        
        const date = new Date(dateString);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const taskDate = new Date(date);
        taskDate.setHours(0, 0, 0, 0);
        
        const diffDays = Math.ceil((taskDate - today) / (1000 * 60 * 60 * 24));
        
        if (diffDays === 0) return 'Today';
        if (diffDays === 1) return 'Tomorrow';
        if (diffDays === -1) return 'Yesterday';
        
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }
    
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function showSuccess(message) {
        if (typeof window.showSuccess === 'function') {
            window.showSuccess(message);
        } else {
            alert(message);
        }
    }
    
    function showError(message) {
        if (typeof window.showError === 'function') {
            window.showError(message);
        } else {
            alert(message);
        }
    }
    
    // Expose functions globally
    window.openGoalCalculator = openGoalCalculator;
    window.openSetupModal = openSetupModal;
    window.calculateGoal = calculateGoal;
    window.addCategoryRow = addCategoryRow;
    window.removeCategoryRow = removeCategoryRow;
    window.updateTotalWeight = updateTotalWeight;
    window.saveGradingSetup = saveGradingSetup;
    window.filterGrades = filterGrades;
    window.searchGrades = searchGrades;
    
    console.log('‚úÖ Grades system initialized');
    
})();
</script>

