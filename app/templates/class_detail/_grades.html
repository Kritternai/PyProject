<!-- Grades Tab - Complete Grade System with Calculator -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/grades.css') }}">

<div class="grades-container">
    <!-- Header with Actions -->
    <div class="grades-header">
        <div>
            <h2 class="grades-title">üìä Grades</h2>
            <p class="grades-subtitle">Track your performance and set goals</p>
        </div>
        <div class="grades-header-actions">
            <button class="btn-grades-secondary" onclick="openSetupModal()">
                <i class="bi bi-gear"></i>
                <span>Setup Grading</span>
            </button>
            <button class="btn-grades" onclick="openGoalCalculator()">
                <i class="bi bi-calculator"></i>
                <span>Goal Calculator</span>
            </button>
        </div>
    </div>

    <!-- Grade Summary Card -->
    <div class="grade-summary-card" id="grade-summary">
        <!-- Loading state -->
        <div class="text-center py-5">
            <div class="spinner-border text-white" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-white mt-2">Loading grade summary...</p>
        </div>
    </div>

    <!-- Grade Goals Section -->
    <div class="grade-goals-section">
        <h3 class="section-title">üéØ Grade Goals</h3>
        <div class="goals-grid" id="grade-goals">
            <!-- Dynamically loaded -->
        </div>
    </div>

    <!-- Category Breakdown -->
    <div class="category-breakdown-section">
        <h3 class="section-title">üìà Category Breakdown</h3>
        <div class="categories-grid" id="category-breakdown">
            <!-- Dynamically loaded -->
        </div>
    </div>

    <!-- Detailed Grades Table -->
    <div class="grades-table-section">
        <div class="grades-table-header">
            <h3 class="section-title">üìã All Assignments</h3>
            <div class="d-flex gap-2 align-items-center">
                <button class="btn btn-primary btn-sm" onclick="openCreateGradeItemModal()">
                    <i class="bi bi-plus-circle"></i> Add Assignment
                </button>
                <select class="form-select form-select-sm" id="category-filter" onchange="filterGrades()">
                    <option value="all">All Categories</option>
                </select>
                <input type="text" class="form-control form-control-sm" id="search-grades" 
                       placeholder="Search assignments..." oninput="searchGrades()">
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table grades-table">
                <thead>
                    <tr>
                        <th>Assignment</th>
                        <th>Category</th>
                        <th>Due Date</th>
                        <th>Score</th>
                        <th>Percentage</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="grades-table-body">
                    <!-- Dynamically loaded -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create Grade Item Modal -->
<div class="modal fade" id="createGradeItemModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üìù Add Assignment/Exam</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="gradeItemForm">
                    <!-- Combined Assignment Name + Task Selector -->
                    <div class="mb-3">
                        <label class="form-label">
                            Assignment Name *
                            <i class="bi bi-info-circle text-muted" 
                               title="Select from existing tasks or type a new name"></i>
                        </label>
                        
                        <!-- Custom Dropdown Container -->
                        <div class="custom-combobox">
                            <input type="text" 
                                   class="form-control" 
                                   id="item-name" 
                                   placeholder="Type name or select from tasks..."
                                   oninput="handleAssignmentNameInput()"
                                   onfocus="showTaskDropdown()"
                                   autocomplete="off"
                                   required>
                            <i class="bi bi-chevron-down dropdown-icon" onclick="toggleTaskDropdown()"></i>
                            
                            <!-- Custom Dropdown Menu -->
                            <div class="custom-dropdown-menu" id="task-dropdown" style="display: none;">
                                <div class="dropdown-search">
                                    <i class="bi bi-search"></i>
                                    <input type="text" 
                                           id="task-search" 
                                           class="dropdown-search-input" 
                                           placeholder="Search tasks..."
                                           oninput="filterTaskDropdown()">
                                </div>
                                
                                <div class="dropdown-section">
                                    <div class="dropdown-section-header">
                                        <i class="bi bi-link-45deg"></i> Link to Existing Task
                                    </div>
                                    <div id="task-list" class="dropdown-items">
                                        <!-- Populated by JS -->
                                    </div>
                                </div>
                                
                                <div class="dropdown-divider"></div>
                                
                                <div class="dropdown-section">
                                    <div class="dropdown-section-header">
                                        <i class="bi bi-plus-circle"></i> Or Create New
                                    </div>
                                    <div class="dropdown-item create-new-hint" onclick="focusNameInput()">
                                        <i class="bi bi-pencil-fill"></i>
                                        <span>Type a new assignment name above</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <input type="hidden" id="item-linked-task-id">
                        <div class="task-link-status" id="task-link-hint">
                            <i class="bi bi-info-circle"></i>
                            <span>Type to create new, or select from existing tasks</span>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Category *</label>
                            <select class="form-select" id="item-category" required>
                                <option value="">-- Select Category --</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Points *</label>
                            <input type="number" class="form-control" id="item-points" min="0" step="0.5" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="item-description" rows="2"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Due Date</label>
                            <input type="date" class="form-control" id="item-due-date">
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="form-check mt-4">
                                <input type="checkbox" class="form-check-input" id="item-published" checked>
                                <label class="form-check-label">Publish immediately</label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveGradeItem()">
                    <i class="bi bi-check-circle"></i> Create Assignment
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Goal Calculator Modal -->
<div class="modal fade" id="goalCalculatorModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üéØ Grade Goal Calculator</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="calculator-form">
                    <label class="form-label">I want to get a:</label>
                    <select class="form-select form-select-lg" id="target-grade" onchange="calculateGoal()">
                        <option value="">-- Select Target Grade --</option>
                        <option value="A">A (80-100%)</option>
                        <option value="B+">B+ (75-79%)</option>
                        <option value="B">B (70-74%)</option>
                        <option value="C+">C+ (65-69%)</option>
                        <option value="C">C (60-64%)</option>
                        <option value="D+">D+ (55-59%)</option>
                        <option value="D">D (50-54%)</option>
                    </select>
                    
                    <div class="calculator-result mt-4" id="calculator-result">
                        <!-- Result will be displayed here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Setup Grading Modal -->
<div class="modal fade" id="setupGradingModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="setupModalTitle">‚öôÔ∏è Setup Grading System</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="setup-info alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <span>Configure your grading scale and categories according to your course syllabus.</span>
                </div>
                
                <!-- Step 1: Grading Scale -->
                <div class="setup-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">Step 1: Grading Scale</h6>
                        <button class="btn btn-sm btn-outline-secondary" onclick="toggleGradingScaleEdit()">
                            <i class="bi bi-pencil" id="edit-scale-icon"></i>
                            <span id="edit-scale-text">Edit Scale</span>
                        </button>
                    </div>
                    
                    <!-- Grading Scale Display (Read-only) -->
                    <div id="grading-scale-display">
                        <div class="grading-scale-preview" id="grading-scale-preview">
                            <span class="badge bg-success">A (80-100%)</span>
                            <span class="badge bg-primary">B+ (75-79%)</span>
                            <span class="badge bg-info">B (70-74%)</span>
                            <span class="badge bg-warning">C+ (65-69%)</span>
                            <span class="badge bg-secondary">C (60-64%)</span>
                            <span class="badge bg-secondary">D+ (55-59%)</span>
                            <span class="badge bg-secondary">D (50-54%)</span>
                            <span class="badge bg-danger">F (0-49%)</span>
                        </div>
                    </div>
                    
                    <!-- Grading Scale Editor (Editable) -->
                    <div id="grading-scale-editor" style="display: none;">
                        <p class="text-muted small">Edit the percentage ranges for each grade level</p>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Grade</th>
                                        <th>Min %</th>
                                        <th>Max %</th>
                                        <th>GPA</th>
                                    </tr>
                                </thead>
                                <tbody id="grading-scale-table">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-success" onclick="saveGradingScale()">
                                <i class="bi bi-check"></i> Save Scale
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="cancelGradingScaleEdit()">
                                <i class="bi bi-x"></i> Cancel
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="resetGradingScale()">
                                <i class="bi bi-arrow-counterclockwise"></i> Reset to Default
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Step 2: Categories -->
                <div class="setup-section mt-4">
                    <h6>Step 2: Grade Categories</h6>
                    <p class="text-muted">Add categories from your syllabus (weights must total 100%)</p>
                    
                    <div id="categories-list">
                        <!-- Categories will be added here -->
                    </div>
                    
                    <button class="btn btn-outline-primary btn-sm mt-2" onclick="addCategoryRow()">
                        <i class="bi bi-plus-circle"></i> Add Category
                    </button>
                    
                    <div class="mt-3">
                        <strong>Total Weight: <span id="total-weight">0</span>%</strong>
                        <div class="progress mt-2">
                            <div class="progress-bar" id="weight-progress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="me-auto">
                    <button type="button" class="btn btn-danger" id="clearConfigBtn" onclick="clearGradingConfig()" style="display: none;">
                        <i class="bi bi-trash"></i> Clear All Configuration
                    </button>
                </div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveGradingSetup()">
                    <i class="bi bi-check-circle"></i> <span id="saveSetupBtnText">Save Configuration</span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Grades System - Immediately execute
(function() {
    'use strict';
    
    console.log('üéì Grades system loaded');
    
    const lessonId = '{{ lesson_id }}';
    let goalCalculatorModal, setupGradingModal, createGradeItemModal;
    let categoriesData = [];
    let currentSummary = null;
    let currentGradingScale = null;
    let isEditMode = false;
    let availableTasks = [];
    
    // Initialize
    initializeGradesSystem();
    
    function initializeGradesSystem() {
        console.log('üìä Initializing Grades System for lesson:', lessonId);
        
        // Initialize modals
        try {
            const goalModalEl = document.getElementById('goalCalculatorModal');
            const setupModalEl = document.getElementById('setupGradingModal');
            const createItemModalEl = document.getElementById('createGradeItemModal');
            
            if (goalModalEl && typeof bootstrap !== 'undefined') {
                goalCalculatorModal = new bootstrap.Modal(goalModalEl);
            }
            if (setupModalEl && typeof bootstrap !== 'undefined') {
                setupGradingModal = new bootstrap.Modal(setupModalEl);
            }
            if (createItemModalEl && typeof bootstrap !== 'undefined') {
                createGradeItemModal = new bootstrap.Modal(createItemModalEl);
            }
        } catch (error) {
            console.error('Error initializing modals:', error);
        }
        
        // Load grade data
        loadGradeData();
    }
    
    async function loadGradeData() {
        try {
            // Check if grade config exists
            const configResponse = await fetch(`/grades/lessons/${lessonId}/config`);
            
            if (configResponse.status === 404) {
                // No config - show setup prompt
                showSetupPrompt();
                return;
            }
            
            // Load summary
            const summaryResponse = await fetch(`/grades/lessons/${lessonId}/summary`);
            const summaryData = await summaryResponse.json();
            
            console.log('üìä Summary data:', summaryData);
            
            if (summaryData.success) {
                currentSummary = summaryData.data;
                console.log('üìà Category breakdown:', summaryData.data.category_breakdown);
                renderGradeSummary(summaryData.data);
                renderGoals(summaryData.data.goals);
                renderCategoryBreakdown(summaryData.data.category_breakdown);
            } else {
                console.error('‚ùå Failed to load summary:', summaryData);
            }
            
            // Load grades table
            console.log('üìã Loading grades table...');
            const gradesResponse = await fetch(`/grades/lessons/${lessonId}/my-grades`);
            const gradesData = await gradesResponse.json();
            
            console.log('üìä Grades response:', gradesData);
            
            if (gradesData.success) {
                console.log('üìù Rendering grades table with', gradesData.data.length, 'items');
                renderGradesTable(gradesData.data);
            } else {
                console.error('‚ùå Failed to load grades:', gradesData);
                // Show error message in table
                const tbody = document.getElementById('grades-table-body');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-danger py-4">
                            Error loading grades: ${gradesData.error || 'Unknown error'}
                        </td>
                    </tr>
                `;
            }
            
            // Load categories for filter
            const categoriesResponse = await fetch(`/grades/lessons/${lessonId}/categories`);
            const categoriesResult = await categoriesResponse.json();
            
            if (categoriesResult.success) {
                categoriesData = categoriesResult.data;
                populateCategoryFilter(categoriesResult.data);
            }
            
            // Load available tasks for linking
            const tasksResponse = await fetch(`/grades/lessons/${lessonId}/available-tasks`);
            const tasksData = await tasksResponse.json();
            
            if (tasksData.success) {
                availableTasks = tasksData.data;
                console.log('üìã Available tasks for linking:', availableTasks.length);
            }
            
        } catch (error) {
            console.error('Error loading grades:', error);
            showError('Failed to load grades');
        }
    }
    
    // Open Create Grade Item Modal
    async function openCreateGradeItemModal() {
        if (!createGradeItemModal) {
            showError('Modal not initialized');
            return;
        }
        
        // Reset form
        document.getElementById('gradeItemForm').reset();
        document.getElementById('item-linked-task-id').value = '';
        document.getElementById('task-link-hint').innerHTML = 'üí° Type to create new, or select from existing tasks below';
        
        // Populate category dropdown
        const categorySelect = document.getElementById('item-category');
        categorySelect.innerHTML = '<option value="">-- Select Category --</option>';
        
        for (const category of categoriesData) {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = `${category.name} (${category.weight}%)`;
            categorySelect.appendChild(option);
        }
        
        // Populate task dropdown (will be done when dropdown opens)
        filterTaskDropdown();
        
        createGradeItemModal.show();
    }
    
    // Show/Hide task dropdown
    function showTaskDropdown() {
        const dropdown = document.getElementById('task-dropdown');
        dropdown.style.display = 'block';
        filterTaskDropdown(); // Filter based on current input
    }
    
    function hideTaskDropdown() {
        setTimeout(() => {
            const dropdown = document.getElementById('task-dropdown');
            dropdown.style.display = 'none';
        }, 200);
    }
    
    function toggleTaskDropdown() {
        const dropdown = document.getElementById('task-dropdown');
        if (dropdown.style.display === 'none') {
            showTaskDropdown();
        } else {
            dropdown.style.display = 'none';
        }
    }
    
    function focusNameInput() {
        document.getElementById('item-name').focus();
    }
    
    // Filter task dropdown based on search
    function filterTaskDropdown() {
        const searchInput = document.getElementById('task-search');
        const nameInput = document.getElementById('item-name');
        const searchTerm = (searchInput?.value || nameInput.value || '').toLowerCase();
        
        const taskList = document.getElementById('task-list');
        const filteredTasks = availableTasks.filter(task => 
            task.title.toLowerCase().includes(searchTerm) ||
            (task.description && task.description.toLowerCase().includes(searchTerm))
        );
        
        if (filteredTasks.length === 0) {
            taskList.innerHTML = `
                <div class="dropdown-item empty">
                    <i class="bi bi-inbox"></i>
                    <span>No tasks found</span>
                </div>
            `;
        } else {
            taskList.innerHTML = filteredTasks.map(task => {
                const statusIcon = task.status === 'completed' ? '‚úÖ' :
                                 task.status === 'in-progress' ? 'üîÑ' : 'üìã';
                const statusClass = task.status === 'completed' ? 'completed' :
                                  task.status === 'in-progress' ? 'in-progress' : 'pending';
                
                return `
                    <div class="dropdown-item task-item ${statusClass}" 
                         onclick="selectTask('${escapeHtml(task.id)}', '${escapeHtml(task.title)}')">
                        <div class="task-icon">${statusIcon}</div>
                        <div class="task-info">
                            <div class="task-title">${escapeHtml(task.title)}</div>
                            ${task.description ? `<div class="task-desc">${escapeHtml(task.description.substring(0, 50))}${task.description.length > 50 ? '...' : ''}</div>` : ''}
                        </div>
                        ${task.due_date ? `<div class="task-due"><i class="bi bi-calendar"></i> ${formatDate(task.due_date)}</div>` : ''}
                    </div>
                `;
            }).join('');
        }
    }
    
    // Select a task from dropdown
    function selectTask(taskId, taskTitle) {
        const task = availableTasks.find(t => t.id === taskId);
        if (!task) return;
        
        const nameInput = document.getElementById('item-name');
        const taskIdInput = document.getElementById('item-linked-task-id');
        const hint = document.getElementById('task-link-hint');
        const descInput = document.getElementById('item-description');
        const dueDateInput = document.getElementById('item-due-date');
        
        // Set values
        nameInput.value = task.title;
        taskIdInput.value = task.id;
        
        // Update hint
        hint.innerHTML = `
            <i class="bi bi-check-circle-fill"></i>
            <span><strong>Linked to task:</strong> ${escapeHtml(task.title)}</span>
        `;
        hint.className = 'task-link-status linked';
        
        // Auto-fill description and due date
        if (task.description && !descInput.value) {
            descInput.value = task.description;
        }
        if (task.due_date && !dueDateInput.value) {
            const dueDate = new Date(task.due_date);
            dueDateInput.value = dueDate.toISOString().split('T')[0];
        }
        
        // Hide dropdown
        document.getElementById('task-dropdown').style.display = 'none';
        
        console.log('üîó Task selected:', task.title);
    }
    
    // Handle assignment name input
    function handleAssignmentNameInput() {
        const nameInput = document.getElementById('item-name');
        const taskIdInput = document.getElementById('item-linked-task-id');
        const hint = document.getElementById('task-link-hint');
        
        const inputValue = nameInput.value.trim();
        
        // Filter dropdown
        filterTaskDropdown();
        
        // Check if input matches a task exactly
        const matchedTask = availableTasks.find(task => task.title === inputValue);
        
        if (matchedTask && taskIdInput.value === matchedTask.id) {
            // Already linked - keep hint
            return;
        } else if (matchedTask) {
            // Matches a task but not linked yet - suggest linking
            hint.innerHTML = `
                <i class="bi bi-link-45deg"></i>
                <span>Press Enter or click to link to existing task</span>
            `;
            hint.className = 'task-link-status suggestion';
        } else if (inputValue) {
            // Custom name - creating new
            taskIdInput.value = '';
            hint.innerHTML = `
                <i class="bi bi-pencil-fill"></i>
                <span><strong>Creating new assignment:</strong> ${escapeHtml(inputValue)}</span>
            `;
            hint.className = 'task-link-status new';
        } else {
            // Empty input
            taskIdInput.value = '';
            hint.innerHTML = `
                <i class="bi bi-info-circle"></i>
                <span>Type to create new, or select from existing tasks</span>
            `;
            hint.className = 'task-link-status';
        }
    }
    
    // Format date helper
    function formatDate(dateString) {
        const date = new Date(dateString);
        const today = new Date();
        const diffTime = date - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays < 0) return 'Overdue';
        if (diffDays === 0) return 'Today';
        if (diffDays === 1) return 'Tomorrow';
        if (diffDays <= 7) return `${diffDays}d`;
        
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }
    
    // Save Grade Item
    async function saveGradeItem() {
        try {
            const name = document.getElementById('item-name').value.trim();
            const points = parseFloat(document.getElementById('item-points').value);
            const categoryId = document.getElementById('item-category').value;
            const linkedTaskId = document.getElementById('item-linked-task-id').value; // From hidden input
            const description = document.getElementById('item-description').value.trim();
            const dueDate = document.getElementById('item-due-date').value;
            const isPublished = document.getElementById('item-published').checked;
            
            if (!name || !points || !categoryId) {
                showError('Please fill in all required fields');
                return;
            }
            
            const itemData = {
                name: name,
                category_id: categoryId,
                points_possible: points,
                description: description,
                due_date: dueDate || null,
                is_published: isPublished
            };
            
            // Add linked task if auto-detected
            if (linkedTaskId) {
                itemData.classwork_task_id = linkedTaskId;
                console.log('üîó Linking to task:', linkedTaskId);
            } else {
                console.log('‚úèÔ∏è Creating new assignment without task link');
            }
            
            const response = await fetch(`/grades/lessons/${lessonId}/items`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(itemData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                createGradeItemModal.hide();
                showSuccess('Assignment created successfully!');
                
                // Reload available tasks (to remove linked task from list)
                try {
                    const tasksResponse = await fetch(`/grades/lessons/${lessonId}/available-tasks`);
                    const tasksData = await tasksResponse.json();
                    if (tasksData.success) {
                        availableTasks = tasksData.data;
                        console.log('üîÑ Available tasks updated:', availableTasks.length);
                    }
                } catch (e) {
                    console.warn('Could not reload available tasks:', e);
                }
                
                // Reload grades data
                setTimeout(() => loadGradeData(), 500);
            } else {
                showError(result.error || 'Failed to create assignment');
            }
            
        } catch (error) {
            console.error('Error saving grade item:', error);
            showError('Failed to create assignment');
        }
    }
    
    function showSetupPrompt() {
        const container = document.getElementById('grade-summary');
        container.innerHTML = `
            <div class="setup-prompt">
                <i class="bi bi-gear" style="font-size: 3rem; opacity: 0.5;"></i>
                <h3>Grade System Not Configured</h3>
                <p>Set up your grading scale and categories to start tracking grades</p>
                <button class="btn btn-primary btn-lg" onclick="openSetupModal()">
                    <i class="bi bi-gear"></i> Setup Grading System
                </button>
            </div>
        `;
        
        // Hide other sections
        document.getElementById('grade-goals').style.display = 'none';
        document.getElementById('category-breakdown').style.display = 'none';
        document.querySelector('.grades-table-section').style.display = 'none';
    }
    
    function renderGradeSummary(summary) {
        const gradeColors = {
            'A': '#10b981',
            'B+': '#3b82f6',
            'B': '#3b82f6',
            'C+': '#f59e0b',
            'C': '#f59e0b',
            'D+': '#f97316',
            'D': '#f97316',
            'F': '#ef4444'
        };
        
        const bgColor = gradeColors[summary.letter_grade] || '#667eea';
        
        const html = `
            <div class="grade-display" style="background: linear-gradient(135deg, ${bgColor} 0%, ${bgColor}dd 100%);">
                <div class="current-grade">
                    <div class="grade-letter">${summary.letter_grade}</div>
                    <div class="grade-gpa">GPA: ${summary.gpa.toFixed(2)}</div>
                </div>
                <div class="grade-details">
                    <div class="grade-percentage">
                        <span class="percentage-value">${summary.percentage}%</span>
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill" style="width: ${summary.percentage}%"></div>
                        </div>
                    </div>
                    <div class="grade-points">
                        <i class="bi bi-trophy"></i>
                        <span id="current-points">${summary.percentage}</span> / 100 points
                    </div>
                    <div class="grade-status ${summary.is_passing ? 'passing' : 'failing'}">
                        <i class="bi ${summary.is_passing ? 'bi-check-circle' : 'bi-exclamation-triangle'}"></i>
                        <span>${summary.is_passing ? 'Passing' : 'Needs Improvement'}</span>
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('grade-summary').innerHTML = html;
    }
    
    function renderGoals(goalsData) {
        const goals = goalsData.goals;
        const container = document.getElementById('grade-goals');
        
        let html = '';
        
        // Sort grades by target (highest first)
        const gradeOrder = ['A', 'B+', 'B', 'C+', 'C', 'D+', 'D', 'F'];
        const sortedGrades = Object.keys(goals).sort((a, b) => 
            gradeOrder.indexOf(a) - gradeOrder.indexOf(b)
        );
        
        for (const gradeLetter of sortedGrades) {
            const goal = goals[gradeLetter];
            let className = '';
            let icon = '';
            let message = '';
            
            if (goal.already_achieved) {
                className = 'achieved';
                icon = 'bi-check-circle-fill';
                message = goal.message;
            } else if (goal.achievable) {
                className = 'achievable';
                icon = 'bi-arrow-up-circle';
                message = goal.message;
            } else {
                className = 'not-achievable';
                icon = 'bi-x-circle';
                message = goal.message;
            }
            
            html += `
                <div class="goal-card ${className}">
                    <div class="goal-icon">
                        <i class="bi ${icon}"></i>
                    </div>
                    <div class="goal-content">
                        <div class="goal-grade">${gradeLetter}</div>
                        <div class="goal-message">${message}</div>
                    </div>
                </div>
            `;
        }
        
        container.innerHTML = html;
    }
    
    function renderCategoryBreakdown(breakdown) {
        const container = document.getElementById('category-breakdown');
        
        if (!breakdown || Object.keys(breakdown).length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="bi bi-inbox" style="font-size: 2rem; opacity: 0.5;"></i>
                    <p class="mb-0">No categories configured yet</p>
                    <button class="btn btn-sm btn-primary mt-2" onclick="openSetupModal()">
                        <i class="bi bi-gear"></i> Setup Grading
                    </button>
                </div>
            `;
            return;
        }
        
        let html = '';
        
        for (const categoryId in breakdown) {
            const category = breakdown[categoryId];
            
            // Determine if category has any data
            const hasData = category.total_items > 0;
            const hasGrades = category.graded_items > 0;
            
            html += `
                <div class="category-card">
                    <div class="category-header">
                        <div class="category-info">
                            <h4 class="category-name">
                                <span style="color: ${category.color}">‚óè</span>
                                ${category.name}
                            </h4>
                            <span class="category-weight">${category.weight}%</span>
                        </div>
                    </div>
                    <div class="category-body">
                        <div class="category-score">
                            <div class="score-display">
                                <span class="score-percentage">${category.percentage}%</span>
                                <span class="score-points">${category.earned} / ${category.possible} pts</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" style="width: ${category.percentage}%; background: ${category.color}"></div>
                            </div>
                        </div>
                        
                        <!-- Item counts -->
                        <div class="category-stats mt-2">
                            <div class="stat-item">
                                <i class="bi bi-file-earmark-text"></i>
                                <span>${category.total_items} assignment${category.total_items !== 1 ? 's' : ''}</span>
                            </div>
                            ${hasGrades ? `
                            <div class="stat-item">
                                <i class="bi bi-check-circle text-success"></i>
                                <span>${category.graded_items} graded</span>
                            </div>
                            ` : ''}
                            ${category.pending_items > 0 ? `
                            <div class="stat-item">
                                <i class="bi bi-clock text-warning"></i>
                                <span>${category.pending_items} pending</span>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="category-contribution">
                            Contributes: <strong>${category.weighted_score}%</strong> to final grade
                        </div>
                        
                        ${!hasData ? `
                        <div class="alert alert-info mt-2 mb-0 py-2 small">
                            <i class="bi bi-info-circle"></i>
                            No assignments added yet
                        </div>
                        ` : !hasGrades ? `
                        <div class="alert alert-warning mt-2 mb-0 py-2 small">
                            <i class="bi bi-exclamation-triangle"></i>
                            No grades submitted yet
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        container.innerHTML = html;
    }
    
    function renderGradesTable(grades) {
        console.log('üé® renderGradesTable called with:', grades);
        
        const tbody = document.getElementById('grades-table-body');
        
        if (!tbody) {
            console.error('‚ùå grades-table-body element not found!');
            return;
        }
        
        if (!grades || grades.length === 0) {
            console.log('üì≠ No grades to display');
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted py-4">
                        <i class="bi bi-inbox" style="font-size: 2rem; opacity: 0.3;"></i>
                        <p class="mb-2">No assignments added yet</p>
                        <button class="btn btn-sm btn-primary" onclick="openCreateGradeItemModal()">
                            <i class="bi bi-plus-circle"></i> Add First Assignment
                        </button>
                    </td>
                </tr>
            `;
            return;
        }
        
        console.log(`üìù Rendering ${grades.length} grade items...`);
        let html = '';
        
        for (const grade of grades) {
            const statusClass = grade.status === 'graded' ? 'graded' : 
                              grade.status === 'pending' ? 'pending' : 'missing';
            
            const statusText = grade.status === 'graded' ? 'Graded' :
                             grade.status === 'pending' ? 'Pending' : 'Missing';
            
            // Format score and percentage display
            let scoreDisplay, percentDisplay;
            
            if (grade.status === 'graded' && grade.score !== null) {
                scoreDisplay = `${grade.score} / ${grade.points_possible}`;
                percentDisplay = `<strong>${grade.percentage}%</strong>`;
            } else {
                // Pending - show empty score but total points
                scoreDisplay = `-- / ${grade.points_possible}`;
                percentDisplay = '--';
            }
            
            html += `
                <tr class="grade-row" data-category="${grade.category_name}">
                    <td>
                        <div class="assignment-cell">
                            <span class="assignment-name">${escapeHtml(grade.item_name)}</span>
                            ${grade.linked_task_title ? `
                                <small class="text-muted ms-2">
                                    <i class="bi bi-link-45deg"></i>
                                    ${escapeHtml(grade.linked_task_title)}
                                </small>
                            ` : ''}
                            ${grade.is_late ? '<span class="badge bg-warning ms-2">Late</span>' : ''}
                        </div>
                    </td>
                    <td>
                        <span class="badge" style="background: ${grade.category_color}">${grade.category_name}</span>
                    </td>
                    <td>${formatDate(grade.due_date)}</td>
                    <td>${scoreDisplay}</td>
                    <td>${percentDisplay}</td>
                    <td>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </td>
                </tr>
            `;
        }
        
        console.log('‚úÖ Setting table HTML...');
        tbody.innerHTML = html;
        console.log('‚úÖ Grades table rendered successfully');
    }
    
    function populateCategoryFilter(categories) {
        const select = document.getElementById('category-filter');
        
        for (const category of categories) {
            const option = document.createElement('option');
            option.value = category.name;
            option.textContent = category.name;
            select.appendChild(option);
        }
    }
    
    // Modal functions
    function openGoalCalculator() {
        if (goalCalculatorModal) {
            goalCalculatorModal.show();
        }
    }
    
    async function openSetupModal() {
        if (setupGradingModal) {
            // Check if config exists
            try {
                const configResponse = await fetch(`/grades/lessons/${lessonId}/config`);
                
                if (configResponse.ok) {
                    // Config exists - Load for editing
                    const configData = await configResponse.json();
                    if (configData.success) {
                        isEditMode = true;
                        currentGradingScale = configData.data.grading_scale;
                        await loadExistingConfig(configData.data);
                    }
                } else {
                    // No config - Create mode
                    isEditMode = false;
                    currentGradingScale = getDefaultGradingScale();
                    initializeSetupForm();
                }
                
                setupGradingModal.show();
                
            } catch (error) {
                console.error('Error opening setup modal:', error);
                isEditMode = false;
                currentGradingScale = getDefaultGradingScale();
                initializeSetupForm();
                setupGradingModal.show();
            }
        }
    }
    
    function getDefaultGradingScale() {
        return {
            "A": {"min": 80, "max": 100, "gpa": 4.0},
            "B+": {"min": 75, "max": 79, "gpa": 3.5},
            "B": {"min": 70, "max": 74, "gpa": 3.0},
            "C+": {"min": 65, "max": 69, "gpa": 2.5},
            "C": {"min": 60, "max": 64, "gpa": 2.0},
            "D+": {"min": 55, "max": 59, "gpa": 1.5},
            "D": {"min": 50, "max": 54, "gpa": 1.0},
            "F": {"min": 0, "max": 49, "gpa": 0.0}
        };
    }
    
    async function loadExistingConfig(config) {
        // Update modal title
        document.getElementById('setupModalTitle').textContent = '‚öôÔ∏è Edit Grading System';
        document.getElementById('saveSetupBtnText').textContent = 'Update Configuration';
        document.getElementById('clearConfigBtn').style.display = 'inline-block';
        
        // Load grading scale
        currentGradingScale = config.grading_scale;
        updateGradingScalePreview(currentGradingScale);
        
        // Load categories
        try {
            const categoriesResponse = await fetch(`/grades/lessons/${lessonId}/categories`);
            const categoriesData = await categoriesResponse.json();
            
            if (categoriesData.success) {
                document.getElementById('categories-list').innerHTML = '';
                
                for (const category of categoriesData.data) {
                    addCategoryRow(category);
                }
                
                updateTotalWeight();
            }
        } catch (error) {
            console.error('Error loading categories:', error);
        }
    }
    
    function initializeSetupForm() {
        // Update modal title
        document.getElementById('setupModalTitle').textContent = '‚öôÔ∏è Setup Grading System';
        document.getElementById('saveSetupBtnText').textContent = 'Save Configuration';
        document.getElementById('clearConfigBtn').style.display = 'none';
        
        // Initialize grading scale preview
        updateGradingScalePreview(currentGradingScale);
        
        // Initialize with one empty category row
        document.getElementById('categories-list').innerHTML = '';
        addCategoryRow();
    }
    
    function updateGradingScalePreview(scale) {
        const container = document.getElementById('grading-scale-preview');
        let html = '';
        
        const gradeColors = {
            'A': 'bg-success',
            'B+': 'bg-primary',
            'B': 'bg-info',
            'C+': 'bg-warning',
            'C': 'bg-secondary',
            'D+': 'bg-secondary',
            'D': 'bg-secondary',
            'F': 'bg-danger'
        };
        
        for (const [grade, data] of Object.entries(scale)) {
            const color = gradeColors[grade] || 'bg-secondary';
            html += `<span class="badge ${color}">${grade} (${data.min}-${data.max}%)</span> `;
        }
        
        container.innerHTML = html;
    }
    
    function toggleGradingScaleEdit() {
        const display = document.getElementById('grading-scale-display');
        const editor = document.getElementById('grading-scale-editor');
        
        if (editor.style.display === 'none') {
            // Show editor
            display.style.display = 'none';
            editor.style.display = 'block';
            populateGradingScaleTable();
            document.getElementById('edit-scale-icon').className = 'bi bi-x';
            document.getElementById('edit-scale-text').textContent = 'Cancel';
        } else {
            // Hide editor
            display.style.display = 'block';
            editor.style.display = 'none';
            document.getElementById('edit-scale-icon').className = 'bi bi-pencil';
            document.getElementById('edit-scale-text').textContent = 'Edit Scale';
        }
    }
    
    function populateGradingScaleTable() {
        const tbody = document.getElementById('grading-scale-table');
        tbody.innerHTML = '';
        
        const gradeOrder = ['A', 'B+', 'B', 'C+', 'C', 'D+', 'D', 'F'];
        
        for (const grade of gradeOrder) {
            if (currentGradingScale[grade]) {
                const data = currentGradingScale[grade];
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${grade}</strong></td>
                    <td><input type="number" class="form-control form-control-sm" 
                               value="${data.min}" min="0" max="100" 
                               data-grade="${grade}" data-field="min"></td>
                    <td><input type="number" class="form-control form-control-sm" 
                               value="${data.max}" min="0" max="100" 
                               data-grade="${grade}" data-field="max"></td>
                    <td><input type="number" class="form-control form-control-sm" 
                               value="${data.gpa}" min="0" max="4" step="0.5" 
                               data-grade="${grade}" data-field="gpa"></td>
                `;
                tbody.appendChild(row);
            }
        }
    }
    
    function saveGradingScale() {
        const rows = document.querySelectorAll('#grading-scale-table tr');
        const newScale = {};
        
        rows.forEach(row => {
            const grade = row.querySelector('[data-field="min"]').dataset.grade;
            const min = parseFloat(row.querySelector('[data-field="min"]').value);
            const max = parseFloat(row.querySelector('[data-field="max"]').value);
            const gpa = parseFloat(row.querySelector('[data-field="gpa"]').value);
            
            newScale[grade] = {min, max, gpa};
        });
        
        currentGradingScale = newScale;
        updateGradingScalePreview(newScale);
        toggleGradingScaleEdit();
        
        showSuccess('Grading scale updated');
    }
    
    function cancelGradingScaleEdit() {
        toggleGradingScaleEdit();
    }
    
    function resetGradingScale() {
        if (confirm('Reset to default Thai university grading scale?')) {
            currentGradingScale = getDefaultGradingScale();
            populateGradingScaleTable();
            showSuccess('Reset to default scale');
        }
    }
    
    let categoryRowIndex = 0;
    
    function addCategoryRow(categoryData = null) {
        const container = document.getElementById('categories-list');
        const rowId = `category-row-${categoryRowIndex++}`;
        
        const row = document.createElement('div');
        row.className = 'category-row mb-3';
        row.id = rowId;
        
        if (categoryData) {
            row.dataset.categoryId = categoryData.id;
        }
        
        row.innerHTML = `
            <div class="row g-2">
                <div class="col-md-4">
                    <input type="text" class="form-control" placeholder="Category name (e.g., Assignments)" 
                           data-field="name" value="${categoryData ? categoryData.name : ''}">
                </div>
                <div class="col-md-3">
                    <input type="number" class="form-control" placeholder="Weight %" min="0" max="100" 
                           data-field="weight" value="${categoryData ? categoryData.weight : ''}" 
                           oninput="updateTotalWeight()">
                </div>
                <div class="col-md-3">
                    <input type="color" class="form-control form-control-color" 
                           value="${categoryData ? categoryData.color : '#3B82F6'}" 
                           data-field="color">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-danger w-100" onclick="removeCategoryRow('${rowId}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        `;
        
        container.appendChild(row);
        updateTotalWeight();
    }
    
    function removeCategoryRow(rowId) {
        document.getElementById(rowId).remove();
        updateTotalWeight();
    }
    
    function updateTotalWeight() {
        const rows = document.querySelectorAll('.category-row');
        let total = 0;
        
        rows.forEach(row => {
            const weightInput = row.querySelector('[data-field="weight"]');
            const weight = parseFloat(weightInput.value) || 0;
            total += weight;
        });
        
        document.getElementById('total-weight').textContent = total.toFixed(0);
        document.getElementById('weight-progress').style.width = total + '%';
        
        // Change color based on total
        const progressBar = document.getElementById('weight-progress');
        if (total === 100) {
            progressBar.className = 'progress-bar bg-success';
        } else if (total > 100) {
            progressBar.className = 'progress-bar bg-danger';
        } else {
            progressBar.className = 'progress-bar bg-warning';
        }
    }
    
    async function saveGradingSetup() {
        try {
            // Validate total weight
            const totalWeight = parseFloat(document.getElementById('total-weight').textContent);
            if (totalWeight !== 100) {
                alert('Total weight must equal 100%');
                return;
            }
            
            // Use current grading scale
            const gradingScale = currentGradingScale;
            
            // Save/Update config
            const method = isEditMode ? 'PUT' : 'POST';
            const configResponse = await fetch(`/grades/lessons/${lessonId}/config`, {
                method: method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    grading_scale: gradingScale,
                    grading_type: 'percentage',
                    total_points: 100,
                    passing_grade: 'D',
                    passing_percentage: 50.0
                })
            });
            
            if (!configResponse.ok && !isEditMode) {
                throw new Error('Failed to save configuration');
            }
            
            // Delete old categories if in edit mode
            if (isEditMode) {
                const existingCategoriesResponse = await fetch(`/grades/lessons/${lessonId}/categories`);
                const existingCategoriesData = await existingCategoriesResponse.json();
                
                if (existingCategoriesData.success) {
                    for (const cat of existingCategoriesData.data) {
                        await fetch(`/grades/categories/${cat.id}`, {
                            method: 'DELETE'
                        });
                    }
                }
            }
            
            // Save new categories
            const rows = document.querySelectorAll('.category-row');
            let categoryIndex = 0;
            
            for (const row of rows) {
                const name = row.querySelector('[data-field="name"]').value.trim();
                const weight = parseFloat(row.querySelector('[data-field="weight"]').value);
                const color = row.querySelector('[data-field="color"]').value;
                
                if (!name || !weight) continue;
                
                await fetch(`/grades/lessons/${lessonId}/categories`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        name: name,
                        weight: weight,
                        color: color,
                        order_index: categoryIndex++
                    })
                });
            }
            
            // Close modal and reload
            setupGradingModal.hide();
            showSuccess(isEditMode ? 'Grading system updated successfully!' : 'Grading system configured successfully!');
            setTimeout(() => {
                isEditMode = false;
                loadGradeData();
            }, 500);
            
        } catch (error) {
            console.error('Error saving setup:', error);
            showError('Failed to save grading configuration');
        }
    }
    
    async function clearGradingConfig() {
        if (!confirm('Are you sure you want to clear all grading configuration? This will delete all grades and cannot be undone!')) {
            return;
        }
        
        try {
            // Delete config
            const response = await fetch(`/grades/lessons/${lessonId}/config`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                setupGradingModal.hide();
                showSuccess('Grading configuration cleared');
                setTimeout(() => {
                    isEditMode = false;
                    loadGradeData();
                }, 500);
            } else {
                throw new Error('Failed to delete configuration');
            }
        } catch (error) {
            console.error('Error clearing config:', error);
            showError('Failed to clear configuration');
        }
    }
    
    async function calculateGoal() {
        const targetGrade = document.getElementById('target-grade').value;
        
        if (!targetGrade) {
            document.getElementById('calculator-result').innerHTML = '';
            return;
        }
        
        try {
            const response = await fetch(`/grades/lessons/${lessonId}/goal-calculator`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({target_grade: targetGrade})
            });
            
            const data = await response.json();
            
            if (data.success) {
                const result = data.data;
                const goal = result.goal_info;
                
                let resultHtml = '';
                
                if (goal.already_achieved) {
                    resultHtml = `
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle-fill fs-3"></i>
                            <h5 class="mt-3">Great News!</h5>
                            <p class="mb-0">${goal.message}</p>
                        </div>
                    `;
                } else if (goal.achievable) {
                    resultHtml = `
                        <div class="alert alert-info">
                            <i class="bi bi-calculator fs-3"></i>
                            <h5 class="mt-3">You Can Do It!</h5>
                            <p>${goal.message}</p>
                            <hr>
                            <div class="goal-details">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <div class="goal-stat">
                                            <div class="stat-value">${goal.points_needed}</div>
                                            <div class="stat-label">Points Needed</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="goal-stat">
                                            <div class="stat-value">${goal.percentage_needed}%</div>
                                            <div class="stat-label">On Remaining Work</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    resultHtml = `
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle fs-3"></i>
                            <h5 class="mt-3">Not Achievable</h5>
                            <p class="mb-0">${goal.message}</p>
                        </div>
                    `;
                }
                
                document.getElementById('calculator-result').innerHTML = resultHtml;
            }
            
        } catch (error) {
            console.error('Error calculating goal:', error);
            showError('Failed to calculate goal');
        }
    }
    
    function filterGrades() {
        const categoryFilter = document.getElementById('category-filter').value;
        const rows = document.querySelectorAll('.grade-row');
        
        rows.forEach(row => {
            if (categoryFilter === 'all' || row.dataset.category === categoryFilter) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
    
    function searchGrades() {
        const searchTerm = document.getElementById('search-grades').value.toLowerCase();
        const rows = document.querySelectorAll('.grade-row');
        
        rows.forEach(row => {
            const assignmentName = row.querySelector('.assignment-name').textContent.toLowerCase();
            
            if (assignmentName.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
    
    function formatDate(dateString) {
        if (!dateString) return '--';
        
        const date = new Date(dateString);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const taskDate = new Date(date);
        taskDate.setHours(0, 0, 0, 0);
        
        const diffDays = Math.ceil((taskDate - today) / (1000 * 60 * 60 * 24));
        
        if (diffDays === 0) return 'Today';
        if (diffDays === 1) return 'Tomorrow';
        if (diffDays === -1) return 'Yesterday';
        
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }
    
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function showSuccess(message) {
        if (typeof window.showSuccess === 'function') {
            window.showSuccess(message);
        } else {
            alert(message);
        }
    }
    
    function showError(message) {
        if (typeof window.showError === 'function') {
            window.showError(message);
        } else {
            alert(message);
        }
    }
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('task-dropdown');
        const combobox = event.target.closest('.custom-combobox');
        
        if (dropdown && !combobox) {
            dropdown.style.display = 'none';
        }
    });
    
    // Expose functions globally
    window.openGoalCalculator = openGoalCalculator;
    window.openSetupModal = openSetupModal;
    window.openCreateGradeItemModal = openCreateGradeItemModal;
    window.saveGradeItem = saveGradeItem;
    window.handleAssignmentNameInput = handleAssignmentNameInput;
    window.selectTask = selectTask;
    window.showTaskDropdown = showTaskDropdown;
    window.toggleTaskDropdown = toggleTaskDropdown;
    window.focusNameInput = focusNameInput;
    window.filterTaskDropdown = filterTaskDropdown;
    window.calculateGoal = calculateGoal;
    window.addCategoryRow = addCategoryRow;
    window.removeCategoryRow = removeCategoryRow;
    window.updateTotalWeight = updateTotalWeight;
    window.saveGradingSetup = saveGradingSetup;
    window.clearGradingConfig = clearGradingConfig;
    window.toggleGradingScaleEdit = toggleGradingScaleEdit;
    window.saveGradingScale = saveGradingScale;
    window.cancelGradingScaleEdit = cancelGradingScaleEdit;
    window.resetGradingScale = resetGradingScale;
    window.filterGrades = filterGrades;
    window.searchGrades = searchGrades;
    
    console.log('‚úÖ Grades system initialized');
    
})();
</script>

