<!-- iPhone-style Notes System -->
<div class="iphone-notes-wrapper">
    {% include 'class_detail/_iphone_notes.html' %}
</div>

<!-- Legacy Stream Tab - Note System Integration -->
<div class="px-4 py-4" style="display: none;">
    
    <!-- Enhanced Create Note Card -->
    <div class="card shadow-sm mb-4" id="create-note-card" style="border-radius: 16px; background: linear-gradient(135deg, #f8f9fa, #e9ecef);">
        <div class="card-body p-4">
            <div class="d-flex align-items-center mb-3">
                <div class="flex-shrink-0">
                    <div class="avatar-circle bg-primary text-white" style="width: 48px; height: 48px; font-size: 1.2rem;">
                        {{ user.username[0].upper() if user and user.username else 'U' }}
                    </div>
                </div>
                <div class="flex-grow-1 ms-3">
                    <input type="text" 
                           class="form-control form-control-lg" 
                           placeholder="Share your thoughts, ideas, or important information..."
                           onclick="openNoteModal()"
                           readonly
                           style="cursor: pointer; border-radius: 24px; border: 2px solid #e9ecef; background: white; transition: all 0.3s ease;"
                           onmouseover="this.style.borderColor='#007bff'; this.style.boxShadow='0 0 0 0.2rem rgba(0,123,255,.25)'"
                           onmouseout="this.style.borderColor='#e9ecef'; this.style.boxShadow='none'">
                </div>
            </div>
            <div class="d-flex gap-2 flex-wrap">
                <button class="btn btn-primary btn-sm" onclick="openNoteModal()" style="border-radius: 20px; padding: 8px 16px;">
                    <i class="bi bi-journal-text me-1"></i>Create Note
                </button>
                <button class="btn btn-success btn-sm" onclick="openAnnouncementModal()" style="border-radius: 20px; padding: 8px 16px;">
                    <i class="bi bi-chat-text me-1"></i>Announcement
                </button>
                <button class="btn btn-info btn-sm" style="border-radius: 20px; padding: 8px 16px;">
                    <i class="bi bi-paperclip me-1"></i>Material
                </button>
                <button class="btn btn-warning btn-sm" style="border-radius: 20px; padding: 8px 16px;">
                    <i class="bi bi-question-circle me-1"></i>Question
                </button>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Class Notes Section -->
    <div class="class-notes-section mb-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h5 class="mb-1" style="color: #2c3e50; font-weight: 600;">
                    <i class="bi bi-journal-text me-2"></i>Class Notes
                </h5>
                <p class="text-muted mb-0" style="font-size: 0.9rem;">Organize and manage your class notes</p>
            </div>
            <div class="d-flex gap-2 flex-wrap">
                <button class="btn btn-sm btn-outline-secondary active" onclick="filterNotes('all')" style="border-radius: 20px;">
                    <i class="bi bi-list-ul me-1"></i>All
                </button>
                <button class="btn btn-sm btn-outline-warning" onclick="filterNotes('pending')" style="border-radius: 20px;">
                    <i class="bi bi-clock me-1"></i>Pending
                </button>
                <button class="btn btn-sm btn-outline-info" onclick="filterNotes('in-progress')" style="border-radius: 20px;">
                    <i class="bi bi-arrow-right-circle me-1"></i>In Progress
                </button>
                <button class="btn btn-sm btn-outline-success" onclick="filterNotes('completed')" style="border-radius: 20px;">
                    <i class="bi bi-check-circle me-1"></i>Completed
                </button>
            </div>
        </div>
        
        <!-- Enhanced Search Bar -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="input-group" style="border-radius: 25px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <span class="input-group-text bg-white border-0" style="border-radius: 25px 0 0 25px;">
                        <i class="bi bi-search text-muted"></i>
                    </span>
                    <input type="text" class="form-control border-0" id="noteSearch" placeholder="Search notes..." 
                           style="border-radius: 0 25px 25px 0; box-shadow: none;" onkeyup="searchNotes(this.value)">
                </div>
            </div>
            <div class="col-md-6">
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary btn-sm" onclick="sortNotes('newest')" style="border-radius: 20px;">
                        <i class="bi bi-sort-down me-1"></i>Newest
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="sortNotes('oldest')" style="border-radius: 20px;">
                        <i class="bi bi-sort-up me-1"></i>Oldest
                    </button>
                    <button class="btn btn-outline-info btn-sm" onclick="sortNotes('title')" style="border-radius: 20px;">
                        <i class="bi bi-sort-alpha-down me-1"></i>A-Z
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Notes Grid (Note-style) -->
        <div class="row g-3" id="class-notes-grid">
            <!-- Notes will be loaded here via AJAX -->
            <div class="col-12 text-center py-4" id="no-notes-message">
                <div class="text-muted">
                    <i class="bi bi-journal-text fs-1 mb-3 d-block"></i>
                    <p>No notes yet. Create your first note!</p>
                    <button class="btn btn-primary" onclick="openNoteModal()">
                        <i class="bi bi-plus-circle me-1"></i>Create Note
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Announcements Section -->
    <div class="announcements-section">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0"><i class="bi bi-chat-text me-2"></i>Announcements</h5>
            <button class="btn btn-sm btn-outline-success" onclick="openAnnouncementModal()">
                <i class="bi bi-plus-circle me-1"></i>Add Announcement
            </button>
        </div>
        
        <!-- Announcements List -->
        <div id="announcements-list">
            <!-- Announcements will be loaded here -->
        </div>
    </div>
</div>

<!-- Create Note Modal -->
<div class="modal fade modal-glass" id="createNoteModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-journal-text me-2"></i>Create Class Note
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="createNoteForm" action="/class/{{ lesson.id }}/notes/create" method="POST" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="p-3 mb-3 bg-light rounded-3 border">
                        <div class="row align-items-start g-3">
                            <div class="col">
                                <label for="noteTitle" class="form-label">Title</label>
                                <input type="text" class="form-control" id="noteTitle" name="title" 
                                       placeholder="Enter note title" maxlength="80" required>
                                <div class="form-text">Keep it short and clear.</div>
                            </div>
                            <div class="col-auto text-center">
                                <div id="noteImagePlaceholder" class="rounded-circle bg-light d-flex align-items-center justify-content-center border" style="width:72px;height:72px;">
                                    <i class="bi bi-camera-fill text-secondary"></i>
                                </div>
                                <img id="noteImagePreview" class="rounded-circle border d-none" style="width:72px;height:72px;object-fit:cover;" alt="Preview">
                                <div class="small text-muted mt-2">Add Photo</div>
                                <button type="button" class="btn btn-sm btn-warning mt-1" onclick="document.getElementById('noteImage').click()">
                                    <i class="bi bi-camera-fill me-1"></i>Choose
                                </button>
                                <input type="file" id="noteImage" name="image" accept="image/*" class="d-none" onchange="previewNoteImage(this)">
                            </div>
                        </div>
                        <div class="mt-3">
                            <label for="noteContent" class="form-label">Content</label>
                            <textarea class="form-control" id="noteContent" name="content" rows="5" 
                                      placeholder="Write your note content here..." maxlength="2000" required></textarea>
                            <div class="form-text">Describe the details. You can add links and files below.</div>
                        </div>
                    </div>
                    
                    <div class="p-3 mb-3 bg-light rounded-3 border">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="noteStatus" class="form-label">Status</label>
                                <select class="form-select" id="noteStatus" name="status" required>
                                    <option value="pending">Pending</option>
                                    <option value="in-progress">In Progress</option>
                                    <option value="completed">Completed</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="noteTags" class="form-label">Tags</label>
                                <input type="text" class="form-control" id="noteTags" name="tags" 
                                       placeholder="Enter tags separated by commas">
                                <div class="form-text">e.g., important, homework, exam</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" onclick="submitNoteForm(event)">
                        <i class="bi bi-plus-circle me-1"></i>Create Note
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Create Announcement Modal -->
<div class="modal fade modal-glass" id="createAnnouncementModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="bi bi-chat-text me-2"></i>Create Announcement
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="createAnnouncementForm" hx-post="/class/{{ lesson.id }}/announcements/create" hx-target="#announcements-list" hx-swap="innerHTML">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="announcementTitle" class="form-label">Title</label>
                        <input type="text" class="form-control" id="announcementTitle" name="title" 
                               placeholder="Enter announcement title" required>
                    </div>
                    <div class="mb-3">
                        <label for="announcementContent" class="form-label">Content</label>
                        <textarea class="form-control" id="announcementContent" name="content" rows="6" 
                                  placeholder="Write your announcement here..." required></textarea>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="allowComments" name="allow_comments" checked>
                                <label class="form-check-label" for="allowComments">
                                    Allow comments
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="pinAnnouncement" name="is_pinned">
                                <label class="form-check-label" for="pinAnnouncement">
                                    Pin to top
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-plus-circle me-1"></i>Create Announcement
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Load class notes on page load
function loadClassNotes() {
    const lessonId = '{{ lesson.id }}';
    console.log('🔧 Loading class notes for lesson:', lessonId);
    
    fetch(`/class/${lessonId}/notes`)
        .then(response => response.text())
        .then(html => {
            console.log('✅ Class notes loaded');
            document.getElementById('class-notes-grid').innerHTML = html;
        })
        .catch(error => {
            console.error('❌ Error loading class notes:', error);
        });
}

// Load announcements
function loadAnnouncements() {
    const lessonId = '{{ lesson.id }}';
    console.log('🔧 Loading announcements for lesson:', lessonId);
    
    fetch(`/class/${lessonId}/announcements`)
        .then(response => response.text())
        .then(html => {
            console.log('✅ Announcements loaded');
            document.getElementById('announcements-list').innerHTML = html;
        })
        .catch(error => {
            console.error('❌ Error loading announcements:', error);
        });
}

// Load data when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadClassNotes();
    loadAnnouncements();
});
</script>
